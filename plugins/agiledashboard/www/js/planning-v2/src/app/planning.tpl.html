<div class="alert alert-error" ng-if="rest_error_occured" translate>A server error has occured. <b>You should refresh this page</b>.</div>
<div class="alert alert-error" ng-if="rest_error_occured" ng-bind-html="rest_error"></div>

<div class="tuleap-modal-loading" ng-if="loading_modal.is_loading"></div>
<div id="planning-view">
    <div id="backlog" ng-class="{ loading_content: backlog_items.loading }">
        <div class="planning-header">
            <h2 translate>To be planned</h2>

            <div ng-if="! use_angular_new_modal && backlog.user_can_move_cards" class="btn-group dropdown">
                 <span class="dropdown-toggle btn btn-primary btn-small" id="dLabel" role="button" data-toggle="dropdown" data-target="#" href="#">
                     <i class="icon-plus"></i> <span translate>Add a new item</span>
                     <b class="caret"></b>
                 </span>
                 <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                     <li ng-repeat="accepted_type in backlog.accepted_types.content">
                        <a
                           class="create-item-link"
                           data-tracker-id="{{ accepted_type.id }}"
                           data-link-id="milestone_id"
                           href="submit_ur"
                           ng-click="showCreateNewModal($event, accepted_type, backlog)"
                        >{{ accepted_type.label }}</a>
                    </li>
                </ul>
            </div>
            <div ng-if="use_angular_new_modal && backlog.accepted_types.content.length > 1  && backlog.user_can_move_cards" class="btn-group dropdown">
                <span class="dropdown-toggle btn btn-small" id="dLabel" role="button" data-toggle="dropdown" data-target="#" href="#">
                    <i class="icon-plus"></i> <span translate>Add an item</span>
                    <b class="caret"></b>
                </span>
                <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                    <li ng-repeat="accepted_type in backlog.accepted_types.content">
                        <a href="#" class="create-item-link" ng-click="showCreateNewModal($event, accepted_type, backlog)" translate>Add a {{ accepted_type.label }}</a>
                    </li>
                </ul>
            </div>
            <button ng-if="use_angular_new_modal && backlog.accepted_types.content.length === 1 && backlog.user_can_move_cards"
                class="btn btn-small"
                ng-click="showCreateNewModal($event, backlog.accepted_types.content[0], backlog)"
            >
                <i class="icon-plus"></i> <span translate>Add a {{ backlog.accepted_types.content[0].label }}</span>
            </button>

            <div class="pull-right">
                <div ng-if="backlog_items.content.length > 0" class="btn-group view-switcher" data-toggle="buttons-radio">
                    <button type="button" class="btn btn-small" ng-class="{active: current_view_class === compact_view_key}" ng-click="switchViewMode(compact_view_key)" title="{{ 'Compact view' | translate }}"><i class="icon-list"></i> <span translate>Compact view</span></button>
                    <button type="button" class="btn btn-small" ng-class="{active: current_view_class === detailed_view_key}" ng-click="switchViewMode(detailed_view_key)" title="{{ 'Detailed view' | translate }}"><i class="icon-th-list"></i> <span translate>Detailed view</span></button>
                </div>

                <div class="input-search" ng-show="backlog_items.content.length > 0">
                    <input
                        type="search"
                        class="search input-medium"
                        placeholder="{{ 'Filter...' | translate }}"
                        ng-model="filter_terms"
                        ng-keyup="filterBacklog()"
                    >
                </div>
            </div>

            <div class="clearfix"></div>
        </div>

        <div class="alert alert-warning" ng-if="displayUserCantPrioritizeForBacklog()" translate>
            You are not allowed to rank on this planning
        </div>

        <div ui-tree="treeOptions"
            infinite-scroll
            scroll-callback="displayBacklogItems()"
            scroll-threshold="100"
        >
            <ul ui-tree-nodes
                ng-model="backlog_items.filtered_content"
                class="backlog-items backlog {{ current_view_class }}"
                data-accept="{{ backlog.accepted_types.toString() }}"
                data-nodrag="{{ ! backlog.user_can_move_cards }}"
            >
                <li ui-tree-node
                    ng-repeat="backlog_item in backlog_items.filtered_content"
                    ng-include="'backlog-item/backlog-item-in-backlog.tpl.html'"
                    data-type="{{ backlog_item.trackerId }}"
                    data-accept="{{ backlog_item.accepted_types.toString() }}"
                    class="backlog-item parent"
                    ng-class="{ updating: backlog_item.updating, undraggable: ! backlog.user_can_move_cards }"
                    collapsed="true"
                    data-nodrag="{{ ! backlog.user_can_move_cards }}"
                >
                </li>
            </ul>
        </div>
        <div ng-if="backlog_items.fully_loaded && backlog_items.content.length > 0" class="fully-loaded" translate>All items have been loaded.</div>
        <div ng-if="backlog_items.loading" class="loading"></div>
    </div>

    <div id="divider"></div>

    <div id="planned">
        <div class="milestones">
            <div class="planning-header">
                <h2 translate>Milestones</h2>

                <button ng-if="use_angular_new_modal && submilestone_type  && backlog.user_can_move_cards"
                    class="btn btn-small"
                    ng-click="showAddSubmilestoneModal($event, submilestone_type)"
                >
                    <i class="icon-plus"></i> <span translate>Add a {{ submilestone_type.label }}</span>
                </button>

                <div ng-if="milestones.length > 0" class="btn-group view-switcher" data-toggle="buttons-radio">
                    <button type="button" class="btn btn-small" ng-class="{active: current_closed_view_class === show_closed_view_key}" ng-click="switchClosedMilestoneItemsViewMode(show_closed_view_key)" title="{{ 'Show closed items' | translate }}"><i class="icon-eye-open"></i> <span translate>Show closed items</span></button>
                    <button type="button" class="btn btn-small" ng-class="{active: current_closed_view_class === hide_closed_view_key}" ng-click="switchClosedMilestoneItemsViewMode(hide_closed_view_key)" title="{{ 'Hide closed items' | translate }}"><i class="icon-eye-close"></i> <span translate>Hide closed items</span></button>
                </div>

                <div class="clearfix"></div>
            </div>
            <div translate class="alert alert-warning" ng-if="displayUserCantPrioritizeForMilestones()">
                You are not allowed to rank on this planning
            </div>
            <fieldset ng-repeat="milestone in milestones track by $index" class="milestone" ng-class="{ collapsed: milestone.collapsed, updating: milestone.updating }">
                <legend ng-click="toggle($event, milestone)">
                    {{ milestone.label }}
                    <div
                        ng-if="use_angular_new_modal && ! milestone.collapsed && milestone.has_user_priority_change_permission"
                        class="btn-group dropdown do-animate"
                    >
                        <span class="dropdown-toggle btn btn-mini" id="dLabel" role="button" data-toggle="dropdown" data-target="#">
                            <i class="icon-plus"></i> <span translate>Add a new item</span>
                            <b class="caret"></b>
                        </span>
                        <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                            <li ng-repeat="accepted_type in milestone.content_accepted_types.content">
                                <a href="#" class="create-item-link" ng-click="showAddItemToSubMilestoneModal(accepted_type, milestone)">{{ accepted_type.label }}</a>
                            </li>
                        </ul>
                    </div>
                    <span class="label status {{ milestone.semantic_status }}">{{ milestone.status_value }}</span>
                    <span class="date" ng-if="milestone.start_date || milestone.end_date">
                        {{ milestone.start_date | amDateFormat:'ll' }} <i class="icon-long-arrow-right"></i>
                        {{ milestone.end_date | amDateFormat:'ll' }}
                    </span>
                    <div style="clear: both"></div>


                </legend>

                <div class="content" ng-if="! milestone.collapsed" ng-class="{ loading_content: milestone.loadingContent }">
                    <div class="info">
                        <span class="capacity" translate>Capacity:</span>
                        <span class="capacity-value" ng-if="milestone.capacity">{{ milestone.capacity }}</span>
                        <span class="capacity-value" ng-if="! milestone.capacity" translate>N/A</span>

                        <span class="initial-effort" translate>Initial effort:</span>
                        <span class="initial-effort-value" ng-if="milestone.initialEffort" ng-class="{ higher: milestone.initialEffort > milestone.capacity }">{{ milestone.initialEffort }}</span><span class="initial-effort-value non-applicable" ng-if="! milestone.initialEffort" translate>N/A</span>

                        <ul>
                            <li>
                                <a href="/plugins/tracker/?aid={{ milestone.id }}" ng-click="showEditSubmilestoneModal($event, milestone)" title="{{ 'Edit' | translate }}">
                                    <i class="icon-edit"></i> <span translate>Edit</span>
                                </a>
                            </li>
                            <li ng-if="! milestone.sub_milestone_type">
                                <a href="{{ generateMilestoneLinkUrl(milestone, 'blcontent') }}" title="{{ 'Content' | translate }}">
                                    <i class="icon-list-ul"></i> <span translate>Content</span>
                                </a>
                            </li>
                            <li ng-if="milestone.resources.milestones.accept.trackers.length > 0">
                                <a href="{{ generateMilestoneLinkUrl(milestone, 'planning-v2') }}" title="{{ 'Planning' | translate }}">
                                    <i class="icon-signin"></i> <span translate>Planning</span>
                                </a>
                            </li>
                            <li ng-if="milestone.resources.burndown">
                                <a href="{{ generateMilestoneLinkUrl(milestone, 'burndown') }}" title="{{ 'Burndown' | translate }}">
                                    <i class="icon-bar-chart"></i> <span translate>Burndown</span>
                                </a>
                            </li>
                            <li ng-if="milestone.resources.cardwall">
                                <a href="{{ generateMilestoneLinkUrl(milestone, 'cardwall') }}" title="{{ 'Cardwall' | translate }}">
                                    <i class="icon-table"></i> <span translate>Cardwall</span>
                                </a>
                            </li>
                        </ul>

                        <div style="clear: both"></div>
                    </div>

                    <div ui-tree="treeOptions">
                        <ul ui-tree-nodes
                            ng-model="milestone.content"
                            class="backlog-items submilestone {{ current_view_class }}"
                            data-accept="{{ milestone.content_accepted_types.toString() }}"
                            data-submilestone-id="{{ milestone.id }}"
                            data-nodrag="{{ ! milestone.has_user_priority_change_permission }}"
                        >
                            <li ui-tree-node
                                ng-repeat="backlog_item in milestone.content"
                                class="backlog-item parent {{ backlog_item.status | lowercase }} {{ backlog_item.color }}"
                                data-accept="{{ backlog_item.accepted_types.toString() }}"
                                data-type="{{ backlog_item.trackerId }}"
                                ng-include="'backlog-item/backlog-item-in-submilestone.tpl.html'"
                                ng-if="canShowBacklogItem(backlog_item)"
                                ng-class="{ updating: backlog_item.updating, undraggable: ! milestone.has_user_priority_change_permission }"
                                collapsed="true"
                                data-nodrag="{{ ! milestone.has_user_priority_change_permission }}"
                            >
                            </li>
                        </ul>
                    </div>
                    <div class="loading" ng-if="milestone.loadingContent"></div>
                </div>
            </fieldset>
        </div>
        <div class="loading" ng-if="loading_milestones"></div>
    </div>

    <div class="clearfix"></div>
</div>
