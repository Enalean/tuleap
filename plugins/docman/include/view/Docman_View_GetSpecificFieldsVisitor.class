<?php
/**
* Copyright (c) Xerox Corporation, CodeX Team, 2001-2005. All rights reserved
* 
* $Id$
*
* Docman_View_GetSpecificFieldsVisitor
*/

require_once(dirname(__FILE__).'/../Docman_ValidateWiki.class');
require_once(dirname(__FILE__).'/../Docman_ValidateLink.class');
require_once(dirname(__FILE__).'/../Docman_ValidateUpload.class');
require_once(dirname(__FILE__).'/../Docman_MetadataHtml.class');

class Docman_MetadataHtmlWiki extends Docman_MetadataHtml {
    var $pagename;

    function Docman_MetadataHtmlWiki($pagename) {
        $this->pagename = $pagename;
    }

    function getLabel() {
        return $GLOBALS['Language']->getText('plugin_docman', 'specificfield_pagename');
    }
    
    function getField() {
        return '<input type="text" name="item[wiki_page]" value="'. htmlentities($this->pagename, ENT_QUOTES) .'" />';
    }

    function &getValidator() {
        return new Docman_ValidateWiki();
    }

}

class Docman_MetadataHtmlLink extends Docman_MetadataHtml {
    var $link_url;

    function Docman_MetadataHtmlLink($link_url) {
        $this->link_url = $link_url;
    }

    function getLabel() {
        return $GLOBALS['Language']->getText('plugin_docman', 'specificfield_url');
    }
    
    function getField() {
        return '<input type="text" name="item[link_url]" value="'. htmlentities($this->link_url, ENT_QUOTES) .'" />';
    }

    function &getValidator() {
        return new Docman_ValidateLink();
    }

}

class Docman_MetadataHtmlFile extends Docman_MetadataHtml {
   
    function Docman_MetadataHtmlFile() {
        
    }

    function getLabel() {
        return $GLOBALS['Language']->getText('plugin_docman', 'specificfield_embeddedcontent');
    }
    
    function getField() {
        $html = '<input type="hidden" name="max_file_size" value="'. $GLOBALS['sys_max_size_upload'] .'" /><input type="file" name="file" />';
        $html .= '<br /><em>'. $GLOBALS['Language']->getText('plugin_docman','max_size_msg',array(formatByteToMb($GLOBALS['sys_max_size_upload']))) .'</em>';

        return $html;
    }

    function &getValidator() {
        return new Docman_ValidateUpload();
    }

}

class Docman_MetadataHtmlEmbeddedFile extends Docman_MetadataHtml {
    var $content;
    function Docman_MetadataHtmlEmbeddedFile($content) {
        $this->content = $content;
    }

    function getLabel() {
        return $GLOBALS['Language']->getText('plugin_docman', 'specificfield_embeddedcontent');
    }
    
    function getField() {
        return '<textarea name="content" cols="50" rows="15">'. $this->content .'</textarea>';
    }

    function &getValidator() {
        return null;
    }

}

class Docman_View_GetSpecificFieldsVisitor {
    
    function visitFolder(&$item, $params = array()) {
        return array();
    }
    function visitWiki(&$item, $params = array()) {
        $pagename = isset($params['force_item']['wiki_page']) ? $params['force_item']['wiki_page'] : $item->getPagename();
        return array(new Docman_MetadataHtmlWiki($pagename));
    }
    
    function visitLink(&$item, $params = array()) {
        $link_url = isset($params['force_item']['link_url']) ? $params['force_item']['link_url'] : $item->getUrl();
        return array(new Docman_MetadataHtmlLink($link_url));
    }
    
    function visitFile(&$item, $params = array()) {
        return array(new Docman_MetadataHtmlFile());
    }
    
    function visitEmbeddedFile(&$item, $params = array()) {
        $content = '';
        $version =& $item->getCurrentVersion();
        if ($version && is_file($version->getPath())) {
            $content = file_get_contents($version->getPath());
        }
        return array(new Docman_MetadataHtmlEmbeddedFile($content));    
    }
}
?>