<?php
/**
 * Copyright (c) STMicroelectronics, 2006. All Rights Reserved.
 *
 * Originally written by Manuel Vacelet, 2006
 *
 * This file is a part of CodeX.
 *
 * CodeX is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * CodeX is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with CodeX; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 *
 * $Id$
 */
require_once('Docman_View_GetActionOnIconVisitor.class');
require_once('Docman_View_GetClassForLinkVisitor.class');

class Docman_View_ItemTreeUlVisitor /* implements Visitor*/ {
    var $html;
    var $stripFirstNode;
    var $firstNodeStripped;
    var $docmanIcons;
    var $showOptions;
    var $defaultUrl;
    var $get_action_on_title;
    var $get_class_for_link;
    
    function Docman_View_ItemTreeUlVisitor($view, $params = null) {
        $this->view                =& $view;
        $this->get_action_on_icon =& new Docman_View_GetActionOnIconVisitor();
        $this->get_class_for_link  =& new Docman_View_GetClassForLinkVisitor();
        $this->html                = '';
        $this->stripFirstNode      = true;
        $this->firstNodeStripped   = false;
        $this->params              = $params;
        if (!isset($this->params['default_url'])) {
            $this->params['default_url'] = null;
        }
    }

    function toHtml() {
        return $this->html;
    }
  
    function _canDisplayItem($item) {
        return true;
    }
    function _canDisplaySubItems($item) {
        return true;
    }
    
    function visitFolder(&$item, $params = array()) {
        $li_displayed = $this->_displayItem($item, $params);

        if($this->_canDisplaySubItems($item)) {
            $items = $item->getAllItems();
            $nb = count($items);
            if ($nb) { 
                $this->html .= '<ul id="subitems_'.$item->getId().'" class="docman_items">'."\n";
                $i = 0;
                foreach($items as $key => $nop) {
                    $items[$key]->accept($this, array('is_last' => (++$i == $nb)));
                }
                
                $this->html .= '</ul>'."\n";
            }
        }
        
        if($li_displayed) {
            $this->html .= '</li>'."\n";
        }
    }
    function visitDocument(&$item, $params = array()) {
        $li_displayed = $this->_displayItem($item, $params);
        if($li_displayed) {
            $this->html .= '</li>'."\n";
        }
    }
    function visitWiki(&$item, $params = array()) {
        return $this->visitDocument($item, $params);
    }
    function visitLink(&$item, $params = array()) {
        return $this->visitDocument($item, $params);
    }
    function visitFile(&$item, $params = array()) {
        return $this->visitDocument($item, $params);
    }
    function visitEmbeddedFile(&$item, $params = array()) {
        return $this->visitDocument($item, $params);
    }

    //{{{
    function _displayItem(&$item, $params) {
        $li_displayed = false;
        if($this->stripFirstNode && !$this->firstNodeStripped) {
            $this->firstNodeStripped=true;
            if (isset($this->params['display_description']) && $this->params['display_description']) {
                $this->html .= '<p>'. $item->getDescription() .'</p>';
            }
        }
        else {
            if($item !== null && $this->_canDisplayItem($item)) {
                $this->html .= '<li id="item_'.$item->getId().'" class="'. Docman_View_Browse::getItemClasses($params) .'">';
                //$show_options = isset($this->params['show_options']) && $this->params['show_options'] == $item->getId();
                $show_options = true;
                $params['expanded'] = true;
                $open = '_open';
                if(!isset($this->params['item_to_move']) && user_get_preference(PLUGIN_DOCMAN_COLLAPSE_FOLDER_PREF.'_'.$item->getGroupId().'_'.$item->getId()) !== false) {
                    $params['expanded'] = false;
                    $open   = '';
                }
                $icon_src = $this->params['docman_icons']->getIconForItem($item, $params);
                $icon = '<img src="'. $icon_src .'" class="docman_item_icon" />';
                
                $this->html .= '<div>';
                $action = isset($this->params['item_to_move']) ? false : $item->accept($this->get_action_on_icon, array('view' => &$this->view));
                if ($action) {
                    $class = $item->accept($this->get_class_for_link, array('view' => &$this->view));
                    if ($class) {
                        $class .= $open;
                    }
                    $this->html .= '<a href="?group_id='. $item->getGroupId() .'&amp;action='. $action .'&amp;id='. $item->getId() .'" class="'. $class .'">';
                }
                $this->html .=  $icon;
                if ($action) {
                    $this->html .= '</a>';
                }
                $this->html .=  '<span class="docman_item_title">';
                if ($action) {
                    $this->html .= '<a href="?group_id='. $item->getGroupId() .'&amp;action=show&amp;id='. $item->getId() .'">';
                }
                $this->html .=  $item->getTitle();
                if ($action) {
                    $this->html .= '</a>';
                }
                $this->html .=  '</span>';
                //Show/hide options {{{
                $user_actions = $item->getActions();
                if ($show_options) {
                    $this->html .= '<span class="docman_item_options">';
                    
                    // Popup menu {{{
                    $this->html .= '<a href="'. $this->params['default_url'] .'&amp;action=details&amp;id='. $item->getId() .'" class="docman_item_option_details">';
                    $this->html .= '<img src="'. $this->params['docman_icons']->getActionIcon('details') .'" class="docman_item_icon" onmouseover="javascript:ishow(\'docman_details_popup_'.$item->getId().'\');"/>';
                    $this->html .= '</a>';

                    $this->html .= '<div id="docman_details_popup_'.$item->getId().'" class="docman_details_popup" ><ul>';
                    $this->html .= '<li class="head"><span class="title">Item Details</span><span class="close"><a href="javascript:ihide(\'coin_'.$item->getId().'\');">x</a></span></li>';

                    foreach($user_actions as $key => $nop) {
                        if ($this->view->isActionAllowed($user_actions[$key]->action, $user_actions[$key]->item)) {
                            $this->html .= $user_actions[$key]->fetchAction($this->params);
                        }
                    }
                    
                    $this->html .= '</ul></div>';
                    // Popup menu }}} 
                    $this->html .= '</span>';
                } else {
                    $this->html .= '<script type="text/javascript">
                    //<!--
                    ';
                    foreach($user_actions as $key => $nop) {
                        if ($this->view->isActionAllowed($user_actions[$key]->action, $user_actions[$key]->item)) {
                            $this->html .= $user_actions[$key]->fetchAsJavascript($this->params);
                        }
                    }
                    $this->html .= '
                    //-->
                    </script>';
                    $this->html .= '<noscript id="docman_item_show_options_'. $item->getId() .'" ><a class="docman_item_show_options" href="'. $this->params['default_url'] .'&amp;show_options=' . $item->getId() .'#item_'. $item->getId() .'" title="'. $GLOBALS['Language']->getText('plugin_docman', 'action_showactions') .'">';
                    $this->html .= '['. $GLOBALS['Language']->getText('plugin_docman', 'action_showactions') .']';
                    $this->html .= '</a></noscript>';
                }
                //}}}
                $this->html .= '</div>';
                if (trim($item->getDescription()) != '') {
                    $this->html .= '<div class="docman_item_description">'. $item->getDescription() .'</div>';
            }
                $li_displayed = true;
            }
        }
        return $li_displayed;
    }
    //}}}
}
?>