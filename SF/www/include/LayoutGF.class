<?php
/**
 * Base layout class.
 *
 * Extends the basic Error class to add HTML functions
 * for displaying all site dependent HTML, while allowing
 * extendibility/overriding by themes via the Theme class.
 *
 * Make sure browser.php is included _before_ you create an instance of this object.
 *
 * Geoffrey Herteg, August 29, 2000
 *
 * @version   $Id: Layout.class,v 1.107 2005/08/18 17:48:02 marcelo Exp $
 */
require_once('Layout.class');
$GLOBALS['Language']->loadlanguageMsg('themes/gforge-compat');
class LayoutGF extends Layout {

	/**
	 * The default main page content
	 */
	var $rootindex = 'index.php';

	/**
	 * The root location for images
	 *
	 * @var		string	$imgroot
	 */
	var $imgroot = '/themes/codextab/images/';
	var $COLOR_CONTENT_BACK= '#f7f7f7';
	var $COLOR_LTBACK1= '#eeeeef';
	var $COLOR_LTBACK2= '#fafafa';
	var $COLOR_SELECTED_TAB= '#e0e0e0';
	var $COLOR_HTMLBOX_TITLE = '#bbbbbb';
	var $COLOR_HTMLBOX_BACK = '#eaecef';
	var $FONT_CONTENT = 'helvetica';
	var $FONT_HTMLBOX_TITLE = 'helvetica';
	var $FONTCOLOR_HTMLBOX_TITLE = '#333333';
	var $FONTCOLOR_CONTENT = '#333333';
	var $FONTSIZE = 'small';
	var $FONTSIZE_SMALLER='x-small';
	var $FONTSIZE_SMALLEST='xx-small';
	var $FONTSIZE_HTMLBOX_TITLE = 'small';
	var $bgpri = array();

	/**
	 * Layout() - Constructor
	 */
	function LayoutGF() {
		GLOBAL $bgpri;
		// Constructor for parent class...
		//# if ( file_exists($GLOBALS['sys_custom_path'] . '/index_std.php') )
		//#	$this->rootindex = $GLOBALS['sys_custom_path'] . '/index_std.php';
		$this->Layout();

		/*
		Set up the priority color array one time only
		*/
/*
		$bgpri[1] = '#dadada';
		$bgpri[2] = '#dacaca';
		$bgpri[3] = '#dababa';
		$bgpri[4] = '#daaaaa';
		$bgpri[5] = '#da8a8a';
*/
/* CodeX Priority are still in old Fashion style */
$bgpri[1] = 'priora';
$bgpri[2] = 'priorb';
$bgpri[3] = 'priorc';
$bgpri[4] = 'priord';
$bgpri[5] = 'priore';
$bgpri[6] = 'priorf';
$bgpri[7] = 'priorg';
$bgpri[8] = 'priorh';
$bgpri[9] = 'priori';

		//determine font for this platform
		if (browser_is_windows() && browser_is_ie()) {

			//ie needs smaller fonts
			$this->FONTSIZE='x-small';
			$this->FONTSIZE_SMALLER='xx-small';
			$this->FONTSIZE_SMALLEST='7pt';

		} else if (browser_is_windows()) {

			//netscape on wintel
			$this->FONTSIZE='small';
			$this->FONTSIZE_SMALLER='x-small';
			$this->FONTSIZE_SMALLEST='x-small';

		} else if (browser_is_mac()){

			//mac users need bigger fonts
			$this->FONTSIZE='medium';
			$this->FONTSIZE_SMALLER='small';
			$this->FONTSIZE_SMALLEST='x-small';

		} else {

			//linux and other users
			$this->FONTSIZE='small';
			$this->FONTSIZE_SMALLER='x-small';
			$this->FONTSIZE_SMALLEST='xx-small';

		}

		$this->FONTSIZE_HTMLBOX_TITLE = $this->FONTSIZE;
	}

	/**
	 *	createLinkToUserHome() - Creates a link to a user's home page	
	 * 
	 *	@param	string	The user's user_name
	 *	@param	string	The user's realname
	 */
	function createLinkToUserHome($user_name, $realname) {
		return '<a href="/users/'.$user_name.'/">'.$realname.'</a>';
	}

	/**
	 *	header() - "steel theme" top of page
	 *
	 * @param	array	Header parameters array
	 */
	function header($params) {
		global $Language;

		if (!$params['title']) {
			$params['title'] =  $GLOBALS['sys_name'];
		} else {
			$params['title'] =  $GLOBALS['sys_name'] . ': ' . $params['title'];
		}
		print '<?xml version="1.0" encoding="' . $Language->getEncoding(). '"?>';
		?>

<!DOCTYPE html
	PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="<?php echo $Language->getLanguageCode(); ?>">

  <head>
	<meta http-equiv="Content-Type" content="text/html; charset=<?php echo $Language->getEncoding(); ?>" />
	<title><?php echo $params['title']; ?></title>
	<link rel="alternate" title="<?php echo $GLOBALS['sys_name']; ?> - Project News Highlights RSS" href="/export/rss_sfnews.php" type="application/rss+xml"/>
	<link rel="alternate" title="<?php echo $GLOBALS['sys_name']; ?> - New Projects RSS" href="/export/rss_sfprojects.php" type="application/rss+xml"/>
    <link rel="SHORTCUT ICON" href="<?php echo $this->imgroot; ?>favicon.ico">
	<script language="JavaScript" type="text/javascript">
	<!--

	function admin_window(adminurl) {
		AdminWin = window.open( adminurl, 'AdminWindow','scrollbars=yes,resizable=yes, toolbar=yes, height=400, width=400, top=2, left=2');
		AdminWin.focus();
	}
	function help_window(helpurl) {
		HelpWin = window.open( helpurl,'HelpWindow','scrollbars=yes,resizable=yes,toolbar=no,height=400,width=400');
	}
	// -->
	<?php 
        $em =& EventManager::instance();
        $em->processEvent("javascript",false); 
    ?>
	</script>
<?php
/*



	WARNING - changing this font call can affect
	INTERNATIONALIZATION


*/


		//gets font from Language Object
		$site_fonts=$GLOBALS['Language']->getFont();

	?>

<style type="text/css">
	<!--
    .priora { background-color: #dadada; }
    .priorb { background-color: #dacaca; }
    .priorc { background-color: #dababa; }
    .priord { background-color: #daaaaa; }
    .priore { background-color: #da8a8a; }
    .priorf { background-color: #da7a7a; }
    .priorg { background-color: #da6a6a; }
    .priorh { background-color: #da5a5a; }
    .priori { background-color: #da4a4a; }
    
    BODY {
        margin-top: 0;
        margin-left: 0;
        margin-right: 0;
        margin-bottom: 0;
        background-color: #bcbcad;
        font-family: helvetica,arial,verdana,sans-serif;
    }
    
	ol,ul,p,body,td,tr,th,form { 
        font-family: <?php echo $site_fonts; ?>; 
        font-size:<?php echo $this->FONTSIZE; ?>;
		color: <?php echo $this->FONTCOLOR_CONTENT ?>; 
    }

	h1 { font-size: x-large; font-family: <?php echo $site_fonts; ?>; }
	h2 { font-size: large; font-family: <?php echo $site_fonts; ?>; }
	h3 { font-size: medium; font-family: <?php echo $site_fonts; ?>; }
	h4 { font-size: small; font-family: <?php echo $site_fonts; ?>; }
	h5 { font-size: x-small; font-family: <?php echo $site_fonts; ?>; }
	h6 { font-size: xx-small; font-family: <?php echo $site_fonts; ?>; }

	pre,tt { font-family: courier,sans-serif }

	a:link { text-decoration:none; color: #8b4020; }
	a:visited { text-decoration:none; color: #8b4020 }
	a:active { text-decoration:none; color: #000000 }
	a:hover { text-decoration:underline; color:#ff0000; }

	.titlebar { 
        color: black; 
        text-decoration: none; 
        font-weight: bold;
        font-size: <?=$this->FONTSIZE_SMALLER?>;
    }
	a.tabsellink, a.tabsellink:visited, 
    a.tablink, a.tablink:visited {
        color: #4c4c47; 
        text-decoration: none; 
        font-size:0.8em;
    }
    a.tabsellink, a.tabsellink:visited {
        font-weight: bold;
    }
	a.tablink:hover { 
        text-decoration: underline; 
        color: red;
    }
	a.tabsellink:hover { 
        text-decoration: none; 
        color: black;
        cursor:default;
    }
   
   
    .searchbox td{
        color:white;
    }
.osdn { font-family: verdana,arial,helvetica,sans-serif; font-weight: bold; color: #ffffff; font-size:<?=$this->FONTSIZE_SMALLER?> }
.osdntext { font-weight: bold; text-decoration: none; color: #ffffff; font-size:<?=$this->FONTSIZE_SMALLER?> }
.osdntext:link { font-weight: bold; text-decoration: none; color: #ffffff; }
.osdntext:visited { font-weight: bold; text-decoration: none; color: #ffffff; }
.osdntext:hover { font-weight: bold; text-decoration: none; color: #ffffff; }
    .osdn_codex_logo {
        display:none;
    }
    .header_logo a img {
        border:none;
    }
    
    .footer {
        color: white; 
        font-size: <?=$this->FONTSIZE_SMALLEST?>;
    }
    .boxitem {  background-color:transparent; }
    
    
    .header_actions, .header_searchbox {
        text-align:right;
    }
    .header_logo {
        vertical-align:middle;
    }
    .header_searchbox {
        vertical-align:middle;
    }
    
    
    
    .header_actions ul {
        list-style-type:none;
        margin:0;
        padding:0;
        font-size: <?=$this->FONTSIZE_SMALLER?>;
    }
    .header_actions ul li {
        display:inline;
    }
    .header_actions ul li a {
        border-left:1px solid gray;
        color:white;
        text-decoration:none;
    }
    .header_actions ul li a,
    .header_actions ul li.header_actions_nolink {
        padding: 0.2em 1em;
    }
    .header_actions ul li.header_actions_nolink {
        font-weight:bold;
    }
    
    <?php 
        $em->processEvent("cssstyle",$this);
    ?>
	-->
</style>
<?php $em->processEvent('cssfile',$this); ?>
</head>

<body>
<div id="header">
    <table cellpadding="0" cellspacing="0" border="0" width="100%">
        <tr>
            <td class="header_osdn"><?php echo $this->getOsdnNavBar(); ?></td>
            <td class="header_actions">
                <ul><?php
                    if (user_isloggedin()) {
                    ?>
                        <li class="header_actions_nolink"><?php echo $Language->getText('include_menu','logged_in').': '.user_getname().''; ?></li>
                        <li><a href="/account/logout.php"><?php echo $Language->getText('include_menu','logout'); ?></a></li>
                        <li><a href="/register/"><?php echo $Language->getText('include_menu','register_new_proj') ?></a></li>
                                <?php 
                                if (!$GLOBALS['HTTP_POST_VARS']) {
                                    $bookmark_title = urlencode( str_replace($GLOBALS['sys_name'].': ', '', $params['title']));
                                    echo '<li class="bookmarkpage"><a href="/my/bookmark_add.php?bookmark_url='.urlencode($GLOBALS['REQUEST_URI']).'&bookmark_title='.$bookmark_title.'">',$Language->getText('include_menu','bookmark_this_page').'</a></li>';
                                }
                    } else {
                    ?>
                        <li><a href="/account/login.php"><?php echo $Language->getText('include_menu','login'); ?></a></li>
                        <li><a href="/account/register.php"><?php echo $Language->getText('include_menu','new_user'); ?></a></li>
                    <?php
                    }
                    ?>
                </ul>
            </td>
        </tr>
        <tr>
            <td class="header_logo">
                <a  class='header_logo' href="/"><img src="<?php echo $this->imgroot; ?>codex_banner_lc.png" /></a>
            </td>
            <td class="header_searchbox"><br /><?php echo $this->searchBox(); ?></td>
        </tr>
    </table>
</div>

<table border="0" width="100%" cellspacing="0" cellpadding="0">

	<tr>
		<td>&nbsp;</td>
		<td colspan="3">

<?php echo $this->outerTabs($params); ?>

		</td>
		<td>&nbsp;</td>
	</tr>

	<tr>
		<td align="left" bgcolor="#e8e8e0" width="9"><img src="<?php echo $this->imgroot; ?>tabs/topleft.png" height="9" width="9" alt="" /></td>
		<td bgcolor="#e8e8e0" width="30"><img src="<?php echo $this->imgroot; ?>clear.png" width="30" height="1" alt="" /></td>
		<td bgcolor="#e8e8e0"><img src="<?php echo $this->imgroot; ?>clear.png" width="1" height="1" alt="" /></td>
		<td bgcolor="#e8e8e0" width="30"><img src="<?php echo $this->imgroot; ?>clear.png" width="30" height="1" alt="" /></td>
		<td align="right" bgcolor="#e8e8e0" width="9"><img src="<?php echo $this->imgroot; ?>tabs/topright.png" height="9" width="9" alt="" /></td>
	</tr>

	<tr>

		<!-- Outer body row -->

		<td bgcolor="#e8e8e0"><img src="<?php echo $this->imgroot; ?>clear.png" width="10" height="1" alt="" /></td>
		<td valign="top" width="99%" bgcolor="#e8e8e0" colspan="3">

			<!-- Inner Tabs / Shell -->

			<table border="0" width="100%" cellspacing="0" cellpadding="0">
<?php


if (isset($params['group']) && $params['group']) {

			?>
			<tr>
				<td>&nbsp;</td>
				<td>
				<?php

				echo $this->projectTabs($params['toptab'],$params['group']);

				?>
				</td>
				<td>&nbsp;</td>
			</tr>
			<?php

}

?>
			<tr>
				<td align="left" bgcolor="#f7f7f7" width="9"><img src="<?php echo $this->imgroot; ?>tabs/topleft-inner.png" height="9" width="9" alt="" /></td>
				<td bgcolor="#f7f7f7"><img src="<?php echo $this->imgroot; ?>clear.png" width="1" height="1" alt="" /></td>
				<td align="right" bgcolor="#f7f7f7" width="9"><img src="<?php echo $this->imgroot; ?>tabs/topright-inner.png" height="9" width="9" alt="" /></td>
			</tr>

			<tr>
				<td bgcolor="#f7f7f7"><img src="<?php echo $this->imgroot; ?>clear.png" width="10" height="1" alt="" /></td>
				<td valign="top" width="99%" bgcolor="#f7f7f7">

	<?php

	}

	function footer($params) {

	?>

			<!-- end main body row -->


				</td>
				<td width="10" bgcolor="#f7f7f7"><img src="<?php echo $this->imgroot; ?>clear.png" width="2" height="1" alt="" /></td>
			</tr>
			<tr>
				<td align="left" bgcolor="#f7f7f7" width="9"><img src="<?php echo $this->imgroot; ?>tabs/bottomleft-inner.png" height="11" width="11" alt="" /></td>
				<td bgcolor="#f7f7f7"><img src="<?php echo $this->imgroot; ?>clear.png" width="1" height="1" alt="" /></td>
				<td align="right" bgcolor="#f7f7f7" width="9"><img src="<?php echo $this->imgroot; ?>tabs/bottomright-inner.png" height="11" width="11" alt="" /></td>
			</tr>
			</table>

		<!-- end inner body row -->

		</td>
		<td width="10" bgcolor="#e8e8e0"><img src="<?php echo $this->imgroot; ?>clear.png" width="2" height="1" alt="" /></td>
	</tr>
	<tr>
		<td align="left" bgcolor="#e8e8e0" width="9"><img src="<?php echo $this->imgroot; ?>tabs/bottomleft.png" height="9" width="9" alt="" /></td>
		<td bgcolor="#e8e8e0" colspan="3"><img src="<?php echo $this->imgroot; ?>clear.png" width="1" height="1" alt="" /></td>
		<td align="right" bgcolor="#e8e8e0" width="9"><img src="<?php echo $this->imgroot; ?>tabs/bottomright.png" height="9" width="9" alt="" /></td>
	</tr>
</table>
    <div style="float:left;"><?php echo $this->getOsdnNavDropdown(); ?></div>
<?php
        $this->generic_footer($params);
	}

	function getRootIndex() {
		return $this->rootindex;
	}

	/**
	 * boxTop() - Top HTML box
	 *
	 * @param   string  Box title
	 * @param   bool	Whether to echo or return the results
	 * @param   string  The box background color
	 */
	function boxTop($title) {
        return '
		<!-- Box Top Start -->

		<table cellspacing="0" cellpadding="0" width="100%" border="0">
		<tr align="center">
			<td valign="top" align="right" width="10" background="'.$this->imgroot.'box-topleft.png"><img src="'.$this->imgroot.'clear.png" width="10" height="20" /></td>
			<td width="100%" style="background:#e0ddd2 url(\''.$this->imgroot.'box-grad.png\') top left repeat-x;"><span class="titlebar">'.$title.'</span></td>
			<td valign="top" width="10" background="'.$this->imgroot.'box-topright.png"><img src="'.$this->imgroot.'clear.png" width="10" height="20" /></td>
		</tr>
		<tr>
			<td colspan="3">
			<table cellspacing="0" cellpadding="2" width="100%" border="0" style="background:url(\''.$this->imgroot.'vert-grad.png\') top left repeat-x;>
				<tr align="left"">
					<td colspan="2" >

		<!-- Box Top End -->';
	}

	/**
	 * boxMiddle() - Middle HTML box
	 *
	 * @param   string  Box title
	 * @param   string  The box background color
	 */
	function boxMiddle($title) {
        return '
		<!-- Box Middle Start -->
					</td>
				</tr>
				<tr align="center">
					<td colspan="2" style="background:#e0ddd2 url(\''.$this->imgroot.'box-grad.png\') top left repeat-x;"><span class="titlebar">'.$title.'</span></td>
				</tr>
				<tr align="left" style="background:url(\''.$this->imgroot.'vert-grad.png\') top left repeat-x;">
					<td colspan="2">
		<!-- Box Middle End -->';
	}

	/**
	 * boxBottom() - Bottom HTML box
	 *
	 * @param   bool	Whether to echo or return the results
	 */
	function boxBottom() {
        return '
			<!-- Box Bottom Start -->
					</td>
				</tr>
			</table>
			</td>
		</tr>
		</table><br />
		<!-- Box Bottom End -->';
	}

	/**
	 * boxGetAltRowStyle() - Get an alternating row style for tables
	 *
	 * @param			   int			 Row number
	 */
	function boxGetAltRowStyle($i) {
		if ($i % 2 == 0) {
			return 'background="'.$this->imgroot.'vert-grad.png"';
		} else {
			return 'background="'.$this->imgroot.'box-grad.png"';
		}
	}

	/**
	 * listTableTop() - Takes an array of titles and builds the first row of a new table.
	 *
	 * @param	   array   The array of titles
	 * @param	   array   The array of title links
	 */
	function listTableTop ($title_arr,$links_arr=false) {
		$return = '
		<table cellspacing="0" cellpadding="0" width="100%" border="0">
		<tr align="center">
	<!--		<td valign="top" align="right" width="10" background="'.$this->imgroot.'box-grad.png"><img src="'.$this->imgroot.'box-topleft.png" width="10" height="75" /></td> -->
			<td background="'.$this->imgroot.'box-grad.png">
		<table width="100%" border="0" cellspacing="1" cellpadding="2">
			<tr>';

		$count=count($title_arr);
		if ($links_arr) {
			for ($i=0; $i<$count; $i++) {
				$return .= '
				<td align="center"><a class="sortbutton" href="'.$links_arr[$i].'"><span style="color:'.
				$this->FONTCOLOR_HTMLBOX_TITLE.'"><strong>'.$title_arr[$i].'</strong></span></a></td>';
			}
		} else {
			for ($i=0; $i<$count; $i++) {
				$return .= '
				<td align="center"><span style="color:'.
				$this->FONTCOLOR_HTMLBOX_TITLE.'"><strong>'.$title_arr[$i].'</strong></span></td>';
			}
		}
		return $return.'</tr>';
	}

	function listTableBottom() {
		return '</table></td>
			<!-- <td valign="top" align="right" width="10" background="'.$this->imgroot.'box-grad.png"><img src="'.$this->imgroot.'box-topright.png" width="10" height="75" /></td> -->
			</tr></table>';
	}

	function outerTabs($params) {
		global $Language,$sys_use_trove,$sys_use_snippet,$sys_use_people;

		$TABS_DIRS[]='/';
		$TABS_TITLES[]=$Language->getText('menu','home');

		if (user_isloggedin()) {
            $TABS_DIRS[]='/my/';
            $TABS_TITLES[]=$Language->getText('menu','my_personal_page');

            $TABS_DIRS[]='/account/';
            $TABS_TITLES[]=$Language->getText('include_menu','account_maintenance');
        }
        
        $TABS_DIRS[]='/softwaremap/';
        $TABS_TITLES[]=$Language->getText('menu','projectree');

        $TABS_DIRS[]='/snippet/';
        $TABS_TITLES[]=$Language->getText('menu','code_snippet');

        if ($sys_use_people) {
			$TABS_DIRS[]='/people/';
			$TABS_TITLES[]=$Language->getText('menu','project_help_wanted');
		}
		if (user_ismember(1,'A')) {
			$TABS_DIRS[]='/admin/';
			$TABS_TITLES[]=$Language->getText('menu','admin');
		}

        $TABS_DIRS[]='/site/';
        $TABS_TITLES[]=$GLOBALS['sys_name'];
        
        /*
		if (user_ismember($GLOBALS['sys_stats_group'])) {
			$TABS_DIRS[]='/reporting/';
			$TABS_TITLES[]=$Language->getText('menu','reporting');
		}
        */
		if(isset($params['group']) && $params['group']) {
			// get group info using the common result set
			$project =& group_get_object($params['group']);
			if ($project && is_object($project)) {
				if ($project->isError()) {

				} elseif (!$project->isProject()) {

				} else {
					$TABS_DIRS[]='/projects/'.$project->getUnixName().'/';
					$TABS_TITLES[]=$project->getPublicName();
					$selected=count($TABS_DIRS)-1;
				}
			}
		} elseif (strstr(getStringFromServer('REQUEST_URI'),'/my/') ||  
				strstr(getStringFromServer('REQUEST_URI'),'/themes/') ) {
			$selected=array_search("/my/", $TABS_DIRS);
        } elseif (strstr(getStringFromServer('REQUEST_URI'),'/account/')) {
            $selected=array_search("/account/", $TABS_DIRS);
		} elseif (strstr(getStringFromServer('REQUEST_URI'),'softwaremap')) {
			$selected=array_search("/softwaremap/", $TABS_DIRS);
		} elseif (strstr(getStringFromServer('REQUEST_URI'),'/snippet/')) {
			$selected=array_search("/snippet/", $TABS_DIRS);
		} elseif (strstr(getStringFromServer('REQUEST_URI'),'/people/')) {
			$selected=array_search("/people/", $TABS_DIRS);
		} elseif (strstr(getStringFromServer('REQUEST_URI'),'/site/')) {
			$selected=array_search("/site/", $TABS_DIRS);
		} elseif (strstr(getStringFromServer('REQUEST_URI'),'/reporting/')) {
			$selected=array_search('/reporting/',$TABS_DIRS);
		} elseif (strstr(getStringFromServer('REQUEST_URI'),'/admin/') && user_ismember(1,'A')) {
			$selected=array_search('/admin/',$TABS_DIRS);;
		} else {
			$selected=0;
		}
		if (!$this->COLOR_SELECTED_TAB) {
			$this->COLOR_SELECTED_TAB= '#e0e0e0';
		}
		echo $this->tabGenerator($TABS_DIRS,$TABS_TITLES,false,$selected,$this->COLOR_SELECTED_TAB,'100%');

	}

	/**
	 *	projectTabs() - Prints out the project tabs, contained here in case
	 *		we want to allow it to be overriden
	 *
	 *	@param	string	Is the tab currently selected
	 *	@param	string	Is the group we should look up get title info
	 */
	function projectTabs($toptab,$group) {
        $this->project_tabs($toptab,$group);
    }
    
    function project_tabs($toptab,$group_id) {
        $project=project_get_object($group_id);
        if ($project->isError()) {
            //wasn't found or some other problem
            return;
        }
        $output   = '';
        $tabs     = $this->_getProjectTabs($toptab, $project);
        $nb       = count($tabs);
        $selected = false;
        $TABS_DIRS   = array();
        $TABS_TITLES = array();
        for($i = 0; $i < $nb ; $i++) {
            $TABS_DIRS[]   = $tabs[$i]['link'];
            $TABS_TITLES[] = $tabs[$i]['label'];
            if ($tabs[$i]['enabled'] === true) {
                $selected = $i;
            }
        }
        $output .= $this->tabGenerator($TABS_DIRS,$TABS_TITLES,true,$selected);
        echo $output;
	}

	function tabGenerator($TABS_DIRS,$TABS_TITLES,$nested=false,$selected=false,$sel_tab_bgcolor='WHITE',$total_width='100%') {

		$count=count($TABS_DIRS);
		$width=intval((100/$count));
		
		$return = '';
		
		$return .= '

		<!-- start tabs -->

		<table border="0" cellpadding="0" cellspacing="0" width="'.$total_width.'">
		<tr>';
		if ($nested) {
			$inner='bottomtab';
		} else {
			$inner='toptab';
		}
		$rowspan = '';
		for ($i=0; $i<$count; $i++) {
			if ($i == 0) {
				//
				//	this is the first tab, choose an image with end-name
				//
				$wassel=false;
				$issel=($selected==$i);
				$bgimg=(($issel)?'theme-'.$inner.'-selected-bg.png':'theme-'.$inner.'-notselected-bg.png');
		//		$rowspan=(($issel)?'rowspan="2" ' : '');

				$return .= '
					<td '.$rowspan.'valign="top" width="10" background="'.$this->imgroot . 'theme-'.$inner.'-end-'.(($issel) ? '' : 'not').'selected.png">'.
						'<img src="'.$this->imgroot . 'clear.png" height="25" width="10" alt="" /></td>'.
						'<td '.$rowspan.'background="'.$this->imgroot . $bgimg.'" width="'.$width.'%" align="center"><a class="'. (($issel)?'tabsellink':'tablink') .'" href="'.$TABS_DIRS[$i].'">'.$TABS_TITLES[$i].'</a></td>';
			} elseif ($i==$count-1) {
				//
				//	this is the last tab, choose an image with name-end
				//
				$wassel=($selected==$i-1);
				$issel=($selected==$i);
				$bgimg=(($issel)?'theme-'.$inner.'-selected-bg.png':'theme-'.$inner.'-notselected-bg.png');
		//		$rowspan=(($issel)?'rowspan="2" ' : '');
				//
				//	Build image between current and prior tab
				//
				$return .= '
					<td '.$rowspan.'colspan="2" valign="top" width="20" background="'.$this->imgroot . 'theme-'.$inner.'-'.(($wassel) ? '' : 'not').'selected-'.(($issel) ? '' : 'not').'selected.png">'.
						'<img src="'.$this->imgroot . 'clear.png" height="2" width="20" alt="" /></td>'.
						'<td '.$rowspan.'background="'.$this->imgroot . $bgimg.'" width="'.$width.'%" align="center"><a class="'. (($issel)?'tabsellink':'tablink') .'" href="'.$TABS_DIRS[$i].'">'.$TABS_TITLES[$i].'</a></td>';
				//
				//	Last graphic on right-side
				//
				$return .= '
					<td '.$rowspan.'valign="top" width="10" background="'.$this->imgroot . 'theme-'.$inner.'-'.(($issel) ? '' : 'not').'selected-end.png">'.
						'<img src="'.$this->imgroot . 'clear.png" height="2" width="10" alt="" /></td>';

			} else {
				//
				//	middle tabs
				//
				$wassel=($selected==$i-1);
				$issel=($selected==$i);
				$bgimg=(($issel)?'theme-'.$inner.'-selected-bg.png':'theme-'.$inner.'-notselected-bg.png');
		//		$rowspan=(($issel)?'rowspan="2" ' : '');
				//
				//	Build image between current and prior tab
				//
				$return .= '
					<td '.$rowspan.'colspan="2" valign="top" width="20" background="'.$this->imgroot . 'theme-'.$inner.'-'.(($wassel) ? '' : 'not').'selected-'.(($issel) ? '' : 'not').'selected.png">'.
						'<img src="'.$this->imgroot . 'clear.png" height="2" width="20" alt="" /></td>'.
						'<td '.$rowspan.'background="'.$this->imgroot . $bgimg.'" width="'.$width.'%" align="center"><a class="'. (($issel)?'tabsellink':'tablink') .'" href="'.$TABS_DIRS[$i].'">'.$TABS_TITLES[$i].'</a></td>';

			}
		}
		$return .= '</tr>';

		//
		//	Building a bottom row in this table, which will be darker
		//
		if ($selected == 0) {
			$beg_cols=0;
			$end_cols=((count($TABS_DIRS)*3)-3);
		} elseif ($selected == (count($TABS_DIRS)-1)) {
			$beg_cols=((count($TABS_DIRS)*3)-3);
			$end_cols=0;
		} else {
			$beg_cols=($selected*3);
			$end_cols=(((count($TABS_DIRS)*3)-3)-$beg_cols);
		}
		$return .= '<tr>';
		if ($beg_cols > 0) {
			$return .= '<td colspan="'.$beg_cols.'" height="1" bgcolor="#909090"><img src="'.$this->imgroot.'clear.png" height="1" width="10" /></td>';
		}
		$return .= '<td colspan="3" height="1" bgcolor="'.$sel_tab_bgcolor.'"><img src="'.$this->imgroot.'clear.png" height="1" width="10" /></td>';
		if ($end_cols > 0) {
			$return .= '<td colspan="'.$end_cols.'" height="1" bgcolor="#909090"><img src="'.$this->imgroot.'clear.png" height="1" width="10" /></td>';
		}
		$return .= '</tr>';


/*
			$bgcolor=(($selected==$i)?$light:$dark);
			$imgcolor=(($selected==$i)?'':'-dark');
			$return .= '
				<td '.$bgcolor.' width="9" valign="top">'.
					'<div align="left">'. html_image('tabs/topleft'.$inner.$imgcolor.'.png',9,9,array()).'</div></td>
				<td '.$bgcolor.' width="'.$width.'%" rowspan="2" align="center">'.
				'<a class="'. (($selected==$i)?'tabsellink':'tablink') .'" href="'. $TABS_DIRS[$i] .
					'">'. $TABS_TITLES[$i] .'</a></td>
				<td '.$bgcolor.' width="9" valign="top">'.
				'<div align="right">'. html_image('tabs/topright'.$inner.$imgcolor.'.png',9,9,array()).'</div></td>';
			if ($i < $count-1) {
				$return .= '<td width="1" rowspan="2"><img src="'.$this->imgroot . 'clear.png" height="2" width="1" alt="" /></td>';
			}
		}

		$return .= '
		</tr>
		<tr>';
		for ($i=0; $i<$count; $i++) {
			$bgcolor=(($selected==$i)?$light:$dark);
			$return .= '<td '.$bgcolor.'>&nbsp;</td>';
			$return .= '<td '.$bgcolor.'>&nbsp;</td>';
		}
		$return .= '
		</tr>
		<tr>';
		for ($i=0; $i<$count; $i++) {
			$bgcolor=(($selected==$i)?$light:'style="background-color:#999999"');
			$return .= '<td '.$bgcolor.' colspan="4"><img src="'.$this->imgroot . 'clear.png" height="2" width="1" alt="" /></td>';
		}
*/
		return $return.'
		</table> 

		<!-- end tabs -->
';
	}

	function searchBox() {
        global $words,$forum_id,$group_id,$is_bug_page,$is_support_page,$Language,
            $is_pm_page,$is_snippet_page,$exact,$type_of_search,$atid;

		// if there is no search currently, set the default
		if ( ! isset($type_of_search) ) {
			$exact = 1;
		}

		$output = '
		<form action="/search/" method="post">
		<div>';
		$output .= '<select name="type_of_search">';
        if ($is_bug_page && $group_id) {
            $output .= "\t<OPTION value=\"bugs\"".( $type_of_search == "bugs" ? " SELECTED" : "" ).">".$Language->getText('include_menu','bugs')."</OPTION>\n";
        } else if ($is_pm_page && $group_id) {
            $output .= "\t<OPTION value=\"tasks\"".( $type_of_search == "tasks" ? " SELECTED" : "" ).">".$Language->getText('include_menu','tasks')."</OPTION>\n";
        } else if ($is_support_page && $group_id) {
            $output .= "\t<OPTION value=\"support\"".( $type_of_search == "support" ? " SELECTED" : "" ).">".$Language->getText('include_menu','supp_requ')."</OPTION>\n";
        } else if ($group_id && $forum_id) {
            $output .= "\t<OPTION value=\"forums\"".( $type_of_search == "forums" ? " SELECTED" : "" ).">".$Language->getText('include_menu','this_forum')."</OPTION>\n";
        } else if ($group_id && $atid) {
            $output .= "\t<OPTION value=\"tracker\"".( $type_of_search == "tracker" ? " SELECTED" : "" ).">".$Language->getText('include_menu','this_tracker')."</OPTION>\n";
        }
        $output .= "\t<OPTION value=\"soft\"".( $type_of_search == "soft" ? " SELECTED" : "" ).">".$Language->getText('include_menu','software_proj')."</OPTION>\n";
        $output .= "\t<OPTION value=\"snippets\"".( ($type_of_search == "snippets" || $is_snippet_page) ? " SELECTED" : "" ).">".$Language->getText('include_menu','code_snippets')."</OPTION>\n";
        $output .= "\t<OPTION value=\"people\"".( $type_of_search == "people" ? " SELECTED" : "" ).">".$Language->getText('include_menu','people')."</OPTION>\n";
        $output .= "\t</select>";

         $output .= '<input type="CHECKBOX" name="exact" value="1"'.( $exact ? ' CHECKED' : ' UNCHECKED' ).'>'.$Language->getText('include_menu','require_all_words');
        

		if ( isset($atid) ) {
            $output .= "\t<INPUT TYPE=\"HIDDEN\" VALUE=\"$atid\" NAME=\"atid\">\n";
        } 
        if ( isset($forum_id) ) {
            $output .= "\t<INPUT TYPE=\"HIDDEN\" VALUE=\"$forum_id\" NAME=\"forum_id\">\n";
        } 
        if ( isset($is_bug_page) ) {
           $output .= "\t<INPUT TYPE=\"HIDDEN\" VALUE=\"$is_bug_page\" NAME=\"is_bug_page\">\n";
        }
        if ( isset($is_support_page) ) {
           $output .= "\t<INPUT TYPE=\"HIDDEN\" VALUE=\"$is_support_page\" NAME=\"is_support_page\">\n";
        }
        if ( isset($is_pm_page) ) {
           $output .= "\t<INPUT TYPE=\"HIDDEN\" VALUE=\"$is_pm_page\" NAME=\"is_pm_page\">\n";
        }
        if ( isset($is_snippet_page) ) {
            $output .= "\t<INPUT TYPE=\"HIDDEN\" VALUE=\"$is_snippet_page\" NAME=\"is_snippet_page\">\n";
        }
        if ( isset($group_id) ) {
           $output .= "\t<INPUT TYPE=\"HIDDEN\" VALUE=\"$group_id\" NAME=\"group_id\">\n";
        }
		$output .= '';
        
		$output .= '<input type="text" size="22" name="words" value="'.$words.'" />';

		$output .= '&nbsp;';
		$output .= '<input type="submit" name="Search" value="'.$Language->getText('searchbox','search').'" />';
		$output .= '</div></form>';
        print $output;
	}
	
	function advancedSearchBox($sectionsArray, $group_id, $words, $isExact) {
		global $Language;
		 // display the searchmask
		print '
		<form name="advancedsearch" action="'.getStringFromServer('PHP_SELF').'" method="post">
		<input type="hidden" name="search" value="1"/>
		<input type="hidden" name="group_id" value="'.$group_id.'"/>
		<div align="center"><br />
			<table border="0">
				<tr>
					<td colspan ="2">
						<input type="text" size="60" name="words" value="'.stripslashes(htmlspecialchars($words)).'" />
						<input type="submit" name="submitbutton" value="'.$Language->getText('advanced_search', 'search_button').'" />
					</td>
				</tr>
				<tr>
					<td valign="top">
						<input type="radio" name="mode" value="'.SEARCH__MODE_AND.'" '.($isExact ? 'checked="checked"' : '').' />'.$Language->getText('advanced_search', 'and_search').'
					</td>
					<td>
						<input type="radio" name="mode" value="'.SEARCH__MODE_OR.'" '.(!$isExact ? 'checked="checked"' : '').' />'.$Language->getText('advanced_search', 'or_search').'
					</td>
				</tr>
			</table><br /></div>'
		.$this->createUnderSections($sectionsArray).'
		</form>';


		//create javascript methods for select none/all
		print '
		<script type="text/javascript">
			<!-- method for disable/enable checkboxes
			function setCheckBoxes(parent, checked) {


				for (var i = 0; i < document.advancedsearch.elements.length; i++)
					if (document.advancedsearch.elements[i].type == "checkbox") 
							if (document.advancedsearch.elements[i].name.substr(0, parent.length) == parent)
								document.advancedsearch.elements[i].checked = checked;
				}
			//-->
		</script>
		';

	}
	
	function createUnderSections($sectionsArray) {
		global $Language;
		$countLines = 0;
		foreach ($sectionsArray as $section) {
			if(is_array($section)) {
				$countLines += (3 + count ($section));
			} else {
				//2 lines one for section name and one for checkbox
				$countLines += 3;
			}
		}
		$breakLimit = round($countLines/3);
		$break = $breakLimit;
		$countLines = 0;
		$return = '
			<table width="100%" border="0" cellspacing="0" cellpadding="2" style="background-color:'. $this->COLOR_HTMLBOX_TITLE .'">
				<tr>
					<td>
						<table width="100%" cellspacing="0" border="0">
							<tr style="font-weight: bold; background-color:'. $this->COLOR_HTMLBOX_TITLE .'">
								<td colspan="2">'.$Language->getText('advanced_search', 'search_in').':</td>
								<td align="right">'.$Language->getText('advanced_search', 'select').' <a href="javascript:setCheckBoxes(\'\', true)">'.$Language->getText('advanced_search', 'all').'</a> / <a href="javascript:setCheckBoxes(\'\', false)">'.$Language->getText('advanced_search', 'none').'</a></td>
							</tr>
							<tr height="20" style="background-color:'. $this->COLOR_CONTENT_BACK .'">
								<td colspan="3">&nbsp;</td>
							</tr>
							<tr align="center" valign="top" style="background-color:'. $this->COLOR_CONTENT_BACK .'">
								<td>';
		foreach($sectionsArray as $key => $section) {
			$oldcountlines = $countLines;
			if (is_array($section)) {
				$countLines += (3 + count ($section));
			} else {
				$countLines += 3;
			}
				
			if ($countLines >= $break) {
				//if the next block is so large that shifting it to the next column hits the breakpoint better
				//the second part of statement (behind &&) proofs, that no 4th column is added
				if ((($countLines - $break) >= ($break - $countLines)) && ((($break + $breakLimit)/$breakLimit) <= 3)) {
					$return .= '</td><td>';
					$break += $breakLimit;
				}
			}
		
			$return .= '<table width="90%" border="0" cellpadding="1" cellspacing="0" style="background-color:'. $this->COLOR_HTMLBOX_TITLE.'">
							<tr><td><table width="100%" border="0" cellspacing="0" cellpadding="3">
							<tr style="background-color:'. $this->COLOR_HTMLBOX_TITLE .'; font-weight: bold">
								<td cellspacing="0">
									<a href="#'.$key.'">'.$Language->getText('group', $key).'</a>'
							.'	</td>
								<td align="right">'
								.$Language->getText('advanced_search', 'select').' <a href="javascript:setCheckBoxes(\''.$key.'\', true)">'.$Language->getText('advanced_search', 'all').'</a> / <a href="javascript:setCheckBoxes(\''.$key.'\', false)">'.$Language->getText('advanced_search', 'none').'</a>
								</td>
							</tr>
							<tr style="background-color:'. $this->COLOR_CONTENT_BACK.'">
								<td colspan="2">';
								
			if (!is_array($section)) {
				$return .= '		<input type="checkbox" name="'.urlencode($key).'"';
				if (isset($GLOBALS[urlencode($key)]))
					$return .= ' checked="checked" ';
				$return .= ' /></input>'.$Language->getText('group', $key).'<br />';
			}
			else
				foreach($section as $underkey => $undersection) {
					$return .= '	<input type="checkbox" name="'.urlencode($key.$underkey).'"';
					if (isset($GLOBALS[urlencode($key.$underkey)]))
						$return .= ' checked ';
					$return .= '></input>'.$undersection.'<br />';				
					
				}
				
			$return .=		'	</td>
							</tr>
						</table></td></tr></table><br />';
						
			if ($countLines >= $break) {
				if (($countLines - $break) < ($break - $countLines)) {
					$return .= '</td><td width="33%">';
					$break += $breakLimit;
				}
			}
		}
		
		return $return.'		</td>
							</tr>
						</table></td></tr></table>';
	}

	/**
	 * beginSubMenu() - Opening a submenu.
	 *
	 * @return	string	Html to start a submenu.
	 */
	function beginSubMenu () {
		$return = '
			<p><strong>';
		return $return;
	}

	/**
	 * endSubMenu() - Closing a submenu.
	 *
	 * @return	string	Html to end a submenu.
	 */
	function endSubMenu () {
		$return = '</strong></p>';
		return $return;
	}

	/**
	 * printSubMenu() - Takes two array of titles and links and builds the contents of a menu.
	 *
	 * @param	   array   The array of titles.
	 * @param	   array   The array of title links.
	 * @return	string	Html to build a submenu.
	 */
	function printSubMenu ($title_arr,$links_arr) {
		$count=count($title_arr);
		$count--;
		
		$return = '';
		
		for ($i=0; $i<$count; $i++) {
			$return .= '
				<a href="'.$links_arr[$i].'">'.$title_arr[$i].'</a> | ';
		}
		$return .= '
				<a href="'.$links_arr[$i].'">'.$title_arr[$i].'</a>';
		return $return;
	}

	/**
	 * subMenu() - Takes two array of titles and links and build a menu.
	 *
	 * @param	   array   The array of titles.
	 * @param	   array   The array of title links.
	 * @return	string	Html to build a submenu.
	 */
	function subMenu ($title_arr,$links_arr) {
		$return  = $this->beginSubMenu () ;
		$return .= $this->printSubMenu ($title_arr,$links_arr) ;
		$return .= $this->endSubMenu () ;
		return $return;
	}

	/**
	 * multiTableRow() - create a mutlilevel row in a table
	 *
	 * @param	string	the row attributes
	 * @param	array	the array of cell data, each element is an array,
	 *				  	the first item being the text,
	 *					the subsequent items are attributes (dont include
	 *					the bgcolor for the title here, that will be
	 *					handled by $istitle
	 * @param	boolean is this row part of the title ?
	 *
	 */
	 function multiTableRow($row_attr, $cell_data, $istitle) {
		$return= '
		<tr '.$row_attr;
		if ( $istitle ) {
			$return .=' align="center" bgcolor="'. $this->COLOR_HTMLBOX_TITLE .'"';
		}
		$return .= '>';
		for ( $c = 0; $c < count($cell_data); $c++ ) {
			$return .='<td ';
			for ( $a=1; $a < count($cell_data[$c]); $a++) {
				$return .= $cell_data[$c][$a].' ';
			}
			$return .= '>';
			if ( $istitle ) {
				$return .='<font color="'.$this->FONTCOLOR_HTMLBOX_TITLE.'"><strong>';
			}
			$return .= $cell_data[$c][0];
			if ( $istitle ) {
				$return .='</strong></font>';
			}
			$return .= '</td>';

		}
		$return .= '</tr>
		';

		return $return;
	}
	
	/**
	 * feedback() - returns the htmlized feedback string when an action is performed.
	 *
	 * @param string feedback string
	 * @return string htmlized feedback
	 */
	function feedback($feedback) {
        if (!$feedback) {
			return '';
		} else {
			return '
				<h3 style="color:red">'.strip_tags($feedback, '<br>').'</h3>';
		}
	}

	/**
	 * getThemeIdFromName()
	 *
	 * @param	string  the dirname of the theme
	 * @return	integer the theme id	
	 */
	/*
    function getThemeIdFromName($dirname) {
	 	$res=db_query("SELECT theme_id FROM themes WHERE dirname='$dirname'");
	        return db_result($res,0,'theme_id');
	}
    */
    
    
    
    
    
    
    
    
    //Codex compatibility
    function menuhtml_top($title) {
    }
    function menuhtml_bottom() {
    }
	function menu_entry($link, $title) {
    }
	function box1_top($title,$echoout=1,$bgcolor='',$cols=2){
        if ($echoout) {
            print $this->boxTop($title);
        } else {
            return $this->boxTop($title);
        }
	}

	// Codex Compat
	// Box Middle, equivalent to html_box1_middle()
	function box1_middle($title,$bgcolor='',$cols=2) {
		return $this->boxMiddle($title);
	}

	// Codex Compat
	// Box Bottom, equivalent to html_box1_bottom()
	function box1_bottom($echoout=1) {
        if ($echoout) {
            print $this->boxBottom();
        } else {
            return $this->boxBottom();
        }
	}
}

// Local Variables:
// mode: php
// c-file-style: "bsd"
// End:

?>
