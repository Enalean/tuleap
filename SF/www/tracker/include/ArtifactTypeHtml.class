<?php
//
// Copyright (c) Xerox Corporation, CodeX Team, 2001-2003. All rights reserved
//
// $Id$
//
//
//	Originally by to the SourceForge Team,1999-2000
//
//  Written for CodeX by Stephane Bouhet
//

//require_once('common/tracker/ArtifactType.class');
require_once('HTML_Graphs.php');
require_once('www/project/admin/ugroup_utils.php');

$Language->loadLanguageMsg('tracker/tracker');

class ArtifactTypeHtml extends ArtifactType {

	/**
	 *  ArtifactType() - constructor
	 *
	 *  @param $Group object
	 *  @param $artifact_type_id - the id # assigned to this artifact type in the db
	 */
	function ArtifactTypeHtml(&$Group,$artifact_type_id=false, $arr=false) {
		return $this->ArtifactType($Group,$artifact_type_id,$arr);
	}

	/**
	 *  Display the header menu for this artifact type
	 *
	 *  @param params: array of parameters used to display the header
	 * 
	 *  @return void
	 */
	function header($params) {
		global $Language;

		$group_id= $this->Group->getID();

		//required by new site_project_header
		$params['group']=$group_id;
		$params['toptab']='tracker';
		$params['tabtext']=$this->getName();

		site_project_header($params);
                if (!$params['pv']) {
                    echo '<h3>'.$Language->getText('tracker_import_admin','tracker').': <a href="/tracker/?group_id='.$group_id.'&atid='.$this->getID().'">'.$this->getName().'</a></h3><p>';

                    echo '<strong><a href="/tracker/?func=add&group_id='.$group_id.'&atid='. $this->getID() .'">'.$Language->getText('tracker_include_type','submit_new',$this->getCapsItemName()).'</a>';
                    echo ' | <a href="/tracker/?func=browse&set=my&group_id='.$group_id.'&atid='. $this->getID() .'">'.$Language->getText('tracker_include_type','my',$this->getCapsItemName()).'s </a>';
                    echo ' | <a href="/tracker/?func=browse&set=open&group_id='.$group_id.'&atid='. $this->getID() .'">'.$Language->getText('tracker_include_type','open',$this->getCapsItemName()).'s </a>';
                    if ($this->userIsAdmin()) {
			echo ' | <a href="/tracker/?func=masschange&group_id='.$group_id.'&atid='. $this->getID() .'">'.$Language->getText('tracker_index','mass_change').' </a>';
			echo ' | <a href="/tracker/?func=import&group_id='.$group_id.'&atid='. $this->getID() .'">'.$Language->getText('tracker_import_admin','import').' </a>';
                    }
                    echo ' | <a href="/tracker/?func=reporting&group_id='.$group_id.'&atid='.$this->getID().'">'.$Language->getText('tracker_include_type','reporting').'</a>';
                    echo ' | <a href="/tracker/admin/?group_id='.$group_id.'&atid='.$this->getID().'">'.$Language->getText('tracker_include_type','admin').'</a>';
                    if ($params['help']) {
                        echo ' | '.help_button($params['help'],false,$Language->getText('global','help'));
                    }
                    
                    echo '</strong><br>';
                    echo '<HR NoShade SIZE="1" SIZE="90%">';
                }
	}

	/**
	 *  Display the footer for this artifact type
	 *
	 *  @param params: array of parameters used to display the header
	 * 
	 *  @return void
	 */
	function footer($params) {
		site_project_footer($params);
	}

	/**
	 *  Display the admin header menu for this artifact type
	 *
	 *  @param params: array of parameters used to display the header
	 * 
	 *  @return void
	 */
	function adminHeader($params) {
	  global $Language;

		$group_id= $this->Group->getID();

		//required by new site_project_header
		$params['group']=$group_id;
		$params['toptab']='tracker';
		$params['tabtext']=$this->getName();

		site_project_header($params);

		echo '<strong><a href="/tracker/admin/?group_id='.$group_id.'">'.$Language->getText('tracker_index','admin_all_trackers').'</a>';
		echo ' | <a href="/tracker/admin/?group_id='.$group_id.'&atid='. $this->getID() .'">'.$Language->getText('tracker_include_type','admin').'</a>';
		echo ' | <a href="/tracker/admin/?group_id='.$group_id.'&atid='. $this->getID() .'&func=editoptions">'.$Language->getText('tracker_include_type','settings').'</a>';
		echo ' | <a href="/tracker/admin/?group_id='.$group_id.'&atid='. $this->getID() .'&func=field_usage">'.$Language->getText('tracker_include_type','field_usage').'</a>';
		echo ' | <a href="/tracker/admin/?group_id='.$group_id.'&atid='. $this->getID() .'&func=field_values">'.$Language->getText('tracker_include_type','field_values').'</a>';
		echo ' | <a href="/tracker/admin/?group_id='.$group_id.'&atid='. $this->getID() .'&func=canned">'.$Language->getText('tracker_include_type','canned_resp').'</a>';
		echo ' | <a href="/tracker/admin/?func=report&group_id='.$group_id.'&atid='. $this->getID() .'">'.$Language->getText('tracker_include_type','reports').'</a>';
		echo ' | <a href="/tracker/admin/?func=notification&group_id='.$group_id.'&atid='. $this->getID() .'&func=notification">'.$Language->getText('tracker_include_type','mail_notif').'</a>';
	    echo ' | '.help_button($params['help'],false,$Language->getText('global','help'));
		echo '</strong><hr>';
	}

	/**
	 *  Display the admin header menu for artifact type
	 *
	 *  @param params: array of parameters used to display the header
	 * 
	 *  @return void
	 */
	function adminTrackersHeader($params) {
	  global $Language;

		$group_id= $this->Group->getID();

		//required by new site_project_header
		$params['group']=$group_id;
		$params['toptab']='tracker';
		$params['tabtext']=$this->getName();

		site_project_header($params);

		echo '<strong><a href="/tracker/admin/?group_id='.$group_id.'">'.$Language->getText('tracker_index','admin_all_trackers').'</a>';
		echo ' | <a href="/tracker/admin/?group_id='.$group_id.'&func=create">'.$Language->getText('tracker_index','create_new_tracker').'</a>';
		if ($params['help']) {
		    echo ' | '.help_button($params['help'],false,$Language->getText('global','help'));
		}
		echo '</strong><hr>';
	}

	/**
	 *  Display a select box for the canned responses
	 *
	 *  @param name: the select box name
	 *  @param checked: the default value
	 *  @param show_100: add the 100 value
	 *  @param text_100: the 100 label
	 * 
	 *  @return void
	 */
	function cannedResponseBox ($name='canned_response',$checked='xzxz') {
		return html_build_select_box ($this->getCannedResponses(),$name,$checked);
	}
	
	/**
	 *  Display the different options and the trackers lists
	 *
	 *  @return void
	 */
	function displayPendingTrackers() {
		global $atf,$Language;
		

		echo "<form name=\"cal\"><script language=\"JavaScript\" src=\"/include/calendar.js\"></script>";		
		// Get the artfact type list
		$at_arr = $atf->getPendingArtifactTypes();
		echo '<H2>'.$Language->getText('tracker_include_type','pending_removal').'</H2>';
		if (!$at_arr) {
			echo '<h3>'.$Language->getText('tracker_include_type','no_pending').'</h3>';
		} else {
		    echo '<H3>'.$Language->getText('tracker_include_type','pending_deletion').'</H3>';

			$title_arr=array();
			$title_arr[]=$Language->getText('tracker_include_report','id');
			$title_arr[]=$Language->getText('tracker_include_report','project');
			$title_arr[]=$Language->getText('tracker_import_admin','tracker');
			$title_arr[]=$Language->getText('tracker_include_type','deletion_date');
			$title_arr[]=$Language->getText('tracker_include_type','delay');
			$title_arr[]=$Language->getText('tracker_include_type','restore');
			$title_arr[]=$Language->getText('tracker_include_canned','delete');
			echo html_build_list_table_top ($title_arr);
		
			$fmt = "\n".'<TR class="%s"><td>%s</td><td>%s</td><td>%s</td><td>%s</td>'.
			    '<td align="center">%s</td><td align="center">%s</td><td align="center">%s</td></tr>';
			$i=0;
			while ($arr = db_fetch_array($at_arr)) {
			    echo sprintf($fmt,
					    util_get_alt_row_color($i),
					    $arr['group_artifact_id'],
					    $arr['project_name'],
					    $arr['name'],
					    '<input type="text" name="delay_date" value="'.date("Y-m-d",$arr['deletion_date']).'"><a href="javascript:show_calendar(\'document.cal.delay_date\',document.cal.delay_date.value,\''.util_get_css_theme().'\',\''.util_get_dir_image_theme().'\');"><img src="'.util_get_image_theme("calendar/cal.png").'"  border="0"></a>',
					    '<a href="javascript: var delay = document.cal.delay_date.value; document.location=\'/tracker/admin/restore.php?func=delay&group_id='.$arr['group_id'].'&atid='.$arr['group_artifact_id'].'&delay_date=\'+delay;"><img src="'.util_get_image_theme("ic/save16b.png").'" border="0" onClick="return confirm(\''.$Language->getText('tracker_include_type','delay_deletion').'\')"></a>',
					    "<a href=\"/tracker/admin/restore.php?func=restore&group_id=".$arr['group_id']."&atid=".$arr['group_artifact_id']."\"><img src=\"".util_get_image_theme("ic/convert.png")."\" border=\"0\" onClick=\"return confirm('".$Language->getText('tracker_include_type','restore')."')\"></a>",
					    "<a href=\"/tracker/admin/restore.php?func=delete&group_id=".$arr['group_id']."&atid=".$arr['group_artifact_id']."\"><img src=\"".util_get_image_theme("ic/trash.png")."\" border=\"0\" onClick=\"return confirm('".$Language->getText('tracker_include_type','warning')."')\"></a>" );
			$i=0;
			}
		    // final touch...
		    echo "</TABLE></form>";
		}
	}
	
	/**
	 *  Display the different options and the trackers lists
	 *
	 *  @return void
	 */
	function displayAdminTrackers() {
		global $atf,$Language;
				
		// Get the artfact type list
		$at_arr = $atf->getArtifactTypes();
		
		if (!$at_arr || count($at_arr) < 1) {
			echo $Language->getText('tracker_index','no_accessible_trackers',"/tracker/admin/?group_id=$group_id");
		} else {
		    echo '<H2>'.$Language->getText('tracker_admin_trackers','all_admin').'</H2>';
			echo '<H3><a href="/tracker/admin/?group_id='.$this->Group->getID().'&func=create">'.$Language->getText('tracker_index','create_new_tracker').'</a></H3>';
			echo $Language->getText('tracker_include_type','create_from_scratch');
			echo '<H3>'.$Language->getText('tracker_include_type','manage').'</H3>';
			echo $Language->getText('tracker_include_type','admin_or_del').'<p>';

			$title_arr=array();
			$title_arr[]=$Language->getText('tracker_include_report','id');
			$title_arr[]=$Language->getText('tracker_import_admin','tracker');
			$title_arr[]=$Language->getText('tracker_include_artifact','desc');
                        if ($this->Group->getID()==100) 
			        $title_arr[]=$Language->getText('tracker_include_type','instantiate').'?';
			$title_arr[]=$Language->getText('tracker_include_canned','delete');
			echo html_build_list_table_top ($title_arr);
		
                        if ($this->Group->getID()==100) {
                            // Add an additional column 'Instantiate for new projects'
			    $fmt = "\n".'<TR class="%s"><td>%s</td><td>%s</td><td>%s</td><td align="center">%s</td>'.
			    '<td align="center">%s</td></tr>';
                        } else {
			    $fmt = "\n".'<TR class="%s"><td>%s</td><td>%s</td><td>%s</td>'.
			    '<td align="center">%s</td></tr>';
                        }
			for ($i = 0; $i < count($at_arr); $i++) {
                            if ($this->Group->getID()==100) {
			       echo sprintf($fmt,
					    util_get_alt_row_color($i),
					    "<a href=\"/tracker/admin/?group_id=".$this->Group->getID()."&atid=".$at_arr[$i]->getID()."\">".$at_arr[$i]->getID()."</a>",
					    $at_arr[$i]->getName(),
					    $at_arr[$i]->getDescription().'&nbsp;',
                                            ($at_arr[$i]->isInstantiatedForNewProjects()?'Yes':'No'),
					    "<a href=\"/tracker/admin/?func=delete_tracker&group_id=".$this->Group->getID()."&atid=".$at_arr[$i]->getID()."\"><img src=\"".util_get_image_theme("ic/trash.png")."\" border=\"0\" onClick=\"return confirm('".$Language->getText('tracker_include_type','warning')."')\"></a>" );

			    } else {
                                echo sprintf($fmt,
					    util_get_alt_row_color($i),
					    "<a href=\"/tracker/admin/?group_id=".$this->Group->getID()."&atid=".$at_arr[$i]->getID()."\">".$at_arr[$i]->getID()."</a>",
					    $at_arr[$i]->getName(),
					    $at_arr[$i]->getDescription().'&nbsp;',
					    "<a href=\"/tracker/admin/?func=delete_tracker&group_id=".$this->Group->getID()."&atid=".$at_arr[$i]->getID()."\"><img src=\"".util_get_image_theme("ic/trash.png")."\" border=\"0\" onClick=\"return confirm('".$Language->getText('tracker_include_type','warning')."')\"></a>" );
                            }
			}
		    // final touch...
		    echo "</TABLE>";
		}
	}
	
	/**
	 *  Display the different options for administrate a tracker
	 *
	 *  @return void
	 */
	function displayAdminTracker($group_id,$atid) {
	  global $Language;
	    echo '<H2>'.$Language->getText('tracker_import_admin','tracker').' \'<a href="/tracker/?group_id='.$group_id.'&atid='.$atid.'&func=browse">'.$this->getName().'</a>\''.$Language->getText('tracker_include_type','administration').'</H2>';

	    if ( $this->userIsAdmin() ) {
			echo '<H3><a href="/tracker/admin/?group_id='.$group_id.'&atid='.$atid.'&func=editoptions">'.$Language->getText('tracker_include_type','settings').'</a></H3>';
			echo $Language->getText('tracker_include_type','define_title');
			echo '<H3><a href="/tracker/admin/?func=field_usage&group_id='.$group_id.'&atid='.$atid.'">'.$Language->getText('tracker_include_type','mng_field_usage').'</a></H3>';
			echo $Language->getText('tracker_include_type','define_use');
			echo '<H3><a href="/tracker/admin/?func=field_values&group_id='.$group_id.'&atid='.$atid.'">'.$Language->getText('tracker_include_type','mng_field_values').'</a></H3>';
			echo $Language->getText('tracker_include_type','define_values');
			echo '<H3><a href="/tracker/admin/?group_id='.$group_id.'&atid='.$atid.'&func=canned">'.$Language->getText('tracker_include_type','mng_response').'</a></H3>';
			echo $Language->getText('tracker_include_type','add_del_resp');
		}

		echo '<H3><a href="/tracker/admin/?func=report&group_id='.$group_id.'&atid='.$atid.'">'.$Language->getText('tracker_include_type','mng_reports').'</a></H3>';
		echo $Language->getText('tracker_include_type','define_reports');
				
		echo '<H3><a href="/tracker/admin?func=notification&group_id='.$group_id.'&atid='.$atid.'">'.$Language->getText('tracker_include_type','mail_notif').'</a></H3>';
		echo $Language->getText('tracker_include_type','define_notif');
	}

	/**
	 *  Display the select box with the permissions values
	 *
	 *  @return void
	 */
	function displayPermValues($i,$perm_level) {
	  global $Language;

		$out = '<FONT size="-1"><SELECT name="user_name['.$i.']">';
		$out .= '<OPTION value="0"'.(($perm_level==0)?" selected":"").'>'.$Language->getText('global','none');
		$out .= '<OPTION value="1"'.(($perm_level==1)?" selected":"").'>'.$Language->getText('tracker_include_type','tech_only');
		$out .= '<OPTION value="2"'.(($perm_level==2)?" selected":"").'>'.$Language->getText('tracker_include_type','tech_admin');
		$out .= '<OPTION value="3"'.(($perm_level==3)?" selected":"").'>'.$Language->getText('tracker_include_type','admin_only');
		$out .= '</SELECT></FONT>';
		
		return $out;
	}

	/**
	 *  Display the users permissions for this tracker
	 *
	 *  @return void
	 */
	function displayUsersPerm() {
		
	  global $Language;

	    $result=$this->getUsersPerm($this->getID());
	    $rows=db_numrows($result);
	
	    if ($rows > 0) {
	
			$title_arr=array();
			$title_arr[]=$Language->getText('tracker_include_type','user');
			$title_arr[]=$Language->getText('tracker_include_type','perm');
			$title_arr[]=$Language->getText('tracker_include_canned','delete');
					
			echo html_build_list_table_top ($title_arr);
		
			for ($i=0; $i < $rows; $i++) {
				$user_id = db_result($result, $i, 'user_id');
			    $user_name = db_result($result, $i, 'user_name');
			    $perm_level =  db_result($result, $i, 'perm_level');
		
			    echo '<TR class="'. util_get_alt_row_color($i).'">'.
			    	 '<TD>'.util_user_link($user_name).'</TD>';
				echo '<TD align="center">'.$this->displayPermValues($i,$perm_level).'</TD>';
				echo '<TD align="center"><a href="/tracker/admin/?group_id='.$this->Group->getID().'&atid='.$this->getID().'&func=deleteuser&user_id='.$user_id.'"><img src="'.util_get_image_theme("ic/trash.png").'" border="0" onClick="return confirm(\''.$Language->getText('tracker_include_type','del_user').'\')"></a></TD>';
				echo '</TR>';
			}
			echo '</TABLE>';
		} else {
			echo '<H3>'.$Language->getText('tracker_include_type','no_user').'</H3>';
		}
		
	}
	
	/**
	 *  Display a selectbox for the user members
	 *
	 *  @return void
	 */
	function displayGroupUsers() {
	    $result=$this->getGroupMembers();
	    $rows=db_numrows($result);
	
		echo '<SELECT name="user_id">';
		for ($i=0; $i < $rows; $i++) {
			$user_id = db_result($result, $i, 'user_id');
		    $user_name = db_result($result, $i, 'user_name');
			echo '<OPTION value="'.$user_id.'">'.$user_name.'</OPTION>';
		}
		echo '</SELECT>';

	}
	
	/**
	 *  Display the differents options for this tracker
	 *
	 *  @return void
	 */
	function displayOptions($group_id,$atid) {
	  global $Language;

		echo '<H2>'.$Language->getText('tracker_import_admin','tracker').' \'<a href="/tracker/admin/?group_id='.$group_id.'&atid='.$atid.'">'.$this->getName().'</a>\' - '.$Language->getText('tracker_include_type','settings').'</H2>';
		echo '<form name="form1" >
		  <input type="hidden" name="update" value="1">
		  <input type="hidden" name="group_id" value="'.$group_id.'">
		  <input type="hidden" name="atid" value="'.$atid.'">
		  <input type="hidden" name="func" value="editoptions">
		  <table width="100%" border="0" cellpadding="5">
		    <tr> 
		      <td width="21%"><b>'.$Language->getText('tracker_include_artifact','name').'</b> <font color="red">*</font>:</td>
		      <td width="79%"> 
		        <input type="text" name="name" value="'.$this->getName().'">
		      </td>
		    </tr>
		    <tr> 
		      <td width="21%"><b>'.$Language->getText('tracker_include_artifact','desc').'</b>: <font color="red">*</font></td>
		      <td width="79%"> 
		        <textarea name="description" rows="3" cols="50">'.$this->getDescription().'</textarea>
		      </td>
		    </tr>
		    <tr> 
		      <td width="21%"><b>'.$Language->getText('tracker_include_type','short_name').'</b>: <font color="red">*</font></td>
		      <td width="79%"> 
		        <input type="text" name="itemname" value="'.$this->getItemName().'">
		      </td>
		    </tr>
		    <tr> 
		      <td width="21%"><b> '.$Language->getText('tracker_include_type','public_tracker').'</b></td>
		      <td width="79%"> ';
		if ( $this->isPublic() ) {
			echo '<input type="checkbox" name="is_public" value="1" checked>';
		} else {
			echo '<input type="checkbox" name="is_public" value="1">';
		}
		echo '			
		      </td>
		    </tr>
		    <tr> 
		      <td width="21%"><b>'.$Language->getText('tracker_include_type','allow_anon').'</b></td>
		      <td width="79%">';
		if ( $this->allowsAnon() ) {
			echo '<input type="checkbox" name="allow_anon" value="1" checked>';
		} else {
			echo '<input type="checkbox" name="allow_anon" value="1">';
		}
		echo '	
		      </td>
		    </tr>
		    <tr>';

		if ( $this->Group->getID()==100 ) { // Template group
		echo '	
		    <tr> 
		      <td width="21%"><b>'.$Language->getText('tracker_include_type','instantiate').':</b></td>
		      <td width="79%">';
		if ( $this->isInstantiatedForNewProjects() ) {
			echo '<input type="checkbox" name="instantiate_for_new_projects" value="1" checked>';
		} else {
			echo '<input type="checkbox" name="instantiate_for_new_projects" value="1">';
		}
		echo '	
		      </td>
		    </tr>';
                } else {
                    echo '<input type="hidden" name="instantiate_for_new_projects" value="0">';
                }
		echo '	
		    <tr> 
		      <td width="21%">'.$Language->getText('tracker_include_type','submit_instr').'</td>
		      <td width="79%"> 
		        <textarea name="submit_instructions" rows="3" cols="50">'.$this->getSubmitInstructions().'</textarea>
		      </td>
		    </tr>
		    <tr> 
		      <td width="21%">'.$Language->getText('tracker_include_type','browse_instr').'</td>
		      <td width="79%"> 
		        <textarea name="browse_instructions" rows="3" cols="50">'.$this->getBrowseInstructions().'</textarea>
		      </td>
		    </tr>
		  </table>
		  <p align="center"><input type="submit" value="'.$Language->getText('global','btn_submit').'"></p>
		</form>';
	}


	/**
	 *  Display a select box for the tracker list for a group
	 *
	 *  @param group_id: the project id
	 *  @param name: the select box name
	 *  @param checked: the default value
	 * 
	 *  @return void
	 */
	function trackersSelectBox ($group_id,$name,$checked='xzxz') {
		global $atf;
		
		return html_build_select_box ($atf->getArtifactTypesFromId($group_id),$name,$checked);
	}

	/**
	 *  Display the create tracker form
	 *
	 *  @param group_id: the group id
	 *  @param codex_template: the artifact type id chosen for a CodeX template
	 *  @param group_id_template: the group id chosen for an existing tracker
	 *  @param atid_template: the artifact type id chosen for an existing tracker
	 *  @param name: the name chosen
	 *  @param description: the description chosen
	 *  @param itemname: the short name chosen
	 *  @param feedback: the error or info message
	 *
	 *  @return void
	 */
	function displayCreateTracker($group_id,$codex_template,$group_id_template,$atid_template,$name,$description,$itemname,$feedback) {
	  global $Language;

		echo '<script language="JavaScript">
		      function trimStr(value) {
		      	trimValue = "";
		      	for(i=0;i<value.length;i++) {
		      		if ( value.charAt(i) != " " ) {
		      			trimValue = trimValue + value.charAt(i);
		      		}
		      	}
		      	return trimValue;
		      }
		    
			  function onChangeGroup() {
			  	document.form_create.func.value = "create";
			  	document.form_create.submit();
			  }
			  
			  function checkValues() {
			  	if ( trimStr(document.form_create.name.value) == "" ) {
		  			document.form_create.feedback.value = "'.$Language->getText('tracker_include_type','fill_name').'";
		  			return false;
				}
			  	if ( trimStr(document.form_create.description.value) == "" ) {
		  			document.form_create.feedback.value = "'.$Language->getText('tracker_include_type','fill_desc').'";
		  			return false;
				}
			  	if ( trimStr(document.form_create.itemname.value) == "" ) {
		  			document.form_create.feedback.value = "'.$Language->getText('tracker_include_type','fill_short').'";
		  			return false;
				}
	  			return true;
				
			  }
			
			  function onSubmitCreateTemplate() {
			  	if ( checkValues() ) {
			  		if ( (document.form_create.group_id_template.value == "")||(document.form_create.atid_template.value == "") ) {
			  			document.form_create.feedback.value = "'.$Language->getText('tracker_include_type','choose_proj').'";
					  	document.form_create.func.value = "create";
			  		}
			  		document.form_create.atid_chosen.value = document.form_create.atid_template.value;
			  		document.form_create.group_id_chosen.value = document.form_create.group_id_template.value;
				} else {
				  	document.form_create.func.value = "create";
				}
			  	document.form_create.submit();
			  }

			  function onSubmitCreateCodeXTemplate() {
			  	if ( checkValues() ) {
			  		if ( document.form_create.codex_template.value == 100 ) {
			  			document.form_create.feedback.value = "'.$Language->getText('tracker_include_type','choose_tmpl').'";
					  	document.form_create.func.value = "create";
			  		}
			  		document.form_create.atid_chosen.value = document.form_create.codex_template.value;
			  		document.form_create.group_id_chosen.value = 100;
				} else {
				  	document.form_create.func.value = "create";
				}
			  	document.form_create.submit();
			  }

			  function showGroupSelection() {
			  	win=window.open("","group_id_selection","height=210,width=480,toolbar=no,location=no,resizable=yes,left=200,top=200");
				win.location = "/tracker/group_selection.php?opener_form=form_create&opener_field=group_id_template&filter=member";
			  }

			  function showTrackerSelection() {
			  	if ( document.form_create.group_id_template.value == "" ) {
			  		alert("'.$Language->getText('tracker_include_type','select_proj').'");
			  		return;
			  	}
			  	win=window.open("","artifact_group_id_selection","height=45,width=200,toolbar=no,location=no,resizable=yes,left=200,top=200");
				win.location = "/tracker/tracker_selection.php?group_id=" + document.form_create.group_id_template.value + "&opener_form=form_create&opener_field=atid_template";
			  }

			  </script>
			 ';
		echo $Language->getText('tracker_include_type','create_tracker');
		echo '<form name="form_create" >
		  <input type="hidden" name="group_id" value="'.$group_id.'">
		  <input type="hidden" name="func" value="docreate">
		  <input type="hidden" name="atid_chosen" value="">
		  <input type="hidden" name="group_id_chosen" value="">
		  <input type="hidden" name="feedback" value="">
		  <table width="100%" border="0" cellpadding="5">
		    <tr> 
		      <td width="21%"><b>'.$Language->getText('tracker_include_artifact','name').'</b>: <font color="red">*</font></td>
		      <td width="79%"> 
		        <input type="text" name="name" value="'.$name.'">
		      </td>
		    </tr>
		    <tr> 
		      <td width="21%"><b>'.$Language->getText('tracker_include_artifact','desc').'</b>: <font color="red">*</font></td>
		      <td width="79%"> 
		        <textarea name="description" rows="3" cols="50">'.$description.'</textarea>
		      </td>
		    </tr>
		    <tr> 
		      <td width="21%"><b>Short name</b>: <font color="red">*</font></td>
		      <td width="79%"> 
		        <input type="text" name="itemname" value="'.$itemname.'">
		      </td>
		    </tr>
                    <tr><td colspan=2><i>'.$Language->getText('tracker_include_type','avoid_spaces').'</i>'.help_button('ArtifactUpdate.html#ArtifactCrossReferencing').'</td></tr>';
		echo '</table>';
		echo '<p>'.$Language->getText('tracker_include_type','choose_creation').'</p>';
		echo '<table>
			  <tr valign="top">
			     <td width="300"><li><b>'.$Language->getText('tracker_include_type','from_tmpl').'</b></li></td>
			     <td colspan="2">';
		echo $this->trackersSelectBox(100,"codex_template");
		echo '	 &nbsp;<input type="button" name="CreateCodeXTemplate" value="'.$Language->getText('global','btn_create').'" onClick="onSubmitCreateCodeXTemplate()"><br><br></td>
			  <tr valign="top">    
			     <td width="300"><li>'.$Language->getText('tracker_include_type','from_exist').'</li></td>
			     
			     <td>
			     	<table>
			     	  <tr>
			     	  	<td>'.$Language->getText('tracker_include_type','proj_id').'</td>
			     		<td><input name="group_id_template" value=""><a href="javascript:showGroupSelection()"><img src="'.util_get_image_theme("button_choose.png").'" align="absmiddle" border="0"></a></td>
			     	  </tr>
			     	  <tr>
				        <td>'.$Language->getText('tracker_include_type','tracker_id').'</td>
			     		<td><input name="atid_template" value=""><a href="javascript:showTrackerSelection()"><img src="'.util_get_image_theme("button_choose.png").'" align="absmiddle" border="0"></a></td>
					  <tr>
					</table>
				 </td>			     		
		         <td><input type="button" name="CreateTemplate" value="'.$Language->getText('global','btn_create').'" onClick="onSubmitCreateTemplate()"></td>
		      <tr>';

	    echo '</form>
			  </table>';
		
	}

	/**
	 *  Display the field usage list
	 *
	 *  @return void
	 */
	function displayFieldUsageList() {
		global $ath,$art_field_fact,$PHP_SELF,$Language;
		
		echo '<h3>'.$Language->getText('tracker_include_type','list_all_fields').'</h3>';
		echo '<p>'.$Language->getText('tracker_include_report','mod');
		
		
		// Show all the fields currently available in the system
		$i=0;
		$title_arr=array();
		$title_arr[]=$Language->getText('tracker_include_report','field_label');
		$title_arr[]=$Language->getText('tracker_include_type','type');
		$title_arr[]=$Language->getText('tracker_include_artifact','desc');
		$title_arr[]=$Language->getText('tracker_include_type','rank_screen');
		$title_arr[]=$Language->getText('tracker_include_type','status');
		$title_arr[]=$Language->getText('tracker_include_canned','delete');
		
		echo html_build_list_table_top ($title_arr);
		
		// Build HTML ouput for  Used fields
		$iu=0;
		$fields = $art_field_fact->getAllUsedFields();
		$html = "";
		
		while (list($field_name,$field) = each($fields)) {
		
		    $rank = ($field->getPlace()?$field->getPlace():"-");
		    $status = ($field->getUseIt()?$Language->getText('tracker_include_type','used'):$Language->getText('tracker_include_type','unused'));
		
			$html .= '<TR class="'. 
			    util_get_alt_row_color($iu) .'">';
		
		    $html .= '<TD><A HREF="'.$PHP_SELF.'?group_id='.$this->Group->getID()."&atid=".$this->getID().
			'&func=display_field_update&field_id='.$field->getID().'">'.
			$field->getLabel().'</A></td>'.
			"\n<td>".$field->getLabelFieldType().'</td>'.
			"\n<td>".$field->getDescription().'</td>'.
			"\n<td align =\"center\">".$rank.'</td>'.
			"\n<td align =\"center\">".$status.'</td>';
			
			if ( $field->isStandardField() ) {
				// For standard, we can't delete them - Only unused them
		    	$html .= "\n<td align =\"center\">-</td>";
			} else {
		    	$html .= "\n<td align =\"center\"><a href=\"/tracker/admin/?func=field_delete&group_id=".$this->Group->getID()."&atid=".$this->getID()."&field_id=".$field->getID()."\"><img src=\"".util_get_image_theme("ic/trash.png")."\" border=\"0\" onClick=\"return confirm('".$Language->getText('tracker_include_type','warning_loose_data')."')\"></a></td>";
		    }
		
			$html .= "<TR>";
					    			
			$iu++;
		}
		
		// Now print the HTML table
		if ($iu == 0) {
		    echo '<tr><td colspan="4"><center><b>'.$Language->getText('tracker_include_type','no_field_in_use').'</b></center></tr>'.$html;  
		} else {
		    echo '<tr><td colspan="4"><center><b>'.$Language->getText('tracker_include_type','used_field').'</b></center></tr>'.$html;  
		}

		// Build HTML ouput for Unused fields
		$iu=0;
		$fields = $art_field_fact->getAllUnusedFields();
		$html = "";
		
		while (list($field_name,$field) = each($fields)) {
		
		    $rank = ($field->getPlace()?$field->getPlace():"-");
		    $status = ($field->getUseIt()?$Language->getText('tracker_include_type','used'):$Language->getText('tracker_include_type','unused'));
		
			$html .= '<TR class="'. 
			    util_get_alt_row_color($iu) .'">';
		
		    $html .= '<TD><A HREF="'.$PHP_SELF.'?group_id='.$this->Group->getID()."&atid=".$this->getID().
			'&func=display_field_update&field_id='.$field->getID().'">'.
			$field->getLabel().'</A></td>'.
			"\n<td>".$field->getLabelFieldType().'</td>'.
			"\n<td>".$field->getDescription().'</td>'.
			"\n<td align =\"center\">".$rank.'</td>'.
			"\n<td align =\"center\">".$status.'</td>';
			if ( $field->isStandardField() ) {
				// For standard, we can't delete them - Only unused them
		    	$html .= "\n<td align =\"center\">-</td>";
			} else {
			    $html .= "\n<td align =\"center\"><a href=\"/tracker/admin/?func=field_delete&group_id=".$this->Group->getID()."&atid=".$this->getID()."&field_id=".$field->getID()."\"><img src=\"".util_get_image_theme("ic/trash.png")."\" border=\"0\" onClick=\"return confirm('".$Language->getText('tracker_include_type','warning_loose_data')."')\"></a></td>";
			}
		
			$html .= "<TR>";
					    			
			$iu++;
		}
		
		// Now print the HTML table
		if ($iu == 0) {
		    echo '<tr><td colspan="4"><center><b>'.$Language->getText('tracker_include_type','no_unused_field').'</b></center></tr>'.$html;  
		} else {
		    echo '<tr><td colspan="4"><center><b>'.$Language->getText('tracker_include_type','unused_field').'</b></center></tr>'.$html;  
		}

		echo '</TABLE>';
		echo '<hr>';
		
	}
	
	/**
	 *  Display the field type select box
	 *
	 *  @param data_type: the field data type (string, int, flat or date)
	 *  @param display_type: the field display type (select box, text field, ...)
	 *  @param form_name: the HTTP form name
	 *
	 *  @return void
	 */
	function displayFieldType($data_type,$display_type,$form_name) {
	  global $Language;
		
		$af = new ArtifactField();
		
		echo '<script language="JavaScript">

			  function onChangeFieldType(form) {
			  		switch ( form.field_type.value ) {
			  		// Select Box
			  		case "1":
			  			form.data_type.value = '.$af->DATATYPE_INT.';
					  	form.display_type.value = "SB";
					  	form.display_size.value = "N/A";
					  	break;
			  		// Multi Select Box
			  		case "2":
			  			form.data_type.value = '.$af->DATATYPE_INT.';
					  	form.display_type.value = "MB";
					  	form.display_size.value = "N/A";
					  	break;
			  		// TextField
			  		case "3":
			  			form.data_type.value = '.$af->DATATYPE_TEXT.';
					  	form.display_type.value = "TF";
					  	form.display_size.value = "N/A";
					  	break;
			  		// TextArea
			  		case "4":
			  			form.data_type.value = '.$af->DATATYPE_TEXT.';
					  	form.display_type.value = "TA";
					  	form.display_size.value = "60/7";
					  	break;
			  		// DateField
			  		case "5":
			  			form.data_type.value = '.$af->DATATYPE_DATE.';
					  	form.display_type.value = "DF";
					  	form.display_size.value = "N/A";
					  	break;
			  		// FloatField
			  		case "6":
			  			form.data_type.value = '.$af->DATATYPE_FLOAT.';
					  	form.display_type.value = "TF";
					  	form.display_size.value = "N/A";
					  	break;
			  		// IntegerField
			  		case "7":
			  			form.data_type.value = '.$af->DATATYPE_INT.';
					  	form.display_type.value = "TF";
					  	form.display_size.value = "N/A";
					  	break;
					default:
						alert("Unknow field type!");
						break;
			  		}
			  }

			  </script>
			 ';

        echo '<select name="field_type" onChange="onChangeFieldType('.$form_name.')">';
		if ( $data_type&&$display_type ) {
			$selected = "";
			if ( ($data_type == $af->DATATYPE_INT || $data_type == $af->DATATYPE_USER)
				 &&($display_type == "SB") ) 
				$selected = " selected";
			echo '<option value="1"'.$selected.'>'.$Language->getText('tracker_include_type','sb').'</option>';
			
			$selected = "";
			if ( ($data_type == $af->DATATYPE_INT || $data_type == $af->DATATYPE_USER)
				 &&($display_type == "MB") ) 
				$selected = " selected";
			echo '<option value="2"'.$selected.'>'.$Language->getText('tracker_include_type','mb').'</option>';
			
			$selected = "";
			if ( ($data_type == $af->DATATYPE_TEXT)
				 &&($display_type == "TF") ) 
				$selected = " selected";
			echo '<option value="3"'.$selected.'>'.$Language->getText('tracker_include_type','tf').'</option>';
			
			$selected = "";
			if ( ($data_type == $af->DATATYPE_TEXT)
				 &&($display_type == "TA") ) 
				$selected = " selected";
			echo '<option value="4"'.$selected.'>'.$Language->getText('tracker_include_type','ta').'</option>';

			$selected = "";
			if ( ($data_type == $af->DATATYPE_DATE)
				 &&($display_type == "DF") ) 
				$selected = " selected";
			echo '<option value="5"'.$selected.'>'.$Language->getText('tracker_include_type','df').'</option>';

			$selected = "";
			if ( ($data_type == $af->DATATYPE_FLOAT)
				 &&($display_type == "TF") ) {
				$selected = " selected";
			}
			echo '<option value="6"'.$selected.'>'.$Language->getText('tracker_include_type','ff').'</option>';

			$selected = "";
			if ( ($data_type == $af->DATATYPE_INT)
				 &&($display_type == "TF") ) 
				$selected = " selected";
			echo '<option value="7"'.$selected.'>'.$Language->getText('tracker_include_type','if').'</option>';

		} else {
			echo '
			<option value="1">'.$Language->getText('tracker_include_type','sb').'</option>
			<option value="2">'.$Language->getText('tracker_include_type','mb').'</option>
			<option value="3">'.$Language->getText('tracker_include_type','tf').'</option>
			<option value="4">'.$Language->getText('tracker_include_type','ta').'</option>
			<option value="5">'.$Language->getText('tracker_include_type','df').'</option>
			<option value="6">'.$Language->getText('tracker_include_type','ff').'</option>
			<option value="7">'.$Language->getText('tracker_include_type','if').'</option>';
		}
        echo '</select>';
	}

	/**
	 *  Display the field usage add or update form
	 *
	 *  @param func: field_create or field_update
	 *  @param field_id: the field id
	 *  @param field_name: the field name
	 *  @param description: the field description
	 *  @param label: the field label
	 *  @param data_type: the field data type (string, int, flat or date)
	 *  @param default_value: the default value
	 *  @param display_type: the field display type (select box, text field, ...)
	 *  @param display_size: the field display size
	 *  @param rank_on_screen: rank on screen
	 *  @param show_on_add: display this field on the submission form used by project members  
	 *  @param show_on_add_members: display this field on the submission form used by other users 
	 *  @param empty_ok: allow empty fill
	 *  @param keep_history: keep in the history
	 *  @param special: is the field has special process
	 *  @param use_it: this field is used or not
	 *  @param show_use: boolean - display the checkbox for using or not this field
	 *
	 *  @return void
	 */
	function displayFieldUsageForm($func="field_create",$field_id=false,$field_name=false,$description=false,$label=false,$data_type=false,$default_value=false,$display_type=false,
								   $display_size=false,$rank_on_screen=false,$show_on_add=false,$show_on_add_members=false,
								   $empty_ok=false,$keep_history=false,$special=false,$use_it=false,$show_use=false) {
		global $art_field_fact,$Language;
		
		$field = $art_field_fact->getFieldFromId($field_id);

		$af = new ArtifactField();

		if ( $func == "field_create" ) {
			echo '<h3>'.$Language->getText('tracker_include_type','create_field').'</h3>';
			echo '
			  <form name="form_create" method="/tracker/admin/index.php">
			  <input type="hidden" name="func" value="'.$func.'">
			  <input type="hidden" name="group_id" value="'.$this->Group->getID().'">
			  <input type="hidden" name="atid" value="'.$this->getID().'">
			  <input type="hidden" name="field_id" value="">
			  <input type="hidden" name="field_name" value="">
			  <input type="hidden" name="data_type" value="'.$af->DATATYPE_INT.'">
			  <input type="hidden" name="display_type" value="SB">';
		} else {
			echo "<h3>".$Language->getText('tracker_include_type','upd_label',$label)."</h3>";
			echo '
			  <form name="form_create" method="/tracker/admin/index.php">
			  <input type="hidden" name="func" value="'.$func.'">
			  <input type="hidden" name="group_id" value="'.$this->Group->getID().'">
			  <input type="hidden" name="atid" value="'.$this->getID().'">
			  <input type="hidden" name="field_id" value="'.$field_id.'">
			  <input type="hidden" name="field_name" value="'.$field_name.'">
			  <input type="hidden" name="data_type" value="'.$data_type.'">
			  <input type="hidden" name="display_type" value="'.$display_type.'">';
		}
		
		if ( $field && $field->isStandardField() ) {
			echo '<p><i>'.$Language->getText('tracker_include_type','imp_note',$field->getLabel()).'</i></p>';
		}
	
		echo '
		  <b>'.$Language->getText('tracker_include_type','field_ident').'</b> ';
		echo  help_button('TrackerAdministration.html#CreationandModificationofaTrackerField');
		echo '
                              <p>'.$Language->getText('tracker_include_report','field_label').': <font color="red">*</font> ';
		      
		if ( $label ) {
			echo '<input type="text" name="label" size="30" maxlength="40" value="'.$label.'">';
		} else {
			echo '<input type="text" name="label" size="30" maxlength="40">';
		}
		
		echo '<p>'.$Language->getText('tracker_include_artifact','desc').': ';
		            
		echo '<input type=text name="description" size="70" maxlength="255" value="'.$description.'">';

		
		echo '
		  <p>'.$Language->getText('tracker_include_type','field_type').': <font color="red">*</font>&nbsp;';
		
		if ( $field && $field->isStandardField() ) {
			echo $field->getLabelFieldType();
		} else {
			$this->displayFieldType($data_type,$display_type,"form_create");
		}
		
		echo '			
		  <p><b>'.$Language->getText('tracker_include_type','display_info').' </b>';
		echo  help_button('TrackerAdministration.html#CreationandModificationofaTrackerField');
		echo'
                                <table width="100%" border="0" cellpadding="5" cellspacing="0">
		    <tr> 
		      <td>'.$Language->getText('tracker_include_type','display_size').':&nbsp;';
		      
		if ( $display_size ) {
		  echo '<input type="text" name="display_size" size="7" maxlength="7" value="'.$display_size.'">';
		} else {
		  echo '<input type="text" name="display_size" size="7" maxlength="7" value="N/A">';
		}
			    
	    echo '
		      </td>
		      <td rowspan="2">'.$Language->getText('tracker_include_type','display_field').'<br>
                                    <ul>
		        <li>'.$Language->getText('tracker_include_type','sub_form_proj').' ';
		        
		if ( $show_on_add_members ) {
			echo '<input type="checkbox" name="show_on_add_members" value="1" checked>';
		} else {
			echo '<input type="checkbox" name="show_on_add_members" value="1">';
		}
		
		echo '
		        </li>
		        <li>'.$Language->getText('tracker_include_type','sub_form_other');
		        
		if ( $show_on_add ) {
			echo '<input type="checkbox" name="show_on_add" value="1" checked>';
		} else {
			echo '<input type="checkbox" name="show_on_add" value="1">';
		}		
		
		echo '
		        </li></ul>
		      </td>
		    </tr>
		    <tr> 
		      <td>'.$Language->getText('tracker_include_type','rank_screen').':&nbsp;';
		      
		if ( $rank_on_screen ) {
	        echo '<input type="text" name="rank_on_screen" size="5" maxlength="5" value="'.$rank_on_screen.'">';
	    } else {
	        echo '<input type="text" name="rank_on_screen" size="5" maxlength="5">';
	    }
	    
	    echo '
		      </td>
		    </tr>
		  </table>
		  <b>'.$Language->getText('tracker_include_type','misc').'</b>
		  <table width="100%" border="0" cellpadding="5" cellspacing="0">
		    <tr> 
		      <td width="30%">'.$Language->getText('tracker_include_type','allow_empty').': ';
		
		if ( $field && $field->isStandardField() ) {
			if ( $empty_ok ) {
				echo ;
			    echo '<input type="hidden" name="empty_ok" value="1">';
			} else {
				echo $Language->getText('global','no');
			    echo '<input type="hidden" name="empty_ok" value="0">';
			}
		} else {
			if ( $empty_ok ) {
				echo '<input type="checkbox" name="empty_ok" value="1" checked>';
			} else {
				echo '<input type="checkbox" name="empty_ok" value="1">';
			}
		}
				
		echo '
		        </td><td>Keep Change History: ';
		
		if ( $field && $field->isStandardField() ) {
			if ( $keep_history ) {
				echo $Language->getText('global','yes');
			    echo '<input type="hidden" name="keep_history" value="1">';
			} else {
				echo $Language->getText('global','no');
			    echo '<input type="hidden" name="keep_history" value="0">';
			}
		} else {
			if ( $keep_history ) {
				echo '<input type="checkbox" name="keep_history" value="1" checked>';
			} else {
				echo '<input type="checkbox" name="keep_history" value="1">';
			}
		}
				
		echo '
		      </td></tr>';
		      
		if ( $show_use ) {
		    echo  '
		      <tr><td>';
			if ( $use_it == 1 ) {
				echo $Language->getText('tracker_include_type','use_field').': <input type="checkbox" name="use_it" value="1" checked>';
			} else {
				echo $Language->getText('tracker_include_type','use_field').': <input type="checkbox" name="use_it" value="1">';
			}
		    echo  '
		      </tr></td>';
		} else {
			echo '<input type="hidden" name="use_it" value="1">';
		}

		if ( $special ) {
			echo '<input type="hidden" name="special" value="1">';
		} else {
			echo '<input type="hidden" name="special" value="0">';
		}
		
		echo '
		  </table><p>';
		  
		if ( $func == "field_create" ) {
			echo '<input type="submit" name="Submit" value="'.$Language->getText('global','btn_create').'">';
		} else {
			echo '<input type="submit" name="Submit" value="'.$Language->getText('global','btn_update').'">';
		}
		
		echo '    
		  </p>
		</form>
		<p><font color="red">*</font>: '.$Language->getText('tracker_include_type','fields_requ').'</p>';
		
	}

	/**
	 *  Display the field values list for editing the values
	 *
	 *  @return void
	 */
	function displayFieldValuesEditList() {
		global $ath,$art_field_fact,$Language;
		
		echo '<p>'.$Language->getText('tracker_include_report','mod');
		
		
		// Show all the fields currently available in the system
		$i=0;
		$title_arr=array();
		$title_arr[]=$Language->getText('tracker_include_report','field_label');
		$title_arr[]=$Language->getText('tracker_include_artifact','desc');
		
		echo html_build_list_table_top ($title_arr);
		
		// Build HTML ouput for  Used fields
		$iu=0;
		$fields = $art_field_fact->getAllUsedFields();
		$html = "";
		
		while (list($field_name,$field) = each($fields)) {
		
			// Special case for special fields (excluded comment_type_id)
		        // as well as assigned_to and multi_assigned_to
			if ( (($field->getName() != "comment_type_id")&&($field->isSpecial())) ||
			     $field->getName() == "assigned_to" || $field->getName() == "multi_assigned_to") {
				continue;
			}
			
			$html .= '<TR class="'. 
			    util_get_alt_row_color($iu) .'">';
		
		    $html .= '<TD><A HREF="'.$PHP_SELF.'?group_id='.$this->Group->getID()."&atid=".$this->getID().
			'&func=display_field_values&field_id='.$field->getID().'">'.
			$field->getLabel().'</A></td>'.
			"\n<td>".$field->getDescription().'</td>';
		
			$html .= "<TR>";

			$iu++;
		}
		
		// Now print the HTML table
		if ($iu == 0) {
		    echo '<tr><td colspan="4"><center><b>'.$Language->getText('tracker_include_type','no_used_field').'</b></center></tr>';
		} else {
			echo $html;
		}

		echo '</TABLE>';
		echo '<hr>';
		
	}

	/**
	 *  Display the value function form
	 *
	 *  @param field_id: the field id to edit
	 *  @param value_function: the value function to bind to
	 *  @param or_label: display an additionnal label to display "Or ..."
	 *
	 *  @return void
	 */
	function displayValueFunctionForm($field_id,$value_function="",$or_label="") {
	  global $Language;

	    if ( $or_label ) {
	    	echo '<h3>'.$or_label.' '.$Language->getText('tracker_include_type','bind_to_list').' ';
	    } else {
	    	echo '<h3>'.$Language->getText('tracker_include_type','bind_to_list').' ';
	    }
	    echo  help_button('TrackerAdministration.html#TrackerBindingFieldToValueList').'</h3>';
	
	    echo '
	      <FORM ACTION="'.$PHP_SELF.'" METHOD="POST">
	      <INPUT TYPE="HIDDEN" NAME="func" VALUE="update_binding">
	      <INPUT TYPE="HIDDEN" NAME="field_id" VALUE="'.$field_id.'">
	      <INPUT TYPE="HIDDEN" NAME="group_id" VALUE="'.$this->Group->getID().'">
	      <INPUT TYPE="HIDDEN" NAME="atid" VALUE="'.$this->getID().'">
	      '.$Language->getText('tracker_include_type','bind_to').': &nbsp; 
	      <select name="value_function">
	          <option value="">'.$Language->getText('global','none').'</option>';
		        
		if ( $value_function ) {
			$selected = "";
			if ( $value_function == "group_members" ) {
				$selected = " selected";
			}
			echo '<option value="group_members"'.$selected.'>'.$Language->getText('tracker_include_type','group_members').'</option>';
			
			$selected = "";
			if ( $value_function == "artifact_submitters" ) {
				$selected = " selected";
			}
			echo '<option value="artifact_submitters"'.$selected.'>'.$Language->getText('tracker_include_type','submitters').'</option>';

			$selected = "";
			if ( $value_function == "artifact_technicians" ) {
				$selected = " selected";
			}
			echo '<option value="artifact_technicians"'.$selected.'>'.$Language->getText('tracker_include_type','techicians').'</option>';

			/*
			 * @author: Manuel VACELET
			 * Add for user group binding 
			 */
			$ugroup_res = ugroup_db_get_existing_ugroups($this->Group->getID());
			$rows = db_numrows($ugroup_res);
			for($i=0;$i<$rows;$i++) {
			  $ug = db_result($ugroup_res, $i,'ugroup_id');
			  $selected = "";
			  if ( $value_function == "ugroup_".$ug) {
			    $selected = " selected";
			  }
			  echo '<option value="ugroup_'.$ug.'"'.$selected.'>'.db_result($ugroup_res, $i, 'name').'</option>';
			}

		} else {
			echo '
		          <option value="group_members">'.$Language->getText('tracker_include_type','group_members').'</option>
		          <option value="artifact_submitters">'.$Language->getText('tracker_include_type','submitters').'</option>
		          <option value="artifact_technicians">'.$Language->getText('tracker_include_type','techicians').'</option>';
			$ugroup_res = ugroup_db_get_existing_ugroups($this->Group->getID());
			$rows = db_numrows($ugroup_res);
			for($i=0;$i<$rows;$i++) {
			  echo '<option value="ugroup_'.db_result($ugroup_res, $i,'ugroup_id').'">'.db_result($ugroup_res, $i, 'name').'</option>';			  
			}
		}
		
		echo '
		        </select>
	      &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <INPUT TYPE="SUBMIT" NAME="SUBMIT" VALUE="'.$Language->getText('tracker_include_type','bind').'">
	      </FORM>';
		
	}
	
	/**
	 *  Display the field value form
	 *
	 *  @param $func: value_create or value_update
	 *  @param field_id: the field id to edit
	 *  @param value_id: the value id
	 *  @param value: the value 
	 *  @param order_id: rank
	 *  @param status: the field value status (Visible or Hidden)
	 *  @param description: the field value description
	 *
	 *  @return void
	 */
	function displayFieldValueForm($func,$field_id,$value_id=false,$value=false,$order_id=false,$status=false,$description=false) {
		global $PHP_SELF,$Language;
		
		if ( $func == "value_create" ) {
			echo '<h3>'.$Language->getText('tracker_include_type','create_value').' '.help_button('TrackerAdministration.html#TrackerCreatingaTrackerFieldValue').'</h3>';
		} else {
			echo '<h3>'.$Language->getText('tracker_include_type','update_value').' '.help_button('TrackerAdministration.html#TrackerUpdatingaTrackerFieldValue').'</h3>';
		}
					
		echo '
	      <FORM ACTION="'.$PHP_SELF.'" METHOD="POST">
	      <INPUT TYPE="HIDDEN" NAME="func" VALUE="'.$func.'">
	      <INPUT TYPE="HIDDEN" NAME="field_id" VALUE="'.$field_id.'">
	      <INPUT TYPE="HIDDEN" NAME="group_id" VALUE="'.$this->Group->getID().'">
	      <INPUT TYPE="HIDDEN" NAME="atid" VALUE="'.$this->getID().'">';

		if ( $status == "P" ) {
			echo '<p><i>'.$Language->getText('tracker_include_type','note_standard').'</i></p>';
		}

		if ( $func == "value_create" ) {
		    if ( $value_id ) {
		      	echo '<INPUT TYPE="hidden" NAME="value_id" VALUE="'.$value_id.'">';
		    } else {
		      	echo '<INPUT TYPE="hidden" NAME="value_id" VALUE="">';
		    }
		} else {
	      	echo '<INPUT TYPE="hidden" NAME="value_id" VALUE="'.$value_id.'">';
		}

	    echo '  
		  <table width="100%" border="0" cellpadding="5" cellspacing="0">
		    <tr> 
		      <td width="45%">Value: <font color="red">*</font>&nbsp;';

	    if ( $value ) {
	      	echo '<INPUT TYPE="TEXT" NAME="value" VALUE="'.$value.'" SIZE="30" MAXLENGTH="60">';
	    } else {
	      	echo '<INPUT TYPE="TEXT" NAME="value" VALUE="" SIZE="30" MAXLENGTH="60">';
	    }
	    
	    echo '
	    	  </td>
		      <td width="25%">Rank:&nbsp;';
	      
	    if ( $order_id ) {
	    	echo '<INPUT TYPE="TEXT" NAME="order_id" VALUE="'.$order_id.'" SIZE="6" MAXLENGTH="6">';
		} else {
	    	echo '<INPUT TYPE="TEXT" NAME="order_id" VALUE="" SIZE="6" MAXLENGTH="6">';
		}
	    
	    echo '</td>
		      <td width="30%">';
	       
		if ( $func == "value_update" ) {
			if (( $status == "P" ) && ( $this->Group->getID() != 100 ) ) {
                            // Can't change 'Permanent' status unless you're working on the tracker templates (group 100)
                            echo $Language->getText('tracker_include_type','status').': '.$Language->getText('tracker_include_type','permanent');
                            echo '<input type="hidden" name="status" value="P">';
			} else {
				echo $Language->getText('tracker_include_type','status').':&nbsp;
				<select name="status">';
				if ( $status ) {
					$selected = "";
					if ( $status == "A" ) 
						$selected = " selected";
					echo '<option value="A"'.$selected.'>'.$Language->getText('tracker_include_type','active').'</option>';
		
					$selected = "";
					if ( $status == "H" ) 
						$selected = " selected";
					echo '<option value="H"'.$selected.'>'.$Language->getText('tracker_include_type','hidden').'</option>';

                                        if ($this->Group->getID() == 100 ) {
                                            $selected = "";
                                            if ( $status == "P" ) 
						$selected = " selected";
                                            echo '<option value="P"'.$selected.'>'.$Language->getText('tracker_include_type','permanent').'</option>';
                                        }
		
				} else {
					echo '				
				          <option value="A" selected>'.$Language->getText('tracker_include_type','active').'</option>
				          <option value="H">'.$Language->getText('tracker_include_type','hidden').'</option>;';
                                        if ($this->Group->getID() == 100 ) {
                                            echo '				
				          <option value="P">'.$Language->getText('tracker_include_type','permanent').'</option>';
                                        }
				}
				echo '
				</select> ';
			}
		} else {
			echo '&nbsp;</td>';
		}
	
		     
		echo '
		  </tr>
		  <tr>
		     <td colspan="4">'.$Language->getText('tracker_include_artifact','desc').':<BR>';
	     
	    if ( $description ) {
	    	echo '<textarea name="description" rows="2" cols="65">'.$description.'</textarea>';
	   	} else {
	    	echo '<textarea name="description" rows="2" cols="65"></textarea>';
		}
	
		echo '</td>
			</tr>
			</table>
			<p>';
	      
		if ( $func == "value_create" ) {
			echo '<INPUT TYPE="SUBMIT" NAME="SUBMIT" VALUE="'.$Language->getText('global','btn_create').'">';
		} else {
			echo '<INPUT TYPE="SUBMIT" NAME="SUBMIT" VALUE="'.$Language->getText('global','btn_update').'">';
		}

		echo '    
		  </p>
		</form>
		<p><font color="red">*</font>: '.$Language->getText('tracker_include_type','fields_requ').'</p>';
	}
	
	/**
	 *  Display the field values list for a field
	 *
	 *  @param field_id: the field id
	 *
	 *  @return void
	 */
	function displayFieldValuesList($field_id) {
		global $ath,$art_field_fact,$PHP_SELF,$Language;
		
		
		$field = $art_field_fact->getFieldFromId($field_id);
		if ( !$field ) {
			return;
		}

		$values = $field->getFieldValues ($this->getID(),"'A','P'");
		$rows = db_numrows($values);
		
		if (!$values || ($rows == 0)) {
		    echo "\n<H3>".$Language->getText('tracker_include_type','no_values')."</H3>";
		    return;
		} else {
		    echo '<h3>'.$Language->getText('tracker_include_type','exist_values').'</h3>';
		    echo '<p>'.$Language->getText('tracker_include_report','mod');
		}

		
		// Show all the fields currently available in the system
		$i=0;
		$title_arr=array();
		if ( $field->getName() == "severity" ) {
			$title_arr[]=$Language->getText('tracker_include_report','id');
		}
		$title_arr[]=$Language->getText('tracker_include_type','value_label');
		$title_arr[]=$Language->getText('tracker_include_artifact','desc');
		$title_arr[]=$Language->getText('tracker_include_type','rank');
		$title_arr[]=$Language->getText('tracker_include_type','status');
		$title_arr[]=$Language->getText('tracker_include_canned','delete');
		
		echo html_build_list_table_top ($title_arr);
		
		// Build HTML ouput for  Used fields
		$iu=0;
		$html = "";

		while ($row = db_fetch_array($values)) {
		
		    $rank = $row['order_id']?$row['order_id']:"-";
		    $status = $this->getLabelValueStatus($row['status']);
		
			$html .= '<TR class="'. 
			    util_get_alt_row_color($iu) .'">';
		
			if ( $field->getName() == "severity" ) {
				$html .= '<TD align="center">'.$row['value_id'].'</TD>';
			}
		    $html .= '<TD><A HREF="'.$PHP_SELF.'?group_id='.$this->Group->getID()."&atid=".$this->getID().
			'&func=display_field_value&field_id='.$field->getID().'&value_id='.$row['value_id'].'">'.
			$row['value'].'</A></td>'.
			"\n<td>".$row['description'].'</td>'.
			"\n<td align =\"center\">".$rank.'</td>'.
			"\n<td align =\"center\">".$status.'</td>';
			
			if (( $row['status'] == "P" || $field->getName() == "severity" )
                            &&($this->Group->getID() != 100)){
				// Unable to delete Permanent values, except for values in the tracker templates (for CodeX admins)
		    	$html .= "\n<td align =\"center\">-</td>";
			} else {
		    	$html .= "\n<td align =\"center\"><a href=\"/tracker/admin/?func=value_delete&group_id=".$this->Group->getID()."&atid=".$this->getID()."&field_id=".$field->getID()."&value_id=".$row['value_id']."\"><img src=\"".util_get_image_theme("ic/trash.png")."\" border=\"0\" onClick=\"return confirm('".$Language->getText('tracker_include_type','del_value')."')\"></a></td>";
		    }
		
			$html .= "<TR>";
					    			
			$iu++;
		}
		
		// Now print the HTML table
		if ($iu == 0) {
		    echo '<tr><td colspan="4"><center><b>'.$Language->getText('tracker_include_type','no_active_val').'</b></center></tr>'.$html;  
		} else {
		    echo '<tr><td colspan="4"><center><b>'.$Language->getText('tracker_include_type','active_val').'</b></center></tr>'.$html;  
		}

		// Build HTML ouput for Unused fields
		$iu=0;
		$values = $field->getFieldValues ($this->getID(),"'H'");
		$html = "";
		
		while ($row = db_fetch_array($values)) {
		
		    $rank = $row['order_id']?$row['order_id']:"-";
		    $status = $this->getLabelValueStatus($row['status']);
		
			$html .= '<TR class="'. 
			    util_get_alt_row_color($iu) .'">';
		
			if ( $field->getName() == "severity" ) {
				$html .= '<TD align="center">'.$row['value_id'].'</TD>';
			}

		    $html .= '<TD><A HREF="'.$PHP_SELF.'?group_id='.$this->Group->getID()."&atid=".$this->getID().
			'&func=display_field_value&field_id='.$field->getID().'&value_id='.$row['value_id'].'">'.
			$row['value'].'</A></td>'.
			"\n<td>".$row['description'].'</td>'.
			"\n<td align =\"center\">".$rank.'</td>'.
			"\n<td align =\"center\">".$status.'</td>';

			if ( $row['status'] == "P" || $field->getName() == "severity" ) {
				// Unable to delete Permanent values
		    	$html .= "\n<td align =\"center\">-</td>";
			} else {
		    	$html .= "\n<td align =\"center\"><a href=\"/tracker/admin/?func=value_delete&group_id=".$this->Group->getID()."&atid=".$this->getID()."&field_id=".$field->getID()."&value_id=".$row['value_id']."\"><img src=\"".util_get_image_theme("ic/trash.png")."\" border=\"0\" onClick=\"return confirm('".$Language->getText('tracker_include_type','del_value')."')\"></a>";
		    }
		
			$html .= "<TR>";
					    			
			$iu++;
		}
		
		// Now print the HTML table
		if ($iu == 0) {
		    echo '<tr><td colspan="4"><center><b>'.$Language->getText('tracker_include_type','no_hidden_val').'</b></center></tr>'.$html;
		} else {
		    echo '<tr><td colspan="4"><center><b>'.$Language->getText('tracker_include_type','hidden_val').'</b></center></tr>'.$html;  
		}

		echo '</TABLE>';
		echo '<hr>';
		
	}


	/* 
	 *
	 * displayNotificationForm
	 *
	 * return void
	 *
	 *
	 *
	 */
	
	function displayNotificationForm($user_id) {
	  global $Language;

		// By default it's all 'yes'
		for ($i=0; $i<$this->num_roles; $i++) {
		    $role_label = $this->arr_roles[$i]['role_label'];
		    for ($j=0; $j<$this->num_events; $j++) {
				$event_label = $this->arr_events[$j]['event_label'];
				$arr_notif[$role_label][$event_label] = 1;
				//echo "[$role_label][$event_label] = 1<br>";
		    }
		}
		
		$res_notif = $this->getNotificationWithLabels($user_id);
		while ($arr = db_fetch_array($res_notif)) {
		    $arr_notif[$arr['role_label']][$arr['event_label']] = $arr['notify'];
		}
		
		$group = $this->getGroup();
		$group_artifact_id = $this->getID();
		$group_id = $group->getGroupId();

		echo '<H2>'.$Language->getText('tracker_import_admin','tracker').' \'<a href="/tracker/admin/?group_id='.$group_id.'&atid='.$group_artifact_id.'">'.$this->getName().'</a>\' - '.$Language->getText('tracker_include_type','mail_notif').'</h2>';
		// Build Wachees UI
		$res = $this->getWatchees($user_id);
		$arr_watchees = array();
		while ($row_watchee = db_fetch_array($res)) {
		    $arr_watchees[] = user_getname($row_watchee['watchee_id']);
		}
		$watchees = join(',',$arr_watchees);
		
		echo '
		<FORM action="/tracker/admin" method="get">
		<INPUT type="hidden" name="func" value="notification">
		<INPUT type="hidden" name="atid" value="'.$this->getID().'">
		<INPUT type="hidden" name="group_id" value="'.$group_id.'">';
		
		echo '<h3><a name="GlobalEmailNotification"></a>'.$Language->getText('tracker_include_type','global_mail_notif').' '.
		help_button('TrackerAdministration.html#TrackerGlobalEmailNotification').'</h3>';
		
		if ($this->userIsAdmin()) {
		    echo '
		              <P>'.$Language->getText('tracker_include_type','admin_note').'<BR>
			<BR><INPUT TYPE="TEXT" NAME="new_artifact_address" VALUE="'.$this->getEmailAddress().'" SIZE="55" MAXLENGTH="255"> 
			&nbsp;&nbsp;&nbsp;'.$Language->getText('tracker_include_type','send_all').' <INPUT TYPE="CHECKBOX" NAME="send_all_artifacts" VALUE="1" '. (($this->emailAll())?'CHECKED':'') .'><BR><br>';
		} else {
		    if ($this->getEmailAddress())
				echo '
			              '.$Language->getText('tracker_include_type','admin_conf').' '.
				    $this->getEmailAddress().'
				&nbsp;&nbsp;&nbsp; '.$Language->getText('tracker_include_type','send_all_or_not',($this->emailAll()?$Language->getText('global','yes'):$Language->getText('global','no'))).'<p>';
		    else
				echo '
			                '.$Language->getText('tracker_include_type','admin_not_conf');
		}
		 
		
		echo '<h3>'.$Language->getText('tracker_include_type','perso_mail_notif').'</h3>';
		  
		if ($this->userIsTech()) {
		    // To watch other users you must have at least tech rights on the tracker
		    echo'
		<h4>'.$Language->getText('tracker_include_type','users_to_watch').' '.
		help_button('TrackerAdministration.html#TrackerWatchers').'</h4>
		<P>'.$Language->getText('tracker_include_type','backup_person',$GLOBALS['sys_name']).'
		<p><INPUT TYPE="TEXT" NAME="watchees" VALUE="'.$watchees.'" SIZE="55" MAXLENGTH="255"><br></p>
		';
		
		    $res = $this->getWatchers($user_id);
		    $arr_watchers = array();
		    while ($row_watcher = db_fetch_array($res)) {
				$watcher_name = user_getname($row_watcher['user_id']);
				$watchers .= '<a href="/users/'.$watcher_name.'">'.$watcher_name.'</a>,';
		    }
		    $watchers = substr($watchers,0,-1); // remove extra comma at the end
		    
		    if ($watchers) {
				echo "<p>".$Language->getText('tracker_include_type','watchers',$watchers);
		    } else {
				echo "<p>".$Language->getText('tracker_include_type','no_watcher');
		    }
		    echo '<br><br>';
		}
		
		// Build Role/Event table 
		// Rk: Can't use html_build_list_table_top because of the specific layout
		echo '<h4>'.$Language->getText('tracker_include_type','event_settings').' '.
		help_button('TrackerAdministration.html#TrackerEventRoleBasedEmailNotification').'</h4>
		              <P>'.$Language->getText('tracker_include_type','tune_settings').'<p>';
		
		echo '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<table BORDER="0" CELLSPACING="1" CELLPADDING="2" class="small">
		<tr class="boxtitle">
		    <td colspan="'.$this->num_roles.'" align="center" width="50%"><b>'.$Language->getText('tracker_include_type','role_is').'</b></td>
		    <td rowspan="2" width="50%"><b>&nbsp;&nbsp;&nbsp;'.$Language->getText('tracker_include_type','nofify_me').'</b></td>
		</tr>';
		
		for ($i=0; $i<$this->num_roles; $i++) {
		    echo '<td align="center" width="10%"><b>'.$this->arr_roles[$i]['short_description']."</b></td>\n";
		}
		echo "</tr>\n";
		
		for ($j=0; $j<$this->num_events; $j++) {
		    $event_id = $this->arr_events[$j]['event_id'];
		    $event_label = $this->arr_events[$j]['event_label'];
		    echo "<tr class=\"".util_get_alt_row_color($j)."\">\n";
		    for ($i=0; $i<$this->num_roles; $i++) {
				$role_id = $this->arr_roles[$i]['role_id'];
				$role_label = $this->arr_roles[$i]['role_label'];
				$cbox_name = 'cb_'.$role_id.'_'.$event_id;
				//echo "<BR>$role_label $role_id $event_label $event_id ".$arr_notif['$role_label']['$event_label'];
				if ( (($role_label == 'ASSIGNEE') && !user_ismember($group_id)) ||
				     (($event_label == 'NEW_ARTIFACT') && ($role_label != 'ASSIGNEE') && ($role_label != 'SUBMITTER')) ||
					(($event_label == 'ROLE_CHANGE') && ($role_label != 'ASSIGNEE') && ($role_label != 'CC')) ) {
				    // if the user is not a member then the ASSIGNEE column cannot
				    // be set. If it's not an assignee or a submitter the new_artifact event is meaningless
				    echo '   <td align="center"><input type="hidden" name="'.$cbox_name.'" value="1">-</td>'."\n";
				} else {
				    echo '   <td align="center"><input type="checkbox" name="'.$cbox_name.'" value="1" '.
					($arr_notif[$role_label][$event_label] ? 'checked':'')."></td>\n";
				}
		    }
		    echo '   <td>&nbsp;&nbsp;&nbsp;'.$this->arr_events[$j]['description']."</td>\n";
		    echo "</tr>\n";
		}
		
		echo'
		</table>
		
		<HR>
		<P align="center"><INPUT type="submit" name="submit" value="'.$Language->getText('tracker_include_artifact','submit').'">
		</FORM>';
			
		
	}

	/**
	 *  Display the default value form
	 *
	 *  @param field_id: the field id to edit
	 *  @param default_value: the default value
	 *
	 *  @return void
	 */
	function displayDefaultValueForm($field_id,$default_value) {
		global $ath,$art_field_fact,$PHP_SELF,$Language;
		
		$field = $art_field_fact->getFieldFromId($field_id);
		if ( !$field ) {
			return;
		}

		echo '<h3>'.$Language->getText('tracker_include_type','def_default').' '.help_button('TrackerAdministration.html#TrackerDefiningaDefaultFieldValue').'</h3>';
					
		echo '
	      <FORM ACTION="'.$PHP_SELF.'" METHOD="POST" name="artifact_form">
	      <INPUT TYPE="HIDDEN" NAME="func" VALUE="update_default_value">
	      <INPUT TYPE="HIDDEN" NAME="field_id" VALUE="'.$field_id.'">
	      <INPUT TYPE="HIDDEN" NAME="group_id" VALUE="'.$this->Group->getID().'">
	      <INPUT TYPE="HIDDEN" NAME="atid" VALUE="'.$this->getID().'">
		  <script language="JavaScript" src="/include/calendar.js"></script>';

		if ( $field->isSelectBox() || $field->isMultiSelectBox() ) {
			echo $Language->getText('tracker_include_type','val').': ';
			echo html_build_select_box ($field->getFieldValues($this->getID(),"'A','P'"),"default_value",$default_value);
		} else if ( $field->isDateField() ) {
			echo $Language->getText('tracker_include_type','val').': <INPUT TYPE="text" name="default_value"'.
			' size="10" MAXLENGTH="10" VALUE="'.($default_value?format_date("Y-m-j",$default_value,''):'').'">'.
			'<a href="javascript:show_calendar(\'document.artifact_form.default_value\', document.artifact_form.default_value.value,\''.util_get_css_theme().'\',\''.util_get_dir_image_theme().'\');">'.
			'<img src="'.util_get_image_theme("calendar/cal.png").'" width="16" height="16" border="0" alt="Click Here to Pick up a date"></a>';
		} else {
	      	echo $Language->getText('tracker_include_type','val').': <INPUT TYPE="text" NAME="default_value" VALUE="'.$default_value.'">';
		}

		echo '
		<INPUT type="submit" name="submit" value="'.$Language->getText('global','btn_update').'">
		</form><hr>';
	}

	/**
	 *  Display the default value form for fields having a value function (e.g. group_members, artifact_technicians)
	 *
	 *  @param field_id: the field id to edit
	 *  @param default_value: the default value
	 *  @param show_none,text_none,show_any,text_any,show_value: values used by html_build_select_box function
	 *
	 *  @return void
	 */
	function displayDefaultValueFunctionForm($field_id,$default_value,$show_none=true,$text_none=false,$show_any=false,$text_any=false,$show_value=false) {
		global $ath,$art_field_fact,$PHP_SELF,$Language;
		
		if (!$text_any) $text_any=$Language->getText('global','any');
		if (!$text_none) $text_none=$Language->getText('global','none');

		$field = $art_field_fact->getFieldFromId($field_id);
		if ( !$field ) {
			return;
		}

		echo '<h3>'.$Language->getText('tracker_include_type','def_default').' '.help_button('TrackerAdministration.html#TrackerDefiningaDefaultFieldValue').'</h3>';
					
		echo '
	      <FORM ACTION="'.$PHP_SELF.'" METHOD="POST" name="artifact_form">
	      <INPUT TYPE="HIDDEN" NAME="func" VALUE="update_default_value">
	      <INPUT TYPE="HIDDEN" NAME="field_id" VALUE="'.$field_id.'">
	      <INPUT TYPE="HIDDEN" NAME="group_id" VALUE="'.$this->Group->getID().'">
	      <INPUT TYPE="HIDDEN" NAME="atid" VALUE="'.$this->getID().'">';

		//new stuff by MLS
		$field_value = $field->getDefaultValue();
		$predefinedValues = $field->getFieldPredefinedValues($this->getID());
	
		if ( $field->isSelectBox()) {
			echo html_build_select_box ($predefinedValues,"default_value",$default_value);
	   	} else if ($field->isMultiSelectBox() ) {
			echo html_build_multiple_select_box($predefinedValues,"default_value[]",$default_value,
							($field->getDisplaySize()!=""?$field->getDisplaySize():"6"),
							$show_none,$text_none,$show_any,$text_any,false,'',$show_value);
		} else {
			echo 'Why are we in this case ??';
		}

		echo '
		 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <INPUT type="submit" name="submit" value="'.$Language->getText('global','btn_update').'">
		</form><hr>';
	}

	/**
	 *  Get tha label for a code status
	 *
	 *  @param status: the code status
	 *
	 *  @return string
	 */
	function getLabelValueStatus($status) {
	  global $Language;

		switch ( $status ) {
		case "P":
			return $Language->getText('tracker_include_type','permanent');
		case "A":
			return $Language->getText('tracker_include_type','active');
		case "H":
			return $Language->getText('tracker_include_type','hidden');
		default:
			return $Language->getText('tracker_include_type','unknown_stat').":".$status;
		}
	}

	/**
	 *  Display the reporting main page
	 *
	 *  @return void
	 */
	function reportingMainPage() {
		global $art_field_fact,$Language;
	
		$this->header(array("title"=>$Language->getText('tracker_import_admin','tracker')." '".$this->getName()."' - ".$Language->getText('tracker_include_type','report_system'),
				  'help' => 'TrackerReporting.html'));
	
		echo '<H2>'.$Language->getText('tracker_include_type','tracker_report_syst').'</H2>';
		echo "\n<P>";
		echo "\n<A HREF=\"/tracker?func=reporting&group_id=".$this->Group->getID()."&atid=".$this->getID()."&field=aging\">".$Language->getText('tracker_include_type','aging_rep')."</A><BR>";
	
		$fields = $art_field_fact->getAllUsedFields();
	
		while (list($field_name,$field) = each($fields)	) {
		    if ($field->isSpecial()) { continue;}
	
		    if ($field->isSelectBox()) {
	
			echo "\n<A HREF=\"/tracker?func=reporting&group_id=".$this->Group->getID()."&atid=".$this->getID()."&field=".$field->getID()."\"> ".$this->getItemName()."s by '".$field->getLabel()."'</A><BR>";
		    }
		}
	
		$this->footer(array());
	
	}
	
	/**
	 *  Display the reporting by age
	 *
	 *  @return void
	 */
	function reportingByAge() {
		global $Language;
	
		$this->header(array("title"=>$Language->getText('tracker_import_admin','tracker')." '".$this->getName()."' - ".$Language->getText('tracker_include_type','aging_rep'),
				  'help' => 'TrackerReporting.html'));
	
		
		$closedItems = $this->getArtifactsByAge();
	
	
		echo '<H2>'.$Language->getText('tracker_include_type','tracker_aging_rep').'</H2>';
	
		GraphIt($closedItems['names'], $closedItems['values'],$Language->getText('tracker_include_type','avg_time',$this->getItemName()."s"));
		echo "<P>";
	
		$openItems = $this->getOpenArtifactsByAge();
		
		GraphIt($openItems['names'], $openItems['values'],$Language->getText('tracker_include_type','nb_open',$this->getItemName()."s"));
		$this->footer(array());
	}
	
	/**
	 *  Display the reporting by field
	 *
	 *  @return void
	 */
	function reportingByField($field_id) {
		global $art_field_fact,$Language;
	
		$field = $art_field_fact->getFieldFromId($field_id);
	
		$this->header(array("title"=>$Language->getText('tracker_import_admin','tracker')." '".$this->getName()."' - ".$Language->getText('tracker_include_type','rep_field')." '".$field->getLabel()."'",
				  'help' => 'TrackerReporting.html'));
	
		if ($field->isStandardField()) {
			$openItems = $this->getOpenArtifactsBy($field);
			$allItems = $this->getArtifactsBy($field);
		} else {
			$openItems = $this->getOpenArtifactsByField($field);
			$allItems = $this->getArtifactsByField($field);
		}
	
		echo '<H3>'.$Language->getText('tracker_include_type','open_by',array('\'<a href="/tracker?group_id='.$this->Group->getID().'&atid='.$this->getID().'">'.$this->getName().'</a>\'',$field->getLabel())).'</H3>';
	
		GraphIt($openItems['names'], $openItems['values'],$Language->getText('tracker_include_type','open_by',array($this->getItemName(),$field->getLabel())));
		echo '<H3>'.$Language->getText('tracker_include_type','all_by',array('\'<a href="/tracker?group_id='.$this->Group->getID().'&atid='.$this->getID().'">'.$this->getName().'</a>\'',$field->getLabel())).'</H3>';
	
		GraphIt($allItems['names'], $allItems['values'],$Language->getText('tracker_include_type','all_by',array($this->getItemName(),$field->getLabel())));
		$this->footer(array());
	
	}



	/**
         * Display the artifact to do mass changes
         *
         * @param ro: read only parameter - Display mode or update mode
         * @param pv: printer version
	 * @param query: only in the case of func=masschange, the query that retrieves all the artifacts to be changed
	 * @param $mass_change_ids[]: only in the case of func=masschange_selected, an array containing all the artifact ids to be changed
         *
         * @return void
         */
        function displayMassChange($mass_change_ids=null,$query=null,$art_report_html=null) {
            global $PHP_SELF,$art_field_fact,$sys_datefmt,$sys_max_size_attachment,$Language;
            
            $fields_per_line=2;
            $max_size=40;
            
            $group = $this->getGroup();
            $atid = $this->getID();
            $group_id = $group->getGroupId();

	    if ($query) {
		$art_report_html->getQueryElements($query,$advsrch,$from,$where);
	  	$sql = "select distinct a.artifact_id ".$from." ".$where;
	  	$result = db_query($sql);
		while ($row = db_fetch_array($result)) {
			$mass_change_ids[] = $row['artifact_id'];
		}
	    }
            
	    //if ($mass_change_ids) {
            	echo '<H2>'.$Language->getText('tracker_include_type','changing_items',count($mass_change_ids)).' </H2>';
		reset($mass_change_ids);
		while ( list($key, $val) = each($mass_change_ids)) {
			if ($key == 0) echo "<a href=\"/tracker/?func=detail&group_id=$group_id&aid=$val&atid=$atid\">".$this->getItemName()." #$val</a>";
			if ($key > 0) echo ", <a href=\"/tracker/?func=detail&group_id=$group_id&aid=$val&atid=$atid\"> #$val</a>";
			if ($key == 100) {echo ", .."; break;}
		}


		echo '
	    <br><br>';
                echo '
            <FORM ACTION="'.$PHP_SELF.'" METHOD="POST" enctype="multipart/form-data" NAME="masschange_form">
            <INPUT TYPE="hidden" name="MAX_FILE_SIZE" value="'.$sys_max_size_attachment.'">
            <INPUT TYPE="HIDDEN" NAME="func" VALUE="postmasschange">
            <INPUT TYPE="HIDDEN" NAME="group_id" VALUE="'.$group_id.'">
            <INPUT TYPE="HIDDEN" NAME="atid" VALUE="'.$atid.'">';
		reset($mass_change_ids);
		while (list(,$val) = each($mass_change_ids)) {
			echo '
	    <INPUT TYPE="HIDDEN" NAME="mass_change_ids[]" VALUE="'.$val.'">';	
		}


                echo '
            <TABLE cellpadding="0">';

		//first special case for submitted_by
		$field = $art_field_fact->getFieldFromName('submitted_by');
		$field_html = new ArtifactFieldHtml($field);
		$field_value = $Language->getText('global','unchanged');
                                
                list($sz,) = explode("/",$field->getDisplaySize());
                $label = $field_html->labelDisplay(false,false,!$ro);
                // original submission field must be displayed read-only
                $value = $field_html->display($this->getID(),$field_value,false,false,$ro,false,false,$Language->getText('global','none'),false,'Any',true,'Unchanged');

                echo "\n<TR>";
                echo '
	    <TD valign="middle">'.$label.'&nbsp;</TD>
            <TD valign="middle">'.$value.'&nbsp;</TD>
            <TD colspan="2"><FONT SIZE="-1"><INPUT TYPE="SUBMIT" NAME="SUBMIT" VALUE="'.$Language->getText('tracker_include_type','submit_mass_change').'"></TD>';
            	echo '
            </TR>
            <TR><TD COLSPAN="'.($fields_per_line*2).'">&nbsp</TD></TR>
            <script language="JavaScript" src="/include/calendar.js"></script>';
        
        
                // Now display the variable part of the field list (depend on the project)
        
		$i = 0;            
            	$result_fields = $art_field_fact->getAllUsedFields();
        	while ( list($key, $field) = each($result_fields) ) {
                
                	$field_html = new ArtifactFieldHtml($field);
                
                        // if the field is a special field (except summary and details) 
                        // then skip it.
                        if ( !$field->isSpecial() && $field->getName()!='summary' && $field->getName()!='details') {
                                           
                                // display the artifact field
                                // if field size is greatest than max_size chars then force it to
                                // appear alone on a new line or it won't fit in the page
                                
                                $field_value = $Language->getText('global','unchanged');
                                
                                list($sz,) = explode("/",$field->getDisplaySize());
                                $label = $field_html->labelDisplay(false,false,!$ro);
                                $value = $field_html->display($this->getID(),$field_value,false,false,$ro,false,false,$Language->getText('global','none'),false,$Language->getText('global','any'),true,$Language->getText('global','unchanged'));

                                        
                                // Details field must be on one row
                                if ($sz > $max_size) {
                                        echo "\n<TR>".
                                          '<TD valign="middle">'.$label.'</td>'.
                                          '<TD valign="middle" colspan="'.(2*$fields_per_line-1).'">'.
                                          $value.'</TD>'.                     
                                          "\n</TR>";
                                        $i=0;
                                } else {
                                        echo ($i % $fields_per_line ? '':"\n<TR>");
                                        echo '<TD valign="middle">'.$label.'</td>'.
                                          '<TD valign="middle">'.$value.'</TD>';
                                        $i++;
                                        echo ($i % $fields_per_line ? '':"\n</TR>");
                                }
                        }
                } // while
                          

		echo '
	    </TABLE>
	    <table cellspacing="0">';

		//
                // Followups comments
                //
                echo '
	    <TR><TD colspan="2" align="top"><HR></td></TR>
	    <TR><TD>
            <h3>'.$Language->getText('tracker_import','follow_ups').' '.help_button('ArtifactUpdate.html#ArtifactComments').'</h3></td>
            <TD>
            <INPUT TYPE="SUBMIT" NAME="SUBMIT" VALUE="'.$Language->getText('tracker_include_type','submit_mass_change').'">
            </td></tr>';

                echo '
            <tr><TD colspan="2" align="top">
            <B>'.$Language->getText('tracker_include_artifact','use_canned').'</B>&nbsp;';
                        
                echo $this->cannedResponseBox ();
                        
                echo '
            &nbsp;&nbsp;&nbsp;<A HREF="/tracker/admin/?func=canned&atid='.$atid.'&group_id='.$group_id.'&create_canned=1">'.$Language->getText('tracker_include_artifact','define_canned').'</A>
            </TD></TR>';
                        
                echo '
            <TR><TD colspan="2">';
                        
                $field = $art_field_fact->getFieldFromName('comment_type_id');
                if ( $field ) {
                     $field_html = new ArtifactFieldHtml( $field );
                     echo '<P><B>'.$Language->getText('tracker_include_artifact','comment_type').'</B>'.
                          $field_html->fieldBox('',$atid,$field->getDefaultValue(),true,$Language->getText('global','none')).'<BR>';
                }
                echo '<TEXTAREA NAME="details" ROWS="7" COLS="60" WRAP="SOFT"></TEXTAREA><p>';
                                
        
                echo '</td></tr>';
                
                //
                // CC List
                //
                echo '          
                <TR><TD colspan="2"><hr></td></tr>
                
                <TR><TD colspan="2">
                <h3>'.$Language->getText('tracker_import','cc_list').' '.help_button('ArtifactUpdate.html#ArtifactCCList').'</h3>';
                
                if ( !$ro ) {
                        echo '
                        '.$Language->getText('tracker_include_artifact','codex_user').$Language->getText('tracker_include_artifact','fill_cc_list');
                }
                
	
		
		echo $this->showCCList($mass_change_ids);


                echo '</TD></TR>';
                        
                //
                // File attachments
                //
                echo '
                <TR><TD colspan="2"><hr></td></tr>
                <TR><TD colspan="2">
                <h3>'.$Language->getText('tracker_include_artifact','attachment').' '.help_button('ArtifactUpdate.html#ArtifactAttachments').'</h3>';
                

                echo $Language->getText('tracker_include_artifact','upload',formatByteToMb($sys_max_size_attachment));
                                
		reset($mass_change_ids);
                echo $this->showAttachedFiles($mass_change_ids);
                echo '</TD></TR>';

                //
                // Artifact dependencies
                //
                echo '
                <TR><TD colspan="2"><hr></td></tr>
                <TR ><TD colspan="2">';
                
                echo '<h3>'.$Language->getText('tracker_include_artifact','dependencies').' '.help_button('ArtifactUpdate.html#ArtifactDependencies').'</h3>
                <B>'.$Language->getText('tracker_include_artifact','dependent_on').'</B><BR>
                <P>';
                if ( !$ro ) {
                        echo '
                        <B>'.$Language->getText('tracker_include_artifact','aid').'</B>&nbsp;
                        <input type="text" name="artifact_id_dependent" size="20" maxlength="255">
                        &nbsp;<i>'.$Language->getText('tracker_include_artifact','fill').'</i><p>';
                }
		echo $this->showDependencies($mass_change_ids);

                echo '</TD></TR>';
        	echo '<TR><TD colspan="2"><hr></td></tr>';                        
		echo '</TD></TR>                
                        <TR><TD colspan="2" ALIGN="center">
                                <INPUT TYPE="SUBMIT" NAME="SUBMIT" VALUE="'.$Language->getText('tracker_include_type','submit_mass_change').'">
                                </FORM>
                        </TD></TR>';
                
                echo '</table>';
	}


	/**
	* Show all the cc addresses of all the artifacts in $change_ids
	* @param group_id: the group id
        * @param group_artifact_id: the artifact type ID
	* @param change_ids: all the ids of the artifacts affected
	*/
	function showCCList($change_ids) {
	  global $Language;
		$out = "";
			
		$result = $this->getCC($change_ids);			
		
		if (db_numrows($result) > 0) {
			$title_arr=array();
                        $title_arr[]=$Language->getText('tracker_include_artifact','cc_address');
                        $title_arr[]=$Language->getText('tracker_include_type','occurrence');
                        $title_arr[]=$Language->getText('tracker_include_canned','delete');
                        $out .= html_build_list_table_top ($title_arr);
                
                        $fmt = "\n".'<TR class="%s"><td>%s</td><td align="center">%s</td><td align="center">%s</td></tr>';				

			
			// Loop through the cc and format them
			$email = "";
			$row_color = 0;
			$i = 0;
            		while ($row = db_fetch_array($result)) {
				if ($row['email'] != $email) {
					if ($email != "") {
						$html_delete = '
		<INPUT TYPE="CHECKBOX" NAME="delete_cc[]" VALUE="'.$delete_ids.'">';
						$out .= sprintf($fmt,
                                        		util_get_alt_row_color($row_color),
                                        		$href_cc,
							$i,
                                        		$html_delete);
						$row_color++;
						$i = 0;	
					}
					$email = $row['email'];
					$res_username = user_get_result_set_from_unix($email);
                        		if ($res_username && (db_numrows($res_username) == 1))
                            			$href_cc = util_user_link($email);
                        		else
                            			$href_cc = "<a href=\"mailto:".util_normalize_email($email)."\">".$email.'</a>';
					$delete_ids = $row['artifact_cc_id'];
				} else {
					$delete_ids .= ",".$row['artifact_cc_id'];
				}
				$i++;
			}
			$html_delete = '
		<INPUT TYPE="CHECKBOX" NAME="delete_cc[]" VALUE="'.$delete_ids.'">';
			$out .= sprintf($fmt,
                                        util_get_alt_row_color($row_color),
                                        $href_cc,
					$i,
                                        $html_delete);	
			$out .= "</TABLE>";
            	}
        
            	return($out);
	}

	/**
	* Display the list of attached files of all the artifacts in $change_ids
	* @param group_id: the group id
        * @param group_artifact_id: the artifact type ID
	* @param change_ids: all the ids of the artifacts affected
	*/
	function showAttachedFiles($change_ids) {
	  global $Language;
		$out = "";
		$result = $this->getAttachedFiles($change_ids);		
	
		if (db_numrows($result) > 0) {
			$title_arr=array();
                	$title_arr[]=$Language->getText('tracker_include_artifact','name');
                	$title_arr[]=$Language->getText('tracker_include_artifact','size_kb');
                	$title_arr[]=$Language->getText('tracker_include_type','occurrence');
            		$title_arr[]=$Language->getText('tracker_include_canned','delete');
        
                	$out .= html_build_list_table_top ($title_arr);

			$fmt = "$sys_lf".'<TR class="%s"><td>%s</td><td align="center">%s</td><td align="center">%s</td><td align="center">%s</td></tr>';

			// Loop throuh the attached files and format them
			$i = 0;
			$rowcolor = 0;
			$filename = "";
			$filesize = -1;
			while ($row = db_fetch_array($result)) {
				if ($row['filename'] != $filename || $row['filesize'] != $filesize) {
					if ($filename != "") {
						$html_delete = '
	<INPUT TYPE="CHECKBOX" NAME="delete_attached[]" VALUE="'.$delete_ids.'">';
						$out .= sprintf($fmt,
                                            		util_get_alt_row_color($rowcolor),
                                            		$filename,
                                            		intval($filesize/1024),
							$i,
                                            		$html_delete);
						$i = 0;	
						$rowcolor++;
					}
					$delete_ids = $row['id'];
					$filename = $row['filename'];
					$filesize = $row['filesize'];	
				} else {
					$delete_ids .= ",".$row['id'];						
				}
				$i++;
			}
			$html_delete = '
	<INPUT TYPE="CHECKBOX" NAME="delete_attached[]" VALUE="'.$delete_ids.'">';
			$out .= sprintf($fmt,
                                        util_get_alt_row_color($rowcolor),
                                        $filename,
                                        intval($filesize/1024),
					$i,
                                        $html_delete);	
			$out .= "</TABLE>";	
		}
		return $out;

	}

	/**
         * Display the artifact dependencies list for all artifacts in change_ids 
         *
         * @param change_ids: the artifacts for that we search dependencies
         * @return string
         */
        function showDependencies ($change_ids) {
	  global $Language;
            $result=$this->getDependencies($change_ids);
            $rows=db_numrows($result);
        
            // Nobody in the dependencies list -> return now
            if ($rows > 0) {
            	$title_arr=array();
              	$title_arr[]=$Language->getText('tracker_include_artifact','artifact');
                $title_arr[]=$Language->getText('tracker_include_artifact','summary');
                $title_arr[]=$Language->getText('tracker_import_admin','tracker');
                $title_arr[]=$Language->getText('tracker_import_admin','group');
                $title_arr[]=$Language->getText('tracker_include_type','occurrence');
                $title_arr[]=$Language->getText('tracker_include_canned','delete');
                $out .= html_build_list_table_top ($title_arr);
                
                $fmt = "\n".'<TR class="%s"><td>%s</td><td>%s</td><td align="center">%s</td>'.
                            '<td align="center">%s</td><td align="center">%s</td><td align="center">%s</td></tr>';
                
            	// Loop through the denpendencies and format them
		$occ = 0;
		$dependent_on_artifact_id = -1;
		$row_color = 0;
            	for ($i=0; $i < $rows; $i++) {
        		if ($dependent_on_artifact_id != db_result($result, $i, 'is_dependent_on_artifact_id')) {
				if ($dependent_on_artifact_id != -1) {
					$html_delete = '
	<INPUT TYPE="CHECKBOX" NAME="delete_depend[]" VALUE="'.$depend_ids.'">';
					$out .= sprintf($fmt,
                                            	util_get_alt_row_color($row_color),
                                            	"<a href=\"/tracker/?func=gotoid&group_id=$group_id&aid=$dependent_on_artifact_id\">$dependent_on_artifact_id</a>",
                                            	$summary,
                                            	$tracker_label,
                                            	$group_label,
						$occ,
                                            	$html_delete);
					$row_color++;
					$occ = 0;	
				}
				$dependent_on_artifact_id = db_result($result, $i, 'is_dependent_on_artifact_id');
                        	$summary = db_result($result, $i, 'summary');
                        	$tracker_label = db_result($result, $i, 'name');
                        	$group_label = db_result($result, $i, 'group_name');
				$depend_ids = db_result($result, $i, 'artifact_depend_id');
			} else {
				$depend_ids .= ",".db_result($result, $i, 'artifact_depend_id');
			}
			$occ++;
                } // for
		$html_delete = '
	<INPUT TYPE="CHECKBOX" NAME="delete_depend[]" VALUE="'.$depend_ids.'">';
		$out .= sprintf($fmt,
                                util_get_alt_row_color($row_color),
                                "<a href=\"/tracker/?func=gotoid&group_id=$group_id&aid=$dependent_on_artifact_id\">$dependent_on_artifact_id</a>",
                                $summary,
                                $tracker_label,
                                $group_label,
				$occ,
                                $html_delete);
        
            	// final touch...
            	$out .= "</TABLE>";
            }
        
            return($out);
        }
}

?>
