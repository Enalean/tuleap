<?php
//
// Copyright (c) Xerox Corporation, CodeX Team, 2001-2003. All rights reserved
//
// $Id$
//
//
//	Originally by to the SourceForge Team,1999-2000
//
//  Written for CodeX by Stephane Bouhet
//

//require_once('common/include/Error.class');
require_once('common/tracker/ArtifactType.class');

$Language->loadLanguageMsg('tracker/tracker');

class ArtifactTypeFactory extends Error {

	/**
	 * The Group object.
	 *
	 * @var	 object  $Group.
	 */
	var $Group;

	/**
	 * The ArtifactTypes array.
	 *
	 * @var	 array	ArtifactTypes.
	 */
	var $ArtifactTypes;

	/**
	 *  Constructor.
	 *
	 *	@param	object	The Group object to which this ArtifactTypeFactory is associated
	 *	@return	boolean	success.
	 */
	function ArtifactTypeFactory($Group) {
		$this->Error();
		if ( $Group ) {
			if ($Group->isError()) {
				$this->setError('ArtifactTypeFactory:: '.$Group->getErrorMessage());
				return false;
			}
			$this->Group = $Group;
		}
		
		return true;
	}

	/**
	 *	getGroup - get the Group object this ArtifactType is associated with.
	 *
	 *	@return	object	The Group object.
	 */
	function getGroup() {
		return $this->Group;
	}

	/**
	 *	getStatusIdCount - return a array of each status_id count.
	 *
	 *	@param	group_artifact_id
	 *
	 *	@return	array of counts
	 */
	function getStatusIdCount($group_artifact_id) {
		$count_array=array();
		$sql="select status_id,count(*) from artifact where group_artifact_id = ".$group_artifact_id.
			 " group by status_id";
		$result = db_query ($sql);

		$rows = db_numrows($result);

		if (!$result || $rows < 1) {
			$this->setError('None Found '.db_error());
			return false;
		} else {
			$count_array['count'] = 0;
			while ($arr = db_fetch_array($result)) {
				if ( $arr['status_id'] == 1 ) {
					$count_array['open_count'] = $arr[1];
				}
				$count_array['count'] += $arr[1];
			}
			return $count_array;
		}
	}		

	/**
	 *	getArtifactTypes - return an array of ArtifactType objects of the current group
	 *
	 *	@return	array	The array of ArtifactType objects.
	 */
	function getArtifactTypes() {
	  global $Language;

		if ($this->ArtifactTypes) {
			return $this->ArtifactTypes;
		}

		$sql="SELECT *, 0 as open_count, 0 as count FROM artifact_group_list
			WHERE group_id='". $this->Group->getID() ."'
			AND status != 'D'
			ORDER BY name ASC";

		$result = db_query ($sql);

		$rows = db_numrows($result);

		if (!$result || $rows < 1) {
			$this->setError($Language->getText('tracker_common_type','none_found').' '.db_error());
			return false;
		} else {
			while ($arr = db_fetch_array($result)) {
				// Retrieve status counts
				$arr_count = $this->getStatusIdCount($arr['group_artifact_id']);
				if ( $arr_count ) {
					$arr['open_count'] = array_key_exists('open_count', $arr_count)?$arr_count['open_count']:0;
					$arr['count'] = $arr_count['count'];
				}
                                $new_at=new ArtifactType($this->Group, $arr['group_artifact_id'], $arr);
                                //if ($new_at->userCanView()) {
                                    $this->ArtifactTypes[] = $new_at;
                                    //}
			}
		}
		return $this->ArtifactTypes;
	}

	/**
	 *  getArtifactTypesFromId - return an array of ArtifactType objects of a group
	 *
	 *  @param group_id: the group id
	 *
	 *  @return	array
	 */
	function getArtifactTypesFromId($group_id) {
	  global $Language;

          $sql="SELECT group_artifact_id FROM artifact_group_list
			WHERE group_id='". $group_id ."'
			AND status!='D'
			ORDER BY group_artifact_id ASC";
		
          $result = db_query ($sql);
          $rows = db_numrows($result);
          $myArtifactTypes=array();

          if (!$result || $rows < 1) {
              $this->setError($Language->getText('tracker_common_type','none_found').' '.db_error());
              return false;
          } else {
              while ($arr = db_fetch_array($result)) {
                  $new_at=new ArtifactType(group_get_object($group_id), $arr['group_artifact_id']);
                  if ($new_at->userCanView()) {
                      $myArtifactTypes[] = $new_at;
                  }
              }
          }
          return $myArtifactTypes;
	}
	

	/**
	 *	getPendingArtifactTypes - return an array of ArtifactType objects with 'D' status
	 *
	 *  @aparam group_id: the group id
	 *
	 *	@return	resultSet
	 */
	function getPendingArtifactTypes() {
	  global $Language;

		$sql="SELECT group_artifact_id,name, deletion_date, groups.group_name as project_name, groups.group_id FROM artifact_group_list, groups
			WHERE artifact_group_list.status='D'
			AND groups.group_id=artifact_group_list.group_id
			ORDER BY group_artifact_id ASC";

		//echo $sql;
		
		$result = db_query ($sql);
		$rows = db_numrows($result);
		if (!$result || $rows < 1) {
			$this->setError($Language->getText('tracker_common_type','none_found').' '.db_error());
			return false;
		}

		return $result;
	}
	
	/**
	 *	Delete a tracker
	 *
	 *  @aparam atid: the artifact type id
	 *
	 *	@return	boolean
	 */
	function deleteArtifactType($atid) {
		
		// Delete artifact_canned_responses 
		$sql = "DELETE FROM artifact_canned_responses 
			    WHERE group_artifact_id=". $atid;
		db_query ($sql);

		// Delete artifact_notification  
		$sql = "DELETE FROM artifact_notification  
			    WHERE group_artifact_id=". $atid;
		db_query ($sql);

		// Delete artifact_notification_event   
		$sql = "DELETE FROM artifact_notification_event   
			    WHERE group_artifact_id=". $atid;
		db_query ($sql);
		
		// Delete artifact_notification_role   
		$sql = "DELETE FROM artifact_notification_role   
			    WHERE group_artifact_id=". $atid;
		db_query ($sql);

		// Delete artifact_perm   
		$sql = "DELETE FROM artifact_perm   
			    WHERE group_artifact_id=". $atid;
		db_query ($sql);
		
        
        // We need to instanciate an artifactType to instanciate the factories
        $artifactType = new ArtifactType($this->getGroup(), $atid, false);
        $art_field_fact = new ArtifactFieldFactory($artifactType);
        $art_fieldset_fact = new ArtifactFieldSetFactory($artifactType);

        // Delete the fields of this tracker
        $art_field_fact->deleteFields($atid);
        // Delete the field sets of this tracker
        $art_fieldset_fact->deleteFieldSets();

        
        // Delete the artifact_report
        $art_report_fact = new ArtifactReportFactory();
        $art_report_fact->deleteReports($atid);
        
        // Delete the artifact rules
        $art_rule_fact = ArtifactRuleFactory::instance();
        $art_rule_fact->deleteRulesByArtifactType($atid);
        
        // Delete artifact_watcher (be carefull, the column is named artifact_group_id)
        $sql = "DELETE FROM artifact_watcher   
			    WHERE artifact_group_id=". $atid;
		db_query ($sql);
        
        
		// Delete all records linked to artifact_id
	    $sql_artifacts='SELECT artifact_id '.
		'FROM artifact '.
		'WHERE group_artifact_id='. $atid;
		
		//echo $sql_artifacts;
		
	    $res = db_query($sql_artifacts);
	
	    while ($artifacts_array = db_fetch_array($res)) {
			$id = $artifacts_array["artifact_id"];

			// Delete artifact_cc records	    	
	    	$sql = "DELETE FROM artifact_cc WHERE artifact_id = ".$id;
	    	db_query($sql);
	    	
			// Delete artifact_dependencies records	    	
	    	$sql = "DELETE FROM artifact_dependencies WHERE artifact_id = ".$id;
	    	db_query($sql);

			// Delete artifact_field_value records	    	
	    	$sql = "DELETE FROM artifact_field_value WHERE artifact_id = ".$id;
	    	db_query($sql);
	    	
			// Delete artifact_file records	    	
	    	$sql = "DELETE FROM artifact_file WHERE artifact_id = ".$id;
	    	db_query($sql);

			// Delete artifact_history records	    	
	    	$sql = "DELETE FROM artifact_history WHERE artifact_id = ".$id;
	    	db_query($sql);

			// Delete artifact records	    	
	    	$sql = "DELETE FROM artifact WHERE artifact_id = ".$id;
	    	db_query($sql);

		} // while        

		// Delete artifact_group_list
		$sql = "DELETE FROM artifact_group_list
			    WHERE group_artifact_id=". $atid;
		//echo $sql;
		
		$result = db_query ($sql);

		if (!$result || db_affected_rows($result) <= 0) {
			$this->setError('Error: deleteArtifactType '.db_error());
			return false;
		}
		
        //Remove permissions
        permission_clear_all_tracker($this->Group->getID(), $atid);
        
		return true;
	}
	
	
	/**
	 *	Retrieve the artifacts where user $user_id is a submitter or assignee
     *  By default both are retreived but you can select if you want artifacts
     *  you are assigned or artifact you submitted or both.
	 *
	 *  @param user_id: the user id
	 *  @param view: 1 means assigned, 2 means Submitted, 3 means Both
	 *	@return	db_result
	 */
	function getMyArtifacts($user_id, $view='AS') {
        $assignee = false;
        $submitter = false;

        if(strpos($view, 'A') !== false)
            $assignee = true;

        if(strpos($view, 'S') !== false)
            $submitter = true;

        if(!$assignee && !$submitter)
            return false;
        
        // Only artifacts from active projects are returned.
        
		$sql = 
            "SELECT agl.group_artifact_id,agl.name,".
            "agl.group_id,g.group_name, ".
            "a.summary, a.artifact_id, a.severity, (a.submitted_by=".$user_id.") as submitter , MAX(afv.valueInt=".$user_id.") as assignee ".
            "FROM artifact a, artifact_group_list agl, artifact_field af, artifact_field_value afv, groups g ".
            "WHERE agl.group_id = g.group_id AND af.group_artifact_id = agl.group_artifact_id ".
            "AND agl.status = 'A' ".
            "AND g.status = 'A' ".
            "AND (af.field_name = 'assigned_to' OR af.field_name = 'multi_assigned_to') ".
            "AND af.field_id = afv.field_id ".
            "AND (";
        
        if($assignee) {
            $sql .= "afv.valueInt=".$user_id;
        }
        
        if($submitter) {
            if($assignee) {
                $sql .= " OR ";
            }
            $sql .= "a.submitted_by=".$user_id;
        }

        $sql .= ") ".
            "AND a.group_artifact_id = agl.group_artifact_id AND a.artifact_id = afv.artifact_id AND a.status_id <> 3 ".
            "GROUP BY a.artifact_id ".
            "ORDER BY g.group_name, agl.name";
        
		$res = db_query($sql);
        
	    return $res;
	}

}

?>
