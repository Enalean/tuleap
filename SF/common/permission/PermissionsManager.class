<?php

/**
 * Copyright (c) Xerox Corporation, CodeX Team, 2001-2005. All rights reserved
 * 
 * $Id$
 *
 * PermissionsManager
 */
require_once('common/dao/PermissionsDao.class');
require_once('common/dao/CodexDataAccess.class');

class PermissionsManager {
    
    var $permission_dao;
    var $_permissions;
    var $_ugroups_for_user;
    
    function PermissionsManager($permission_dao) {
        $this->_permission_dao   =& $permission_dao;
        $this->_permissions      = array();
        $this->_ugroups_for_user = array();
    }
    
    function & instance() {
        static $_permissionmanager_instance;
        if (!$_permissionmanager_instance) {
            $dao =& new PermissionsDAO(CodexDataAccess::instance());
            $_permissionmanager_instance = new PermissionsManager($dao);
        }
        return $_permissionmanager_instance;
    }
    
    function userHasPermission($object_id, $permission_type, $ugroups) {
        if (!isset($this->_permissions[$object_id])) {
            $this->_permissions[$object_id] = array();
        }
        if (count(array_diff($ugroups, array_keys($this->_permissions[$object_id]))) > 0) {
            $this->_retrievePermissions($object_id, $ugroups);
        }
        //now we search for $permission_type
        $has_permission = false;
        reset($ugroups);
        while (!$has_permission && (list(,$ugroup) = each($ugroups))) {
            if (isset($this->_permissions[$object_id][$ugroup])) {
                $has_permission = in_array($permission_type, $this->_permissions[$object_id][$ugroup]);
            }
        }
        return $has_permission;
    }
    
    function getPermissionsAndUgroupsByObjectid($object_id, $ugroups) {
        $this->_retrievePermissions($object_id);
        $perms = array();
        if (isset($this->_permissions[$object_id])) {
            foreach($this->_permissions[$object_id] as $ugroup_id => $permissions) {
                foreach($permissions as $perm) {
                    if (!isset($perms[$perm])) {
                        $perms[$perm] = array();
                    }
                    $perms[$perm][] = $ugroup_id;
                }
            }
        }
        return $perms;
    }
    
    function _userHasFullPermission($user_id = 0) {
        return (user_isloggedin() && user_is_super_user());
    }
    
    function _retrievePermissions($object_id, $ugroups = array()) {
        $tracker_field_id = explode('#', $object_id); //An artifact field ?
        if (count($tracker_field_id) > 1) {
            $dar =& $this->_permission_dao->searchPermissionsByArtifactFieldId($tracker_field_id[0]);
        } else {
            $dar =& $this->_permission_dao->searchPermissionsByObjectId($object_id);
        }
        while ($row =& $dar->getRow()) {
            if (!isset($this->_permissions[$row['object_id']])) {
                $this->_permissions[$row['object_id']] = array();
            }
            foreach($ugroups as $ugroup) {
                if (!isset($this->_permissions[$row['object_id']][$ugroup])) {
                    $this->_permissions[$row['object_id']][$ugroup] = array();
                }
            }
            if (!isset($this->_permissions[$row['object_id']][$row['ugroup_id']])) {
                $this->_permissions[$row['object_id']][$row['ugroup_id']] = array();
            }
            if (!in_array($row['permission_type'], $this->_permissions[$row['object_id']][$row['ugroup_id']])) {
                $this->_permissions[$row['object_id']][$row['ugroup_id']][] = $row['permission_type'];
            }
        }
    }
}
?>