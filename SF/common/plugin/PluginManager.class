<?php
require_once('common/event/EventManager.class');

require_once('common/plugin/PluginFactory.class');
require_once('common/plugin/PluginHookPriorityManager.class');

require_once('common/dao/DBTablesDao.class');
require_once('common/dao/CodexDataAccess.class');

require_once('common/include/String.class');

/**
 * Copyright (c) Xerox Corporation, CodeX Team, 2001-2005. All rights reserved
 * 
 * $Id$
 *
 * PluginManager
 */
class PluginManager {
    
    var $plugins_loaded;
    var $pluginHookPriorityManager;
    
    function PluginManager() {
        $this->plugins_loaded = false;
    }
    
    function loadPlugins() {
        $plugin_factory =& $this->_getPluginFactory();
        $event_manager  =& $this->_getEventManager();
        
        $col_enabled_plugins =& $plugin_factory->getEnabledPlugins();
        $enabled_plugins =& $col_enabled_plugins->iterator();
        $priority_manager =& $this->_getPluginHookPriorityManager();
        while($enabled_plugins->hasNext()) {
            $plugin =& $enabled_plugins->next();
            $hooks =& $plugin->getHooksAndCallbacks();
            $iter =& $hooks->iterator();
            while($iter->hasNext()) {
                $hook =& $iter->next();
                $priority = $priority_manager->getPriorityForPluginHook($plugin, $hook['hook']);
                $event_manager->addListener($hook['hook'], $plugin, $hook['callback'], $hook['recallHook'], $priority);
            }
        }
        $this->plugins_loaded = true;
    }
    
    function &_getPluginFactory() {
        return PluginFactory::instance();
    }
    
    function &_getEventManager() {
        return EventManager::instance();
    }
    
    function &_getPluginHookPriorityManager() {
        if (!is_a($this->pluginHookPriorityManager, 'PluginHookPriorityManager')) {
            $this->pluginHookPriorityManager =& new PluginHookPriorityManager();
        }
        return $this->pluginHookPriorityManager;
    }
    
    function isPluginsLoaded() {
        return $this->plugins_loaded;
    }
    
    function &instance() {
        static $_pluginmanager_instance;
        if (!$_pluginmanager_instance) {
            $_pluginmanager_instance = new PluginManager();
        }
        return $_pluginmanager_instance;
    }
    
    function &getAllPlugins() {
        $plugin_factory =& $this->_getPluginFactory();
        return $plugin_factory->getAllPlugins();
    }
    
    function isPluginEnabled(&$plugin) {
        $plugin_factory =& $this->_getPluginFactory();
        return $plugin_factory->isPluginEnabled($plugin);
    }
    
    function enablePlugin(&$plugin) {
        $plugin_factory =& $this->_getPluginFactory();
        $plugin_factory->enablePlugin($plugin);
    }
    function disablePlugin(&$plugin) {
        $plugin_factory =& $this->_getPluginFactory();
        $plugin_factory->disablePlugin($plugin);
    }
    
    function &installPlugin($name) {
        $plugin_factory =& $this->_getPluginFactory();
        if (!$plugin_factory->isPluginInstalled($name)) {
            $db_corrupted = false;
            $install_sql_filename = $GLOBALS['sys_pluginsroot'].DIRECTORY_SEPARATOR.$name.DIRECTORY_SEPARATOR.'db'.DIRECTORY_SEPARATOR.'install.sql';
            if (file_exists($install_sql_filename)) {
                $dbtables =& new DBTablesDAO(CodexDataAccess::instance());
                if (!$dbtables->updateFromFile($install_sql_filename)) {
                    $db_corrupted = true;
                    $GLOBALS['feedback'] .= 'DB may be corrupted';
                }
            }
            if (!$db_corrupted) {
                $plugin_factory =& $this->_getPluginFactory();
                return $plugin_factory->createPlugin($name);
            } else {
                return false;
            }
        }
    }
    
    function uninstallPlugin(&$plugin) {
        $plugin_factory =& $this->_getPluginFactory();
        $name = $plugin_factory->getNameForPlugin($plugin);
        $db_corrupted = false;
        $uninstall_sql_filename = $GLOBALS['sys_pluginsroot'].DIRECTORY_SEPARATOR.$name.DIRECTORY_SEPARATOR.'db'.DIRECTORY_SEPARATOR.'uninstall.sql';
        if (file_exists($uninstall_sql_filename)) {
            $dbtables =& new DBTablesDAO(CodexDataAccess::instance());
            if (!$dbtables->updateFromFile($uninstall_sql_filename)) {
                $db_corrupted = true;
            }
        }
        if (!$db_corrupted) {
            $phpm =& $this->_getPluginHookPriorityManager();
            $phpm->removePlugin($plugin);
            $plugin_factory =& $this->_getPluginFactory();
            return $plugin_factory->removePlugin($plugin);
        } else {
            return false;
        }
    }
    
    function &getNotYetInstalledPlugins() {
        $plugin_factory =& $this->_getPluginFactory();
        return $plugin_factory->getNotYetInstalledPlugins(); 
    }
}
?>