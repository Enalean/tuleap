<!DOCTYPE html PUBLIC "-//w3c//dtd html 4.0 transitional//en">
<html>
<head>
  <meta http-equiv="Content-Type"
 content="text/html; charset=UTF-8">
  <meta name="author" content="Laurent Julliard">
  <meta name="GENERATOR"
 content="Mozilla/4.77 [en] (X11; U; Linux 2.2.17-21mdk i686) [Netscape]">
  <title>Administration Guide</title>
</head>
<body>
&nbsp;
<center>
<p><b><font size="+3">Administration Guide</font></b> <br>
&nbsp; </p>
<p>
<br>
<font size="-1"> Copyright &copy; Xerox Corporation, Codendi 2007-2009.<br>
This file is licensed under the GNU General Public License version 2. 
See the file COPYING.
</font><br>
</p>
</center>
<br>
&nbsp;
<h2>Table of Content</h2>

<dl><dt><a href="#AdministrationTasks">Administration Tasks</a></dt>
<dt><a href="#CodendiFilePermissions">Codendi File Permissions</a></dt>
<dt><a href="#CodendiFileStructure">Codendi File Structure</a></dt>
<dt><a href="#Codendi_Databases">Codendi Databases</a></dt>
<dt><a href="#Apache">Apache</a></dt>
<dt><a href="#FTP">FTP</a></dt>
<dt><a href="#CVS">CVS</a></dt>
<dt><a href="#DNS">DNS</a></dt>
<dt><a href="#SSH">SSH</a></dt>
<dt><a href="#Sendmail">Sendmail</a></dt>
<dt><a href="#Mailman">Mailman</a></dt>
<dt><a href="#Mailman">OpenFire</a></dt>
<dt><a href="#BackgroundDaemons">Background Daemons</a></dt>
<dt><a href="#Log_Files">Log Files</a></dt>
<dt><a href="#Codendi_Code_Update">Codendi Code Update</a></dt>
<dd><dl>
<dt><a href="#ClassicUpdate">Classic update in console environment</a></dt>
<dt><a href="#PluginUpdate">Web interface update mechanism</a></dt>
</dl></dd>
<dt><a href="#BackupRestore">Backup/Restore</a></dt>
<dt><a href="#CodendiTestingEnvironment">Codendi Testing Environment</a></dt>
<dt><a href="#Codendi_HowTo">Codendi HowTo</a></dt>
<dd><dl>
<dt><a href="#HowTo_Import">Importing an existing CVS repository in Codendi</a></dt>
<dt><a href="#HowTo_Import_SVN">Importing an existing Subversion repository in Codendi</a></dt>
<dt><a href="#HowTo_Import_Git">Importing an existing Git repository in Codendi (bare repository)</a></dt>
<dt><a href="#HowTo_Regenerate_VC">Regenerating a fresh CVS or SVN repository for a Codendi project</a></dt>
<dt><a href="#HowTo_Change_User_Name">Changing a User Name on Codendi</a></dt>
<dt><a href="#HowTo_Change_Project_Name">Changing a Project Short Name on Codendi</a></dt>
<dt><a href="#HowTo_Email_pb">New user registration problems - email address errors</a></dt>
<dt><a href="#HowTo_Block_Client">Blocking a Client from Accessing Codendi</a></dt>
<dt><a href="#HowTo_Suspend_User">How to suspend/delete a Codendi user</a></dt>
<dt><a href="#HowTo_Recompile_RPM">Recompiling a Codendi specific RPM</a></dt>
<dt><a href="#HowTo_Change_PW">Change privileged account passwords</a></dt>
<dt><a href="#HowTo_Delete_Bug">Delete a bug from the Codendi database</a></dt>
<dt><a href="#HowTo_Restricted_Users">Enabling 'Restricted Users' on a Codendi server</a></dt>
<dt><a href="#HowTo_Localize_Services">Localize service names</a></dt>
<dt><a href="#HowTo_cvs2svn">Convert a CVS repository to Subversion</a></dt>
<dt><a href="#HowTo_restoresvn">Restore a Subversion repository</a></dt>
<dt><a href="#HowTo_recoversvn">Recover a Subversion repository</a></dt>
<dt><a href="#HowTo_cleansvn">Clean-up a Subversion repository</a></dt>
<dt><a href="#HowTo_distributed">Set up a distributed Architecture</a></dt>
<dt><a href="#HowTo_passwords">Set up a validator for users' password</a></dt>
<dt><a href="#HowTo_expiration_date">How to add an expiration date on a user account</a></dt>
<dt><a href="#HowTo_change_wiki_language">How to change wiki language for a project</a></dt>
<dt><a href="#HowTo_reset_sessions">How to reset sessions</a></dt>
</dl></dd>
</dl>
<p></p>
<p>

<h1><a name="AdministrationTasks"></a>Administration Tasks</h1>
To access the Codendi Administration interface you must use an account
with administration privileges. When Codendi is first installed a
privileged account named <span style="font-weight: bold;">'</span>admin<span
 style="font-weight: bold;">'</span>
is created with the default password 'siteadmin'. One of the first
thing you must do is to login as 'admin' and change the password for
security reasons.<br>
<br>
Note that any normal user accounts can also be granted site
administration privileges by her a member of the project id #1,
the Codendi Administration project, and giving her the status of
administrator on this project.<br>
<br>
<center><b><font color="#ff0000">** IMPORTANT REMARK **</font></b></center>
<font color="#ff0000">When you use a Codendi account with administration
privileges, remember to <b>log out</b> after each work session
especially </font><font color="#ff0000">if you work an a desktop
computer other than yours or if you share a computer with other people</font>
<h2> Pending projects</h2>
Before a Codendi hosted project is made available to the project team, it
must
be reviewed and approved by the Codendi administration team. New projects
must be checked for approval on a regular basis so that the submitter
doesn't wait too
long
before they get the confirmation. When a project is submitted an email
notification is sent to the Codendi administrators (see the <span
 style="font-family: monospace;">$sys_email_admin</span> variable in
the Codendi configuration file) allowing for a quick response time. In
general it is recommended that you approve all projects.
There most noticeable exceptions are:
<ol>
  <li> <b>Little pieces of code</b></li>
If the submitted project looks like it is going to post small pieces of
code
like a macro or a function or a simple script, the administrator
reviewing
the project submission must contact the project creator and suggest
that the Codendi Snippet
Library might be a better place to host such a small piece of code.<br>
&nbsp; <li> <b>Yet Another Test Project<br>
    </b>The second case is when the team is saying they are creating a
file for
testing&nbsp;
purposes. In order to avoid the proliferation of test projects some
generic
purpose test projects have been created. In this case the project
creator
must be contacted and the admin must suggest that we make him/her a
member
of the Guinea Pig test project with full admin rights so that s/he can
test
all the Codendi feature and make a conscious decision. If it is ok then
we
do approve the project.<br>
    <br>
  </li>
  <li><b>Similar projects exist<br>
    </b></li>
As a site administrator, you'll have the opportunity to review all the
projects created on Codendi and, therefore, you have a unique opportunity
to advise project leaders about existing projects looking like the one
you are about to approve. This might be a chance for the project
submitter to learn about another Codendi project that does more or less
what s/he wants and, rather than created a new project, it may be more
appropriate to join the existing team and contribute to the other
project.<br>
  <br>
</ol>

<h2> Pending users</h2>

Before a user account is made available, it has to be activated. According to your Codendi 
configuration there are several ways to activate an account:
<ul>
	<li><b>Standard case, no administration approval is needed.</b><br />
	Once the user created his account, he will receive an e-mail, and then 
	when clicking on the link inside he will activate his account. The admin 
	can also activate the account (if the user e-mail is not valid...) in the pending user interface.
	</li>
	<li><b>Administration approval is needed (sys_user_approval = 1).</b><br />
	Once the user created his account, the administrator is notified by e-mail.
	He has to first validate the account in the pending
	user interface. Then an email is sent to the user.
	The account is activated once the user has followed the link sent in the email. 
	The administrator can also directly activate the account :
		<ul><li>after validation, in the validated user interface</li>
		<li>or before validation directly in the pending user interface</li></ul>
	</li>
	<li><b>Restricted user and administration approval is needed (sys_allow_register_user=1 and 
	sys_user_approval=1)</b><br />
	Once the user created his account, the administrator is notified by e-mail.
	He has to validate the account in the pending
	user interface. He can choose between standard user or restricted user. Then an email is sent to the user.
	The account is activated once the user has followed the link sent in the email.
	The administrator can also directly activate the account :
		<ul><li>after validation, in the validated user interface</li>
		<li>or before validation directly in the pending user interface</li></ul>
	See also <a href="#HowTo_Restricted_Users">Enabling 'Restricted Users' on a Codendi server</a>
	</li>
	
	</li>
</ul>
<br />
Here are the various possible status values for a Codendi user:
<ul>
	<li>Pending (internal: 'P'): the account was submitted, but not validated or activated.</li>
	<li>Validated (internal: 'V'): (Only when administrator approval is needed): 
	an administrator validated the account. It is not active yet: the user has to 
	follow the link sent in the validation email to activate the account. The 
	administrator may also activate the account in the administration interface.</li>
	<li>Validated as Restricted (internal:W): This is the same as above: the 
	account was validated by an admin, but as 'restricted'.</li>
	<li>Active (internal: A): The account is active: the user can log in and use Codendi.</li>
	<li>Restricted (internal: R): The account is active with a restricted status. 
	The user can log in and use Codendi, but only on projects he belongs to.</li>
	<li>Suspended (internal: S): The account was suspended by an administrator: the 
	user can no longer log in.</li>
	<li>Deleted (internal: D): the account was deleted and the user home directory on Codendi 
	is removed, as well as all entries in system files.</li>
</ul>


<font color="#ff0000"></font>
<h2> Site News Approval</h2>
All news published by each project (using the News service) is normally
only
visible on the related Project Summary page. The Codendi Administration
team has the
ability
to review all pieces of news published over the last 7 days by the
various
projects and make the decision to promote any piece of news so that it
appears
on the Codendi front page. If you decide a news is worth a big
splash on
the front page then select "Approve for front page", make modifications
in
the news title or content to make it more explicit and validate. If not
interesting
then you can delete the news front the approval queue (it is not
deleted from the project news database of course!)
<p>Rules to follow to determine whether a piece of news is worth
publishing on
the
front page: </p>
<ul>
  <li> All news dealing with new software releases and other
significant
events
in the life of the projects (new members,...) should be promoted on the
front
page</li>
  <li>The same applies for news announcing the creation of a new
project. However the Codendi front page already has a section
automatically showing the most recent projects and you may decide not
to publish new project announcement.<br>
  </li>
  <li> If a project publishes 2 or 3 pieces of news at the same time,
then
select the most significant one and only publish this one. When the
Codendi visitors click on this particular piece of news they will be
redirected to the project pages and they get a chance to read the other
news.<br>
  </li>
</ul>
<h2>User Accounts Statuses</h2>
<P>There are 2 different statuses associated with a Codendi user:

<ol>
<li> The "status" field in the user table contains the user status from
the point of view of the Web interface.

<ul>
<li>Valid values are :
<ul>
<li>'A' for Active
<li>'P' for Pending
<li>'V' for Validated
<li>'R' for Restricted
<li>'W' for Validated as Restricted
<li>'S' for Suspended
<li>'D' for Deleted
</ul>
<li> 'Validated':(Only when administrator approval is needed)
	an administrator validated the account. It is not active yet: the user has to 
	follow the link sent in the validation email to activate the account. The 
	administrator may also activate the account in the administration interface.
<li>'Restricted' users are like active users with restricted access
rights:they cannot access pages from projects they are not member of.
This special role is only enabled on Codendi servers in heterogeneous 
environments where corporate users and external consultants 
share the same server.
<li>'Validated as Restricted' is the same as 'Validated', the 
	account was validated by an admin, but as 'restricted'.
</para>
<li>From the point of view of the Web interface there is not much
difference between 'S' and 'D': in both cases the effect is that the
user can non longer login and in both cases they are not counted in the
number of active users (upper right corner of the front page). In any
case a user will never disappear from the MySQL database. 

<li>To modify this field one has to go either to the User Admin page (left
menu pane) but it generates a huge page with all users. So a better
choice is to choose "Admin Page" and then search for the use or select
the first letter of the name. Then you can change the Web status.
</ul>

<li> The "unix_status" field in the user table governs the status of the
Unix account.

<ul>
<li>It is completely independent from the Web 'status' field above
<li>Valid values are
<ul>
<li>'N' for No Unix account: this one has an effect
    only when a user is created with this unix status upfront.
    In this case the Unix crontab daemon simply ignores it and
    doesn't create a Unix account for this user
<li>'A' for Active: A Unix account is created for this user (including
     a home directory in /home/users/user_name)
<li>'R' for Restricted: A Unix account is created for this user (including
     a home directory in /home/users/user_name)
<li>'S' for Suspended: the Unix password is replaced by "!!"
     meaning the user account is preserved although no longer
     usable (Can not login but home directory remains untouched
     and assignment to Unix group is safe as well).Going back
     to status 'A' will reactivate the account with the initial
     password.
<li>'D' for Deleted: the home directory
    for this user is archived in /tmp
    (and therefore automatically cleaned up after 7 days) for
    the moment and then removed from /home/users. Assignment to
    Unix groups is revoked as well of course.
</ul>

<li> To modify the Unix status do the same as for status but click on the
user name. Then you are given access to the Unix status of the user.
Change it to whatever value is appropriate.
</ul>
</ol>

<h2> Account Management</h2>
Codendi is a self managed system and there is normally no
need
to spend time on user account maintenance. There are a couple of
exceptions
though:
<ol>
  <li> <b>Lost password</b>: some user sometimes ask for their lost
password.
Direct them to the Codendi login screen and ask them to click on the
'Lost Password' link.<br>
  </li>
  <li> <b>Lost login</b>: some users even lose their login name :-)
Tell
them to use the Codendi search box, select the People item and type a
part of
their last name (it's very unlikely that they also forgot about their
last name...). The login should appear in the result list and they
can
then follow the lost password procedure as explained before.<br>
  </li>
  <li> <b>Lost password and e-mail address has changed</b>: in this
case
the normal recovery procedure won't work because the user will never
receive
the e-mail notification (given that his/her email address is wrong).
The Codendi Administrator must use the User Administration module,
update
the
e-mail address of the user&nbsp; and then tell the user to proceed as
in the lost password procedure.</li>
  <li> <b>E-mail address is no longer valid</b>: this is something
that is often seen when using the Codendi mass mail Engine. All invalid
e-mail address are
bounced
and returned to codendi-admin@codendi.example.com. Once in a while it is good
to
make a bit of clean-up in the user database as follows:</li>
  <ul>
    <li> Look for the person name in your enterprise directory. If
this
person is still working for the company and his/her e-mail address has
changed then contact the user and
ask him/her to update the address.</li>
    <li> If the person is no longer with your company, go to the Codendi
User
Administration page, spot the user login name and click either on
'Suspend' or 'Delete' link for this account.&nbsp; Opting for account
suspension gives a chance to the user to complain that she is still
alive and we can easily reactivate the account without loosing personal
information.<br>
    </li>
  </ul>
  <li> <b>Incorrect e-mail given at registration time:</b> amazingly
enough this is
quite
a common mistake for new user to mistype their email address on the
user registration form. In this case, the email notification sent to
the user for confirmation never reaches the recipient and the user
account cannot be validated . Upon reception of the bounced email
notification, the Codendi Administrators have two options:</li>
  <ul>
    <li>access the Codendi main administration page, look for pending
user account, force the approval of the user account and send a note to
the user saying that the account is now active and the first she must
do is to change her email address under the 'Account Maintenance' link</li>
    <li>or the Codendi Administrator can simply send the bounced message
to the appropriate email address, ask the user to confirm his
registration and change her email address as above.</li>
  </ul>
  <li> <b>Alien e-mail addresses</b>: when a user registers we
strongly recommend
that they use internal and approved e-mail address only. Ideally the
user should also use the canonical form of her email address type it
is
it appears in your company directory. By doing so, Codendi look-ups in
your
company directory will work correctly. <br>
  </li>
  <li><b>Create a new user account</b>: in the Admin interface by clicking on the 'new user' 
  link in the user administration part. The interface is nearly the same as the one of account 
  creation by a user. You have to choose the login and password of the new user. You can 
  choose to create the user as a restricted user by selecting the box 'Restricted user' 
  on the bottom of the page.<br>By default no email is sent to the new user, so please 
  remember the login and password you set for the user. If you want that the user receives 
  a welcome email with the login and password from Codendi, check the box 'Send a welcome 
  email to the user' before activating the account.
  </li>
</ol>
<h2> Site News Push</h2>
Codendi offers a mass mail engine to the Codendi Administration Team
making it possible to push an announcement to a all or part of your
Codendi population. Be careful that it's ideal for
spamming
so use it with caution and only when needed (see below). The mass mail
engine allows you to select your target population, type a
message and send it with a click of a mouse. Use this mechanism to push
site
update news like:
<ul>
  <li> A new Codendi document is published: Codendi newsletter, Codendi
article, new
Codendi
User Guide,...</li>
  <li> New major features available in Codendi</li>
  <li> Maintenance operation: hardware or software upgrade&nbsp; and
all
the
events that will prevent the Codendi server from operating normally must
be
announced ahead of time</li>
  <li> Disaster reports: typical examples are network problems due
to
router flapping or wide area network cut due.&nbsp; Codendi has nothing
to do with this kind of
troubles
but we must inform the user that they'll probably experience some
difficulties
to reach the Codendi server</li>
</ul>
<b><font color="#ff0000">Remark:</font></b> when a mass mail message is
sent the Codendi Administration team may receive
many copies
of it. This is due to the fact that messages are sent
by
chunk of 25 addresses and Codendi administrators receive a copy for each
chunk. So the
larger
the selected population the bigger the number of copies. The reason for
these multiple copies is because messages are "apparently" sent to
noreply@codendi.example.com to stress the fact that recipient should not
reply to this message. If the noreply email address is an alias to
codendi-admin then multiple copies will be received by Codendi
administrators. The noreply address may also be aliased to&nbsp;
/dev/null to avoid this problem (see <span
 style="font-family: monospace;">/etc/aliases</span>).
<p> </p>
<h2> Developer Survey </h2>
<p>
The <b>Developer Survey</b> is a special survey that appears in the
user's&nbsp; personal page.&nbsp; The developer is a general survey
that gives site administrators the opportunity
to better understand the
population of users (e.g. how they heard about Codendi, do they like it,
etc.).
This survey can only be answered once. The Developer Survey is
automatically created at&nbsp; Codendi installation
time (survey id 1, associated to project 1), but it is inactive by
default and
does not contain any question.<br>
<br>
</p>
<hr width="100%" size="2">
<h1><a name="CodendiFilePermissions"></a> Codendi File Permissions</h1>
The Codendi Web interface use the paradigm of project and project members
to
manage access permissions to the various project data. Codendi
maintains
this access permission policy both at the Web and Unix levels.
Therefore Codendi makes
a
direct mapping between a project and a Linux group, and between a user
and
a Linux account. As an example if you are a member of the "codendi"
project on
Codendi, your Unix account will also be a member of the "codendi" Unix
group.
<p>&nbsp;Let's review some of the key permission mechanism in place on
Codendi.
More information on the subject can be found in the Codendi User Guide<br>
&nbsp; </p>
<h2> User accounts</h2>
When a new user registers on Codendi three accounts are created:
<ol>
  <li> <b>A Web account</b> managed by the login/session mechanism
implemented
in PHP:</li>
  <br>
Information about login name and encrypted password are stored in the
Codendi database.<br>
&nbsp; <li> <b>A Unix account</b> with the same name/password as the
Web
account</li>
  <br>
This account is used for shell account and to setup the ownership on
appropriate
directories.
Information about login name and encrypted password are stored both in
the Codendi database
user table and in the Linux password and group files. User IDs (uid)
are in the range (20000-49999), the uid number is determined
when
the user account is first created on the Codendi Web front-end. It's a
sequential
number incremented for each newly created account. Account ID of
deleted users
are not re-used.<br>
  <font color="#ff0000"><span style="font-weight: bold;">Remark</span>:</font>
Unix login name are all
lowercase even if uppercase are used in the Web login name. <br>
&nbsp;
</ol>
There are specific user account you must know about:
<ul>
  <li> <b>codendiadm:</b> this is the user that owns the entire Codendi
Web
site hierarchy under /usr/share/codendi</li>
  <li> <b>dummy:</b> a "dummy" user that is generally used whenever a
file
belongs to a given group but to no specific user in particular. More or
less
equivalent to the "nobody" user.</li>
  <li> <b>mailman:</b> owner of the mailman directories</li>
  <li> <b>anoncvs_xxxx</b> (deprecated - login no longer created): a specific user created for each project
where xxxx is the project short name .
These are not real login account but are just used to give source code
checkout
capabilities
to anonymous users. By default Codendi does not allow anonymous CVS
access and these accounts are not used unless a project explicitly
asks for anonymous CVS access to be activated.We keep maintaining them
in case a project would like to activate
anonymous
read access on their CVS repository. uid range is 50000-65535.</li>
</ul>
<h2> Group accounts</h2>
When a Codendi hosted project is created the project administrator gives
it
a project short name. This project short name can be used in a number
of
places:
<ol>
  <li> http://codendi.example.com/projects/<i>ProjectShortName</i> is a
shortcut
to access a project summary page on the Codendi Web site (not to be
confused
with the Project Web site at http://<i>ProjectShortName</i>.codendi.example.com/</li>
  <br>
&nbsp; <li> A Unix group with the same name (all lowercase) is created</li>
  <ul>
    <li> It is applied to all projects related disk resources (e.g. the
Project
home directory where the project web site is hosted).</li>
  </ul>
  <ul>
    <li> Members of this group are all the developers who are declared
as
"project members" by the project administrator in the
Project
Admin page. In other word there is a direct mapping between project
membership as
defined through the Web front-end and group membership on the Unix side.</li>
  </ul>
  <ul>
&nbsp;
  </ul>
  <li> A Unix group with the same name as the user login name is also
created
for each user. So by default each user is a member of a group of his
own.
These groups are used for user home directories for instance so that
only
the user can access its own home directory.</li>
</ol>
There are specific group accounts you must know about:
<ul>
  <li> <b>codendiadm:</b> group created to own the Codendi Web
hierarchy
under <span style="font-family: monospace;">/usr/share/codendi</span>.</li>
  <li><span style="font-weight: bold;">mailman:</span> group owner of
all the Mailman directories</li>
</ul>
<h1> <a name="CodendiFileStructure"></a>Codendi File Structure</h1>
<h2> Web site</h2>
The Codendi Web front end files are all under <b><span
 style="font-family: monospace;">/usr/share/codendi</span>.</b> Except
otherwise
specified this directories and all the files and directories under it
belongs
to user.group: <b>codendiadm.codendiadm</b> (rwxr-xr-x) <br>
&nbsp; <br>
<table border="1" cellspacing="2" cellpadding="2" width="100%">
  <caption><br>
  </caption><tbody>
  </tbody> <tbody>
    <tr>
      <td bgcolor="#c0c0c0"><b>Location</b></td>
      <td bgcolor="#c0c0c0"><b>Description</b></td>
    </tr>
    <tr>
      <td valign="top">src</td>
      <td valign="top">The directory where all PHP scripts of the Web
front end as well as back-end scripts reside.<br>
      </td>
    </tr>
    <tr>
      <td valign="top">src /www</td>
      <td valign="top">This is where all the PHP scripts are. Most
of them ends with a .php extension except for a few o them that
are used as shortcuts to projects and users information:
      <ul>
        <li> projects/xxxx: goes to Summary page of project xxxx</li>
        <li> users/yyyy: goes to Profile page of users yyyy</li>
      </ul>
      </td>
    </tr>
    <tr>
      <td valign="top">src/www/include</td>
      <td valign="top">There are many PHP files in there used by all
other
scripts. They are sort of small modules providing user/login/session
management,
HTML formatting, DB connection. <br>
      <tt>pre.php</tt> is the top include file used by all others.</td>
    </tr>
    <tr>
      <td valign="top">src/utils</td>
      <td valign="top">This is where all the back-end Perl scripts
are located.&nbsp;</td>
    </tr>
    <tr>
      <td valign="top">src/db</td>
      <td valign="top">Contains the SQL batch files to create and
populate
the Codendi database. it also contains all the database patch file
published by Xerox&nbsp; to correct Codendi defects or add new features.
(see <a href="#Codendi_Databases">Codendi databases</a> section for more
information).&nbsp;</td>
    </tr>
    <tr>
      <td valign="top">src/back-end</td>
      <td valign="top">This subdirectory is not used by Codendi because
all
the configuration files contained in this directory are elsewhere on
the
file system. See the src/backend/zones/README for more information</td>
    </tr>
    <tr>
      <td valign="top">src/etc</td>
      <td valign="top">This is the directory where a number of Codendi
configuration files are located. These template files (hence the .dist
extension) are instantiated by the Codendi installation script,
customized at installation time and
copied over to the target directories. <br>
      <b><font color="#ff0000">Remark:</font></b> the database.inc
configuration file stored in /etc/codendi/conf/database.inc contains
the Codendi database password in clear so it must be readable only for
the codendiadm user/group
only (rw-r-----)</td>
    </tr>
    <tr>
      <td valign="top"><br>
      </td>
      <td valign="top"><br>
      </td>
    </tr>
    <tr>
      <td valign="top"><br>
      </td>
      <td valign="top"><br>
      </td>
    </tr>
    <tr>
      <td valign="top">/usr/lib/codendi/bin</td>
      <td valign="top">There are a couple of executables in this
directory
that work in cooperation with the Codendi WEB Site:
      <ul>
        <li> <a name="fileforge"></a><b>fileforge:</b> when a new file
release
is created and validated, attached uploaded files are moved into the
File
release space (runs suid root because it must read/write in all project
space
areas)</li>
        <li><span style="font-weight: bold;">gotohell:</span> a small
shell script used to redirect some emails (e.g noreply address) to a
black hole!<br>
        </li>
        <li><b>log_accum</b> and <b>commit_prep</b>: a set of
Perl scripts that send an email notification on a CVS commit. These
script are used by Codendi whenever a project activate the email
notification in the CVS Administration interface of Codendi.</li>
        <li><span style="font-weight: bold;">commit_email.pl</span>: a
Perl script used that send an email notification on a Subversion
commit. This script is used by Codendi whenever a project
activates the email notification in the Subversion Administration
interface of
Codendi.</li>
      </ul>
      </td>
    </tr>
  </tbody>
</table>
<h2> </h2>
<h2> <a name="CVS_Repositories"></a>CVS Repositories</h2>
<br>
<table border="1" cellspacing="2" cellpadding="2" width="100%">
  <caption><br>
  </caption><tbody>
  </tbody> <tbody>
    <tr>
      <td bgcolor="#c0c0c0"><b>Location</b></td>
      <td bgcolor="#c0c0c0"><b>Description</b></td>
    </tr>
    <tr>
      <td valign="top">/var/lib/codendi/cvsroot and link from /cvsroot</td>
      <td valign="top">The CVS repositories of all Codendi projects are
created
under the <span style="font-family: monospace;">/var/lib/codendi/cvsroot</span>
directory. This directory is linked from <span style="font-family: monospace;">/cvsroot</span>
in the top directory.
 /var/lib/codendi/<i>ProjectName</i> is the CVS repository
of
project <i>ProjectName</i>. By default all files belong to user nobody
and
group <i>ProjectName</i>. File permission is read only (r--r--r--) for
files, while directories are user and group writable (rwxrwxr-x). This is
defined by CVS and must not be touched. <br>
      <br>
By default CVS servers on Codendi are configured to perform all
transactions through the pserver protocol. Codendi can be tuned to use
the ssh tunnelling protocol, or the sserver encrypted protocol 
(with CVSNT) instead. Ask the Xerox Codendi team for more
information. If secured transaction and fine grain access permissions
are high on your list of project requirements, we strongly
advise you to consider the use of Subversion instead of CVS.<br>
      <p>Exceptions to these rules are: </p>
      <ul>
        <li> CVS files that correspond to executables for which we want
the executable flags to be preserved when the file is checked out of
the CVS repository must have the executable flag set <br>
        </li>
        <li>(GNU CVS only) The CVS lock dir is created in /var/lock/cvs/<i>ProjectName</i>. It is world writable (drwxrwxrwx) so that all users even those
not
part of the project team can checkout a working copy of the CVS tree.</li>
        <li>The CVS repository for each project is owned by the user <i>codendiadm.</i>
This allows the CVS web interface, which implements its own access
control, to access the directory even if the directory is not world readable.<br>
        </li>
        <li> For <u>private</u> projects and public projects that set the CVS reposiotry to be private, the CVS repository is NOT
world readable (drwxrwx---). It is only user and group readable because
the sources must be invisible to non project members.</li>
      </ul>
Ability to commit changes to the CVS repository from a working copy is
controlled
by the CVSROOT/readers and CVSROOT/writers files. Those users in the
writers file
(all project members as of today) can commit changes to the CVS
repository.&nbsp; Project administrators who wants to prevent some
project members to commit changes in the project CVS repository should
add the corresponding login names in the readers file (the writers file
must not be touched).</td>
    </tr>
  </tbody>
</table>
<br>
&nbsp;
<br>
<h2> <a name="Subversion_Repositories"></a>Subversion Repositories</h2>
<br>
<table width="100%" cellpadding="2" cellspacing="2" border="1">
  <caption><br>
  </caption><tbody>
  </tbody> <tbody>
    <tr>
      <td bgcolor="#c0c0c0"><b>Location</b></td>
      <td bgcolor="#c0c0c0"><b>Description</b></td>
    </tr>
    <tr>
      <td valign="top">/var/lib/codendi/svnroot and link from /svnroot</td>
      <td valign="top">The Subversion repositories of all Codendi&nbsp;
projects are
created
under the <span style="font-family: monospace;">/var/lib/codendi/svnroot</span>
directory.  This directory is linked from <span style="font-family: monospace;">/svnroot</span>
in the top directory.
/var/lib/codendi/svnsroot/<i>ProjectName</i> is the Subversion repository
of
project <i>ProjectName</i>. As opposed to CVS, Subversion manages the
repository in a database acting as a virtual filesystem. Therefore
access permission do not rely on the Linux file system permission but
are directly defined and managed through the Subversion database.
Project members and non project members permission can be defined
through the Web interface of the Codendi Subversion service (see the <a
 href="/doc/en/user-guide/svn.html#subversion-administration-interface">Codendi
User Guide</a> for more details).<br>
      <br>
Beside the virtual file system managed in the Subversion databases
there are a number of files installed on the Linux file system that you
must know about:<br>
      <ul>
        <li><span style="font-family: monospace;">/svnroot/</span><span
 style="font-style: italic; font-family: monospace;">ProjectName</span><span
 style="font-family: monospace;">/.SVNAccessFile</span>: this file
holds the definition of the access permission for a given Subversion
repository. We highly recommend that you do not modify this file by
hand but rather use the Web interface of the Codendi Subversion service
to do so.<br>
          <br>
        </li>
        <li><span style="font-family: monospace;">/svnroot/</span><span
 style="font-style: italic; font-family: monospace;">ProjectName</span><span
 style="font-family: monospace;">/hooks/post-commit</span>: this hook
file is installed by Codendi in order to feed the Codendi database with a
number of information about all your Subversion transactions. This is
the so called Subversion tracking feature that a project administrator
can active or deactivate from the Web interface of the Codendi Subversion
service. This file must not be modified or removed. Other hook scripts
can be used by the project team if they have a shell account available
on the server.<br>
        </li>
      </ul>
      </td>
    </tr>
  </tbody>
</table>
<br>
&nbsp;
<h2> <a name="Log_files"></a>Log files</h2>
<br>
<table border="1" cellspacing="2" cellpadding="2" width="100%">
  <caption><br>
  </caption><tbody>
  </tbody> <tbody>
    <tr>
      <td bgcolor="#c0c0c0"><b>Location</b></td>
      <td bgcolor="#c0c0c0"><b>Description</b></td>
    </tr>
    <tr>
      <td valign="top">/var/log/codendi</td>
      <td valign="top">The directory where log files used for
statistics
are archived. Archiving takes place each day.</td>
    </tr>
    <tr>
      <td valign="top">./cvslogs/Year/Month</td>
      <td valign="top">File name pattern: <tt>cvs_traffic_YYYYMMDD.log</tt>
      <p>A daily log of the CVS history files for all Codendi projects.
The
script <tt>/usr/share/codendi/src/utils/cvs1/cvs_history_parse.pl </tt>runs
daily
and is responsible for extracting the CVS log information of that day
for
all <tt>/cvsroot/ProjectName/CVSROOT/history</tt> file and assemble
them all
in a single log file. </p>
      <p>This global log file is later processed by the script <tt>/usr/share/codendi/src/utils/underworld-root/db_stats_cvs_history.pl</tt>
which feeds the Codendi database with statistical figures about the CVS
activity
of each project (like the number of&nbsp; CVS checkout/add/commit
counters appearing on the Welcome Web page of the Codendi CVS service )</p>
      </td>
    </tr>
    <tr>
      <td valign="top">. /hostname/Year/Month</td>
      <td valign="top">File name pattern: <tt>vhosts-access_YYYYMMDD.log</tt>
      <p>This file contains the combined Apache access logs for all the
Codendi projects Virtual
Web
servers (also know as the project web sites). This is a simple daily
copy of the Apache log file&nbsp; <span style="font-family: monospace;">/var/log/httpd/vhosts-access_log</span>.
that is later analyzed to feed the Codendi database with statistical
data
about the project Web site activity. These files are generated daily by
the logrotate script of Apache (see the <a href="#Log_Files">Log Files
      </a>section) <br>
&nbsp;</p>
      </td>
    </tr>
    <tr>
      <td valign="top">. /Year/Month/</td>
      <td valign="top">File name pattern: <tt>http_combined_YYYYMMDD.log</tt>
      <p>This file contains the combined access logs to the main Codendi
Web site. They are generated daily by the logrotate
script
of Apache (see the <a
 href="#Log_Files">Log
Files </a>section). It is basically a copy of the&nbsp; <span
 style="font-family: monospace;">/var/log/httpd/access_log</span>
file </p>
      <p>File name pattern: <tt>ftp_xferlog_YYYYMMDD.log</tt> <br>
This file contain the ftp access logs (upload and download) to the
Codendi site. It is generated daily by the logrotate script of ftp (see
the <a
 href="#Log_Files">Log
Files </a>section). It is basically a copy of the FTP log file <span
 style="font-family: monospace;">/var/log/xferlog.</span>&nbsp; <br>
&nbsp;</p>
      </td>
    </tr>
  </tbody>
</table>
<br>
<h2> <a name="Dump_files"></a>Dump files</h2>
<br>
<table border="1" cellspacing="2" cellpadding="2" width="100%">
  <caption><br>
  </caption><tbody>
  </tbody> <tbody>
    <tr>
      <td bgcolor="#c0c0c0"><b>Location</b></td>
      <td bgcolor="#c0c0c0"><b>Description</b></td>
    </tr>
    <tr>
      <td valign="top">/var/lib/codendi/dumps</td>
      <td valign="top">As we will see later in this document there is a
bunch
of background script running on Codendi on a regular basis. The default
frequency if once every
other
hours. The first thing these scripts do is to extract a number of
information
from the Codendi database and dump in a various text files to exploit
them in the next stages.
      <p>Files found in this directory are&nbsp; </p>
      <ul>
        <li> <b>aliases:</b> all Codendi users have an email alias in
the
form of login login_name@users.<span style="font-style: italic;">your.codendi.domain</span>.
By creating such
aliases
one can send an email to a Codendi user simply by using it's login name.
This is very convenient if the project admin wants to send e-mail to
certain developers
of the team through CVS notification for instance. By using the
login
name Codendi users also make sure that if the email address of a user
changes it will be
automatically
updated.</li>
All user aliases and mailing list aliases are actually appended to the
master
file <tt>/usr/share/codendi/src/utils/underworld-dummy/aliases.zone</tt>. This
file
contains codendi wide aliases like codendi-admin or codendi-contact. If you
want
to add more aliases modify this file NOT the /etc/aliases... files<br>
        <br>
        <li> <b>subversion_dir_dump</b> ready to use Apache config files with
a list of all the per project subversion repositories. 
This will be copied as is in the <tt>/etc/httpd/conf.d/codendi_svnroot.conf</tt> file.</li>
        <li> <b>db_top_groups_calc_output: </b>contains all sorts of
statistics
about the Codendi hosted projects (project name, old project rank in
terms of
total number of downloads, old project rank in terms of number of
downloads
this past week, user rank - unused-, rank in terms of total number of
forum
posting this past week,&nbsp; total number of download, new rank of the
projects
in terms of number of downloads,...</li>
        <li> <b>group_dump:</b> group (project) name dump with project
ID,
users belonging to the project and the project status (Active,
Suspended,
Deleted)</li>
        <li> <b>list_dump</b>: dump of all the mailing lists created
by
the
Codendi projects along with the email of the administrator and the
default
admin password for the list.</li>
        <li> <b>ssh_dump:</b> dump of the SSH shared keys entered by
the
users. Shared keys will be automatically installed in the user home
directory to let her login through ssh without having to type her
password. <br>
        </li>
        <li> <b>user_dump:</b> a user info dump with user id, status
(Active, Suspended,...), default shell, MD5 encrypted password, and the real
name.</li>
        <br>
&nbsp;
      </ul>
      </td>
    </tr>
  </tbody>
</table>
<br>
&nbsp;
<h2> User directories</h2>
<br>
<table border="1" cellspacing="2" cellpadding="2" width="100%">
  <caption><br>
  </caption><tbody>
  </tbody> <tbody>
    <tr>
      <td bgcolor="#c0c0c0"><b>Location</b></td>
      <td bgcolor="#c0c0c0"><b>Description</b></td>
    </tr>
    <tr>
      <td valign="top">/home/users/... <br>
...<span style="font-style: italic;">UserName</span></td>
      <td valign="top">Each registered user has her own Unix account
created
and the home directory that goes with it. This user home directory is
owned
by <span style="font-style: italic;">UserName</span>.<span
 style="font-style: italic;">UserName</span> and has access permission
rwxr-xr-x. This can be
changed
by the user if she wants to set access permission differently. <br>
There is currently no space quota on a user home directories.</td>
    </tr>
  </tbody>
</table>
<br>
&nbsp;
<h2> Project Directories</h2>
<br>
<table border="1" cellspacing="2" cellpadding="2" width="100%">
  <caption><br>
  </caption><tbody>
  </tbody> <tbody>
    <tr>
      <td bgcolor="#c0c0c0"><b>Location</b></td>
      <td bgcolor="#c0c0c0"><b>Description</b></td>
    </tr>
    <tr>
      <td valign="top">/home/group/... <br>
...<span style="font-style: italic;">ProjectName</span></td>
      <td valign="top">Each Codendi hosted project has its own project
directory.
When this directory is initialized a minimal directory structure is
created
to host the Project Web Site. Two sub-directories are created:
      <ul>
        <li> <b>htdocs</b> : this is where all html, shmtl, php,....
file should go (Apache Virtual Server Document Root)</tt></li>
        <li> <b>private</b> : this is a private directoy that is only accessible to project members</tt></li>
      </ul>
These directories all have the group setuid bit set. On Linux this
ensures that files created under this directory by a group member are
automatically created with the right group ownership. The reason for that is because
a user can belong to several Codendi projects and therefore he can be a member
of several Unix groups. If the setuid bit wasn't used it would be the
responsibility of the user to change its working group with the newgrp command when
going from one project directory to another. This would be of course error
prone.
      </td>
    </tr>
  </tbody>
</table>
<br>
&nbsp;
<h2> File Release Space</h2>
<br>
<table border="1" cellspacing="2" cellpadding="2" width="100%" nosave="">
  <caption><br>
  </caption><tbody>
  </tbody> <tbody>
    <tr>
      <td bgcolor="#c0c0c0"><b>Location</b></td>
      <td bgcolor="#c0c0c0"><b>Description</b></td>
    </tr>
    <tr>
      <td valign="top">/var/lib/codendi/ftp/codendi/<span style="font-style: italic;">ProjectName</span></td>
      <td valign="top">This is where all the uploaded files associated
with a given release of project <span style="font-style: italic;">ProjectName</span>
(see the <a
 href="/doc/en/user-guide/frs.html">Codendi
File Release
Service</a>) are actually
stored. Normally neither the Codendi Administration Team nor the Project
Admin Team should mess up with this area by hand using their shell account. Files are
deposited here by the <a
 href="#fileforge">fileforge</a>
utility. This directory belongs to the project group ID of course and
is group
writable.&nbsp;</td>
    </tr>
    <tr nosave="">
      <td valign="top" nosave="">/var/lib/codendi/ftp/incoming</td>
      <td>The FTP incoming directory is used by the project members
to upload the software packages to be associated with new software
releases in the Codendi File Release Service.
This
is a temporary storage area as the uploaded files move to the final
release space&nbsp; /var/lib/codendi/ftp/codendi/<span style="font-style: italic;">ProjectName</span>
(see
above) when a new software release is created.&nbsp;
      <p><b><font color="#ff0000">Remark: </font></b>There is a script
in the
root crontab that removes all the files older than 2 weeks from this
directory.
The reason we do that is because this zone is shared by all the
projects and
we don't want that ghost files stay here for too long.<br>
      </p>
      </td>
    </tr>
  </tbody>
</table>
<br>
&nbsp;
<h2> FTP Space</h2>
<br>
<table border="1" cellspacing="2" cellpadding="2" width="100%">
  <caption><br>
  </caption><tbody>
  </tbody> <tbody>
    <tr>
      <td bgcolor="#c0c0c0"><b>Location</b></td>
      <td bgcolor="#c0c0c0"><b>Description</b></td>
    </tr>
    <tr>
      <td valign="top">/var/lib/codendi/ftp/pub/<span style="font-style: italic;">ProjectName</span></td>
      <td valign="top">This is the anonymous FTP space assigned to
project <span style="font-style: italic;">ProjectName</span> at
creation time. It can be used by the project
team for any purpose (well... of course it must have something to do with
the project). Ownership is dummy.<span style="font-style: italic;">ProjectName</span>
and permission drwxrwxr-x)</td>
    </tr>
  </tbody>
</table>
<br>
&nbsp; <br>
<p> </p>
<hr width="100%" size="2">
<h1> <a name="Codendi_Databases"></a>Codendi Databases</h1>
<h2> The Codendi Master Database</h2>
Codendi uses the MySQL database engine to store all of the project data.
MySQL is fast, lightweight and very robust. <br>
<h3> Database Creation</h3>
The Codendi database is created once when the Codendi software is first
installed. The scripts used to create and populate the database are
located in <span style="font-family: monospace;">src/db/mysql</span>. <br>
<b><font color="#ff0000">Remark:</font></b> NEVER EVER run these SQL
scripts
once the DB has been created or it will destroy all of your existing
data !! <br>
&nbsp;
<h3> Database Update</h3>
As you operate your own Codendi site, the Codendi team at Xerox will
provide you with a number of feature enhancements and defect
corrections that you may wan to install on your site (see the <a
 href="#Codendi_Code_Update">Codendi Code Update</a> section below). Some
of the changes may impact the database structure in which case a
database patch named dbxxxx.sql or dbxxxx.pl will appear under <span
 style="font-family: monospace;">src/db/upgrades</span>.<br>
<br>
<h3>Database Access Permissions</h3>
MySQL has its own access permission
management
system that is completely independent from the access permission
management system of the underlying operating system . Although
we use the same user names for the MySQL and Linux administration
accounts they are actually managed separately. Although this is not
mandatory, we suggest that you use the same password on&nbsp; Linux and
MySQL for a given account.<br>
<p>The Codendi administration accounts with access to the Codendi database
are as follows:
</p>
<ul>
  <li> <b>root</b>: This user
has
full administration right on all the MySQL databases and users. You
must use
this user whenever you want to grant/revoke new permission to a given
user
or network domain, etc...</li>
  <li> <b>codendiadm</b>: the user that was specifically created to
have
read/write access to the codendi database. It can only interact
with
the database from the local host and not from a remote machine. All the
Codendi PHP scripts run under this user name to
connect
to the database (see the file <span style="font-family: monospace;">/etc/codendi/conf/local.inc</span>
for the configuration of the database user and password).<br>
  </li>
  <li> <b>dummy</b>: this user was created with read only access on
the Codendi
database (SELECT granted). It has no password and can only be used for
a
connection from the local host. This user is the one used by all
Project Virtual
Web site and if they include PHP scripts they can connect to the DB and
extract
information about their project as well as user/login/session
information.</li>
  <li><span style="font-weight: bold;">cxuser</span>: this user has
read-only access to the project databases that are created when a
project administrator create a project database export (See the <a
 href="/doc/en/user-guide/project-admin.html#project-data-export">Project
Data Export</a> section in the Codendi User Guide). No password is needed
for this user.</li>
</ul>
<h2> Interacting with Databases</h2>
Whatever way you decide to use to access the Codendi databases (command
line
or phpMyAdmin), reading (part of) the MySQL documentation is a
pre-requisite.
<u>Don't forget that you are now entering the realm of the core project
data
and making any mistake here is NOT allowed or you'll probably cause
SEVERE
damages.</u>
<h3> Command Line</h3>
From any Unix account, type:
<p><tt>$ mysql -u <span style="font-style: italic;">user_name</span> <span
 style="font-style: italic;">database_name</span> -p</tt> </p>
<p>where database_name is the name of the database you want to connect
to
(e.g. "codendi" for the Codendi master database) and the user_name is
the MySQL user name you
pretend
to be (type -p if there is a password associated with this user but
don't
type the password in clear here to avoid having the password appearing
in
the shell command history file) </p>
<p>Then the database is yours and you can interact with it through
using SQL statements. Here are two sample SQL statements<br>
</p>
<p><tt>mysql&gt; SELECT group_name FROM groups WHERE is_public = 0; #
show a list a private project name<br>
</tt></p>
<p><tt>mysql&gt; UPDATE user SET realname='Laurent R. Julliard' WHERE
user_id
= 103; # update the full name of the user_id 103<br>
<br>
</tt> </p>
<center>
<p><b><font color="#ff0000">** IMPORTANT REMARK **</font></b></p>
</center>
<font color="#ff0000">It is highly recommended that you practice a bit
on a
MySQL test database before playing with the real Codendi database.
Ideally you should
always
test a SQL statement on the Codendi test server before running it on the
production
server. Except for SELECT statements which are harmless anyway.</font>
<h3> phpMyAdmin</h3>
phpMyAdmin is a PHP based graphical User Interface to the MySQL
database.&nbsp;
It
is currently configured on the Codendi production server to give access
to
the Codendi database only. You can access phpMyAdmin at
<center>
<p>http://<span style="font-style: italic;">your.codendi.domain</span>/phpMyAdmin</p>
</center>
<p>This is password protected at the HTTP level. Authenticate with the
codendiadm
user
name and password. <br>
&nbsp; </p>
<p> </p>
<hr width="100%" size="2">
<h1><a name="Apache"></a> Apache</h1>
The Apache master configuration file is in <span
 style="font-family: monospace;">/etc/httpd/conf/httpd.conf</span>. The
master file also includes specific configuration files located at /<span
 style="font-family: monospace;">etc/httpd/conf.d</span>.&nbsp;
<h2> Master server</h2>
The master Codendi Web server can be accessed through one the following
URLs:
xww.<span style="font-style: italic;">your.codendi.domain</span>, www.<span
 style="font-style: italic;">your.codendi.domain</span> or simply <span
 style="font-style: italic;">your.codendi.domain</span>. and any aliases
that you may have defined yourself in the file <span
 style="font-family: monospace;">/var/named/codendi.zone</span>. The
Apache Document
Root is at <span style="font-family: monospace;">/usr/share/codendi/src/www</span>
where all the PHP scripts are located.
<h2> Virtual Servers</h2>
Each project has its own project Web server. These servers are configured with 
a virtual host alias in /etc/httpd/conf/httpd.conf. 
CGI scripts are disabled, but PHP is available, with a few restrictions (open_basedir, and safe_mode).
<h1>
<hr width="100%"></h1>
<h1><a name="FTP"></a>FTP</h1>
The FTP server configuration file is in <span
 style="font-family: monospace;">/etc/vsftpd/vsftpd.conf</span> and it has been
configured
to work with Codendi. The default configuration allows access to both
anonymous
users (using the "ftp" account) and to all registered users through
their
normal Codendi login/password. This can be used to edit the HTML pages of
the&nbsp; Project Web
server
pages remotely for instance with Netscape Composer, DreamWeaver,
FrontPage and many other Web editing environment<br>
<br>
<p> </p>
<hr width="100%" size="2">
<h1><a name="CVS"></a>CVS</h1>
<h2> Using CVS on Codendi</h2>
This document is not a tutorial on CVS. For an introduction to CVS
refer
to the <a
 href="/doc/en/user-guide/cvs.html">CVS
section of the Codendi User Guide</a>.<br>
&nbsp;
<h2> Codendi specific CVS</h2>
The CVS&nbsp;RPM&nbsp;packages installed on Codendi contains a modified
version
of cvs. The reason the CVS source code has been modified is as follows:
<p>When cvs runs in client server mode (as it does on&nbsp;Codendi) the
server
must be told which directories are allowed as CVS root directories.
These are
the various places where the CVS repositories are located. Allowed CVS
repositories are given to the CVS server through the&nbsp; --allow-root=<span
 style="font-style: italic;">pathname</span> command line options where
<span style="font-style: italic;">pathname</span> is the allowed path.
This option is repeated as many times
as
the number of CVS repositories. While this way of doing is OK for a
small to mid-size CVS server it doesn't scale to hundreds or thousands
of CVS repositories because repeating&nbsp;
--allow-root options hundreds of times would exceed&nbsp; the maximum
allowed size of a Linux command line. Therefore, a new option has been
implemented in the cvs server called --allow-root-file=<span
 style="font-style: italic;">filename</span> where
<span style="font-style: italic;">filename</span> is the name of a file
containing the list of all allowed CVS
repositories on Codendi.<br>
</p>
<p>On Codendi this file is created/updated by the daemon script and
resides
in <span style="font-family: monospace;">/etc/cvs_root_allow</span>. <br>
</p>
<p><span style="font-weight: bold; color: rgb(255, 0, 0);">Remark</span>:
as a Codendi customer you will automatically receive any new version of
the Codendi specific CVS RPMs and you don't have to apply any of the
patch by hand to the Codendi sources.<br>
&nbsp; </p>
<h2> Running the CVS server</h2>
The CVS server does not run permanently in the background. It is
launched
only when necessary through the inetd daemon that is configured to
listen on the port of the pserver protocol (tcp/2401). Look for <span
 style="font-family: monospace;">/etc/inetd.conf/cvs</span>
for
the command line used to run the cvs server.
<p> </p>
<hr width="100%" size="2">
<h1><a name="DNS"></a>DNS</h1>
Codendi has its own internal domain : codendi.example.com. And the codendi
machine is the name server for this domain. The DNS configuration files
are
located in:<br>
<ul>
  <li><tt>/etc/named.conf</tt>: top configuration file&nbsp;</li>
  <li><tt>/var/named/chroot/var/named/codendi.zone</tt>: this is
where&nbsp;the
codendi.example.com domain is defined.&nbsp;</li>
</ul>
<h2> Static configuration file<br>
</h2>
<p>
The top configuration file is in <tt>/etc/named.conf</tt>. This file
is static
and must be edited by hand. Before the Codendi server is installed you
must ask your network administrator to create the Codendi domain <span
 style="font-style: italic;">your.codendi.domain</span> and delegate the
administration of this domain to the Codendi server. </p>
<p>The Codendi zone is defined in <tt>/var/named/codendi.zone</tt>
. It contains the IP address for the master Codendi server as well as a
list of aliases defined like www, cvs,
download, shell,
users, lists, etc.... The reason why all these aliases have been
defined is
because as the load on the main Codendi server increases it may be
desirable
to
host some Codendi functions on a separate server (e.g the mailing list
manager or the CVS server). Doing so will just be a matter of changing
the IP address
associated
with the lists.<span style="font-style: italic;">your.codendi.domain</span>
or cvs.<span style="font-style: italic;">your.codendi.domain</span> and
all the rest will be transparent for
the
end users. </p>
<p>Similarly mail exchange records (MX record) have been defined for
lists.<span style="font-style: italic;">your.codendi.domain</span>.
Strictly speaking this is not necessary today because the IP address of
the
machine receiving the e-mail is the same as the one
lists.<span style="font-style: italic;">your.codendi.domain</span>
is pointing to. But in the future we may want to have a dedicated
server to
handle email for the codendi domain. Hence the MX record. <br>
&nbsp; </p>
<h2> Wildcard DNS record</h2>
As explained above each project on Codendi has its own Web server that
can
be accessed at the URL http://<span style="font-style: italic;">projectname</span>.<span
 style="font-style: italic;">your.codendi.domain</span>, as well as dedicated cvs.projectname and svn.projectname domains.
For this to work, Codendi now provides a wildcard DNS record that accepts all subdomains.
It it defined in codendi.zone with these lines: (Xerox server)<br>
<tt>
;<br>
; Wildcard DNS entry, to match all possible hosts: projnamme.*, cvs.projname.*, svn.projname.*, etc.<br>
;<br>
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CNAME&nbsp;&nbsp; atlas<br>
<br>
</tt>

<hr width="100%" size="2">
<h1><a name="SSH"></a>SSH</h1>
The Secure Shell service is available on Codendi. All registered user
with
an active account can use it to login into Codendi in a secure way. To
make
Windows users life easier you may also activate the telnet service as
telnet comes standard with the Windows operating system. However we
highly recommend not to enable telnet for security reasons and instruct
your Windows users to install an SSH client instead.<br>
<br>
As a Codendi site administrator you may also decide to disable shell
accounts for all users. If this is so you must change the default shell
assigned to new Codendi users when they register. See the <a
 href="/documentation/installation_guide/html/Installation_Guide.html#Shell_Account">SSH
section in the Codendi installation Guide</a> for detailed instructions.<br>
<center>
<p><b><font color="#ff0000">** IMPORTANT REMARK **</font></b></p>
</center>
<font color="#ff0000">For security and traceability reasons, it is
recommended that Codendi administrators <b>never</b> use
telnet
to log to the Codendi server. It is not secure and it makes critical
password
travel on the Xerox network in clear text!! The Codendi team recommends
that Codendi administrators follows the following procedure to log into
the Codendi server:</font>
<ol>
  <li> <font color="#ff0000">Connect to the Codendi server using ssh and
your
personal Codendi account (e.g. ssh <span style="font-style: italic;">username</span>@codendi.example.com)</font></li>
  <li> <font color="#ff0000">Then if you must act as root or
codendiadm
user use the su command (su - root) and type the appropriate password</font></li>
</ol>
<font color="#ff0000">The reason for the 2-step process is to be able
to determine from the <span style="font-family: monospace;">/var/log/messages</span>
log file who used a privileged user account in case there are multiple
Codendi site administrators.</font>
<p> </p>
<hr width="100%" size="2">
<h1><a name="Sendmail"></a>Sendmail</h1>
By default Codendi uses sendmail as its mail transport agent of choice to
handle incoming and outgoing mail messages. The critical files for the
sendmail configuration are: <br>
&nbsp; <br>
&nbsp;
<table border="1" width="100%" nosave="">
  <tbody>
    <tr>
      <td style="vertical-align: top; font-family: monospace;">/etc/mail/sendmail.cf</td>
      <td style="vertical-align: top;">The master configuration file.
It is created by the Codendi installation script.<br>
      </td>
    </tr>
    <tr nosave="">
      <td style="font-family: monospace;" valign="top" nosave="">/etc/aliases</td>
      <td>This is a small aliases file where you only want to configure
system
wide aliases like postmaster, webmaster,etc... When you modify this
file run
the command "newaliases" for the changes to take effect.</td>
    </tr>
    <tr nosave="">
      <td style="font-family: monospace;" valign="top" nosave="">/etc/aliases.codendi</td>
      <td>This file is generated automatically by the Codendi daemon
scripts
and must never be edited by hand. The beginning of the file contains
some predefined aliases (codendi-admin, codendi-contact, noreply,...) that
must not be modified.<br>
      </td>
    </tr>
  </tbody>
</table>
<br>
&nbsp; <br>
&nbsp;
<p> </p>
<hr width="100%" size="2">
<h1><a name="Mailman"></a>Mailman</h1>
<p>The Mailman mailing lists manager requires little attention from the
Codendi administrators. The configuration is done at installation time
and mailing list are entirely managed by the end users
through the Mailman Web interface. Mailman has a super user password
allowing Codendi site administrators to access the administration
interface of any mailing lists created by Codendi projects.<br>
<br>
<hr width="100%" size="2">
<h1><a name="OpenFire"></a>OpenFire</h1>
<p>The OpenFire XMPP/Jabber server requires little attention from the
Codendi administrators. 
<p>You may need to synchronize the OpenFire server with the Codendi DB in some cases (e.g.
the OpenFire server was down for some time). Symply go to the Codendi Administration page and select 
the "Instant Messaging" link.
<br>The OpenFire administrative interface is available from the main Codendi
administration page. By default, only the 'admin' user (same password as for Codendi)
has access to the OpenFire administration interface, but other users can be added easily.
<p>
Please read the <a href="../JabbeXAdminGuide.odt">JabbeX Administration Guide</a> for more details.


<br>
<hr width="100%" size="2">
<h1><a name="BackgroundDaemons"></a>Background daemons</h1>
<h2>The root crontab</h2>
<p>The root user on Codendi has a number of script defined in the
crontab.
<br>
&nbsp;
<table border="1" width="100%" nosave="">
  <tbody>
    <tr>
      <td style="font-family: monospace;">/usr/share/codendi/src/utils/compute_all_daily_stats.sh</td>
      <td>As the name says it this the master script that compute all
the
daily statistics about the Codendi site globally and also for individual
projects</td>
    </tr>
    <tr>
      <td><span style="font-family: monospace;">/usr/share/codendi/src/utils/underworld-root/...
      </span><br>
      <span style="font-family: monospace;">db_project_weekly_metric.pl</span></td>
      <td>Same as above but this time it is for weekly statistics</td>
    </tr>
    <tr>
      <td style="font-family: monospace;">/usr/lib/codendi/bin/backup_job</td>
      <td>Backup of all Codendi file system.</td>
    </tr>
    <tr>
      <td style="font-family: monospace;">/usr/lib/codendi/bin/backup_subversion.sh</td>
      <td>Backup of all Codendi subversion repositories.</td>
    </tr>
  </tbody>
</table>
<br>
&nbsp; </p>
<hr width="100%" size="2">
<h1> <a name="Log_Files"></a>Log Files</h1>
<h2> Log Files</h2>
For a description of the Log files used by the Codendi server see
the
<a href="#Log_files">Log Files </a>section above. In addition to these
files
there are a number of other log files that are worth knowing: <br>
&nbsp; <br>
&nbsp;
<table border="1" width="100%" nosave="">
  <tbody>
    <tr nosave="">
      <td style="font-family: monospace;" valign="top" nosave="">/var/log/messages</td>
      <td>This is the general purpose log files used by the Linux
operating system. What goes in there is defined in <span
 style="font-family: monospace;">/etc/syslog.conf</span></td>
    </tr>
    <tr>
      <td style="font-family: monospace;">/var/log/maillog</td>
      <td>This is where all the log messages related to mail activities
go. All sendmail messages for message sent and received are stored in
this file.</td>
    </tr>
  </tbody>
</table>
<h2> Log file rotation</h2>
Linux has the ability to automatically rotate the log files to prevent
them
from growing indefinitely. The logrotate utility is ran everyday at
23:58pm
(EST time) as defined in <span style="font-family: monospace;">/etc/crontab</span>.
Note that this is different from
the
crontab file of the root user that is used to run the Codendi daemon
scripts.
<p>The logrotate configuration files located in <span
 style="font-family: monospace;">/etc/logrotate.d/apache</span>
and&nbsp;
<span style="font-family: monospace;">/etc/logrotate.d/vsftpd.log</span> have
been customized for Codendi.
The customization consists in the execution of a post rotation script
that
makes a daily copy of the log files in the Codendi log files area as
described in
the
<a href="#Log_files">Log Files </a>section.<br>
</p>
<hr style="width: 100%; height: 2px;">
<h1><a name="Codendi_Code_Update"></a>Codendi Code Update</h1>
<p><b><font size="+3"></font></b><br>
Codendi offers a continuous update process to Codendi site administrators
to quickly and easily put in place new bug fixes, new features while
minimizing the server downtime. The Codendi software is made of PHP and
Perl code that is delivered in source form to our customers. The Codendi
software resides in the <span style="font-family: monospace;">/usr/share/codendi</span>
directory and it is formatted in such a way that it behaves like a Subversion
working copy that can be remotely updated when ever the system
administrator decide to do so.<br>
<br>
As a Codendi customer you will be entitled to receive the Codendi Subversion
events by email. They are reports about the defect that have been
solved and the new feature that have been implemented in Codendi.
Benefiting from these new features is just a matter of update your
Codendi working copy.<br />
Codendi offers two ways for updating your server :
<ul>
    <li><a href="#ClassicUpdate">Classic update in console environment</a></li>
    <li><a href="#PluginUpdate">Web interface update mechanism</a></li>
</ul>

<h2>Classic update in console environment</h2>

Here is how you should proceed:<br>
<br>
</p>
<ul>
  <li>First you should make sure that the Codendi source code
repository that you must use for your updates is accessible. 
</li>
</ul>
<div style="text-align: center;"><br>
<table
 style="width: 60%; text-align: left; margin-left: auto; margin-right: auto;"
 border="1" cellspacing="2" cellpadding="2">
  <tbody>
    <tr>
      <td
 style="vertical-align: top; font-weight: bold; background-color: rgb(204, 204, 204);">Codendi
Site Location<br>
      </td>
      <td
 style="vertical-align: top; font-weight: bold; background-color: rgb(204, 204, 204);">Codendi
repository pointer<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">Customer Extranet<br>
      </td>
      <td style="vertical-align: top;">https://partners.xrce.xerox.com:/svnroot/codendi<br>
      </td>
    </tr>
  </tbody>
</table>
<br>
</div>
<ul>
  <li>Log to the 'codendiadm' Codendi shell account on the Codendi server</li>
  <li>Go to the Codendi top directory: <span
 style="font-family: monospace;">cd /usr/share/codendi</span></li>
  <li>Launch an SVN status command to get a list of all the
files that needs to be updated on your local Codendi directory<br>
    <br>
    <span style="font-family: monospace;">svn status -u --username  <span style="font-style: italic;">username </span> </span>
<br>(where <span style="font-style: italic;">username </span>is your login on the
Codendi support site given to you when your support contract was activated)<br>
    <br>
    </span></li>
  <li>At that stage you must carefully review the file list and look if
the files src/etc/local.inc.dist, src/etc/httpd.conf.dist or src/db/upgrades/dbxxxx.sql
are mentioned in the list. If this is so go to the next step. If not
then it 's a normal update operation that you can do with a simple:<br>
    <br>
    <span style="font-family: monospace;">svn update --username  <span style="font-style: italic;">username </span><br>
    <br>
    </span>... and that's all you have to do!!<br>
    <br>
  </li>
  <li>If <span style="font-family: monospace;">src/etc/local.inc.dist</span>
is in the list of files to be updated then you must look at the
differences with your own local.inc.dist and make the changes in your <span
 style="font-family: monospace;">/etc/codendi/conf/local.inc</span> file
accordingly. To see what has changed in the local.inc.dist file type:<br>
    <br>
    <span style="font-family: monospace;">svn diff --username  <span style="font-style: italic;">username </span>
src/etc/local.inc.dist # look at the changes and keep them in a safe
place<br>
svn update --username  <span style="font-style: italic;">username</span>&nbsp;
# do the real update<br>
vi
/etc/codendi/conf/local.inc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
# edit your Codendi configuration file and merge the changes<br>
    </span><br>
then do the real update as above.<br>
    <br>
  </li>
  <li>Similarly, if <span style="font-family: monospace;">src/etc/httpd.conf.dist</span> is in the list of files to be updated, you should look at the differences with your own httpd.conf.dist, then merge them in your <span style="font-family: monospace;">/etc/httpd/conf/httpd.conf</span>.
  <li>If one or several <span style="font-family: monospace;">src/updates/scripts/XXX_&lt;script_description&gt;.class.php</span>
(where XXX is a three digit number) are listed then it means you have
to perform some script update (on the Codendi database structure for instance). You must first
do the real update and then <span
 style="text-decoration: underline; font-weight: bold;">apply each
update script in order starting with the smallest XXX number first
and growing</span><br
 style="text-decoration: underline; font-weight: bold;">
    <br>
    <span style="font-family: monospace;">svn update --username  <span style="font-style: italic;">username </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
# do the real update<br>
    </span><span style="font-family: monospace;"><span
 style="font-family: monospace;">cd src/updates</span></span><span
 style="font-family: monospace;">; sh upgrade.sh XXX_&lt;script_description&gt; &nbsp; &nbsp; &nbsp; &nbsp; # apply the script XXX_&lt;patch_description&gt;.class.php<br>
    </span><br>
    <br>
  </li>
</ul>
<p> </p>
<p> </p>

<h2>Web interface update mechanism</h2>
<p>Another way to update your working copy is to use the plugin ServerUpdate.
This plugin provides a secure and easy-to-use process to update your server,
with web interface overview and lots of feedback about what happens.
</p>
<p>This section will focus on the automatic update process.
For a user guide, please read the on-line plugin documentation.
</p>

<!-- ################################################################# -->
<!-- #  Copy/paste from the plugin documentation                     # -->
<!-- ################################################################# -->
<h3 id="update">Process one or more updates</h3>
<p>The plugin allows you to update automatically the Codendi server through the Codendi web interface.
   The update is always processed from the current revision of the working copy to the chosen revision
   (greater than the current revision), by updating <strong>all</strong>
   the revisions between.
   To update the server, click the icon on the right of the wished revision.
   The update will be processed in two steps:
   <ol>
    <li>Update simulation
        <ul>
            <li>The system simulate the update, checking that:
                <ul>
                    <li>there is no manual intervention required,</li>
                    <li>there is no subversion conflict,</li>
                    <li>there is no scripts conflict.</li>
                </ul>
            </li>
        </ul>
    </li>
    <li>Real update
        <ul>
            <li>If no conflict was detected during the update simulation,</li>
            <li>After the administrator confirmation,</li>
            <li>Incremental update (one revision by one)</li>
            <li>Success test for each revision,</li>
            <li>Action feedback given to the user, for every action done for each revision,</li>
            <li>Details about upgrade scripts executions if so.</li>
        </ul> 
   </ol>
</p>
    
<h4 id="strategy">Update Strategy</h4>
<h5 id="simulationStrategy">Simulation strategy:</h5>
<p>The system first checks if there is no <strong>manual intervention required</strong> between the current revision and the requested update.
A manual intervention prohibits the update initially.
It is indeed possible to enforce the update, but we would draw your attention in the danger of such an operation 
(see section <a href="#force">Force mode</a> for details).
</p>
<p>Then, the system checks there is no <strong>subversion conflict</strong>.
For doing this, the system simulate a <strong>global</strong> update from the current revision to the requested revision.
(by using the subversion command <kbd>svn merge --dry-run -r &lt;working copy revision&gt;:&lt;requested revision&gt; &lt;subversion repository&gt; &lt;working copy directory&gt;</kbd>).
</p>
<p>The system then checks there is no <strong>upgrade script conflict</strong>.

An upgrade script will be executed if and only if:
<ul>
    <li>The script is added in the requested update <strong>and</strong></li>
    <li>It is not deleted in a later revision <strong>and</strong></li>
    <li>It is not modified after the last revision of the requested update.</li>
</ul>
In the case where the script would be modified, the only execution of the script will be processed during the last modification.<br /><br />

An upgrade script will not be executed if:
<ul>
    <li>This script is deleted in a later revision. In this case, there is two options:
        <ul>
            <li>the requested update goes up to the script deletion: in this case, the script is just ignored (not executed), and the update is possible.</li>
            <li>the requested update doesn't go up to the the script deletion: in this case, the update is not allowed. Because if a script is deleted, 
                it is possible that the revision between keep the server in an unstable state. There is so no other way but to update up to 
                the script deletion.</li>
        </ul>
    </li>
    <li>This script have been added before the current revision (the first appearance of this script in the requested update is a modification or a deletion). 
        This extremely rare situation could happened if a script is wrong <strong>and</strong> if you updated your server before the fix. In this case,
        the update is not allowed. We would manage the situation with individually.
    </li>
    <li>This script is modified in a later revision not included in the requested update. In this case, it is obligatory
        to process an update up to the last script modification.
    </li>
</ul>
</p>
<h5 id="updateStrategy">Update strategy:</h5>
After a simulation and after the update confirmation, the system will <em>almost</em> use the same strategy, except for the subversion update.
Indeed, the update is done incrementally, analysing each time the subversion return for detecting the potential errors.
The subversion command used is the following one: 
<kbd>svn update -r &lt;requested revision&gt;</kbd>

<h5 id="force">Manual intervention and Force mode:</h5>
<p>Some updates may need special interventions, that would be better manually done.
It would be operations to do <strong>in addition</strong> of the simple working copy update,
such as a file system modification, needing root permissions for example, or also an intervention that would need a temporary server stop).
In this case, the revision is labelled as needing a manual intervention and as we saw it explaining <a href="#simulationStrategy">simulation strategy</a>,
such a situation is stopping regarding the automatic update. This to catch your attention about the special type of the update
and to make you read the commit message that contains information about the the update.
However, it is possible to enforce the update, but we wish to catch your attention about the danger of such an operation.
If you don't respect the indication given in the commit message of such an update, you could find your server in an unstable state.
So, only use the "<em>force</em>" mode only if you are sure of what you do.</p>
<!-- ################################################################# -->

<hr width="100%" size="2"><br>
<h1><a name="BackupRestore"></a>Backup/Restore</h1>
<h2>Backup</h2>
<p>There are three different types of backups that run on Codendi.&nbsp;
First, MySQL data is backed up to disk using the linux "dump"
command. Second, the Subversion repositories are backed up with the backup_subversion.sh script. And finally, all disk partitions are backed up to tape
using Legato software.
</p>
<ol><li>
MySQL data
- A cron job is scheduled to run every Sunday morning at 00:45.&nbsp;
MySQL
data is backed up to disk.&nbsp; The sequence is as follows: </p>
<ul>
  <ul>
    <li> /etc/rc.d/init.d/mysql stop</li>
    <li> move old codendi-bin.index, codendi-bin.001, sqldump.&lt;last
week's date/time&gt; to</li>
    <br>
/var/lib/codendi/backup/mysql/old directory <li> dump&nbsp; 0f&nbsp;&nbsp;
/var/lib/codendi/backup/mysql/sqldump.&lt;date&gt;.&lt;time&gt;&nbsp;&nbsp;
/var/lib/mysql</li>
    <li> /etc/rc.d/init.d/mysql start</li>
  </ul>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
-&nbsp;&nbsp;&nbsp; reads /etc/my.cnf <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
-&nbsp;&nbsp;&nbsp; new codendi-bin.index created <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
-&nbsp;&nbsp;&nbsp; new codendi-bin.001 created
</ul>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
The whole MySQL data backup process takes less than 15 seconds
<p>
</li>
<li>Subversion repositories: a specific subversion backup script (/usr/share/codendi/utils/subversion_backup.sh) is run in the root crontab. 
<br>The script offers two backup mechanisms: full backup, and incremental backup (with '-i' flag). Currently, full backups are run weekly, while incremental ones are run daily.
<li>
<p>Disk Partitions - Using Legato software, a full backup of all disks (except
/tmp) is done beginning at approximately 01:00 every Sunday morning.&nbsp; It is run after the
MySQL data is backed up to disk so that the MySQL dump file goes to tape.&nbsp;
All remaining
days of the week (Monday - Saturday) run incremental backups. </p>
</ol>
<br>
<h2>Database Restore</h2>
<p>
<ol>
<li>
2 files are needed to rebuild.  Find the most recent "dump" and "bin" files:
<pre>
cd  /var/lib/codendi/backup/mysql
ls  -lt
  Example: 
  sqldump.080502.004501	(created from cron "dump" every Sunday; mysql is shut down prior to "dump")
service mysqld stop
cd  /var/lib
mv  mysql  mysql.bck
</pre>
<li>Then restore the mysql databases from sqldump.080502.004501.
<pre>
tar -vxf codendi/backup/mysql/sqldump.080502.004501.tar
</pre>
<br>
<li>Then, change the ownership and the security context of the directory:
<pre>
chown -R mysql:mysql /var/lib/mysql
chcon -R system_u:object_r:mysqld_db_t /var/lib/mysql
</pre>
<br>
<li>Finish the mysql rebuild by reloading data from codendi-bin.000001, which contains changes since sqldump.080502.004501 was created.
<br>
Boot system in single user mode:
We don't want anyone trying to update the mysql database before everything has been restored.
Before reloading date, you have to update /etc/my.cnf :<br>
Replace :
<pre>
[client]
default-character-set=utf8
</pre>
by :
<pre>
[client]
loose-default-character-set=utf8
</pre>
And then :
<pre>
service mysqld  start
cd  /var/lib/
/usr/bin/mysqlbinlog  mysql.bck/codendi-bin.000001  |  mysql --user=root  -p
password: (enter root password)
</pre>
No information will display until it's finished.
</ol>
Rebuild is complete.

<h2>Backup/Restore files</h2>
<p>There are a number of files used for backup and restore of Codendi. <br>
&nbsp;
<table border="1" cols="2" width="100%">
  <tbody>
    <tr bgcolor="#c0c0c0">
      <td><b>Location</b></td>
      <td><b>Description</b></td>
    </tr>
    <tr>
      <td>/var/lib/codendi/backup/mysql <br>
&nbsp; <br>
&nbsp; <br>
&nbsp; <br>
&nbsp; <br>
&nbsp; <br>
&nbsp; <br>
&nbsp;
      <p>&nbsp;</p>
      </td>
      <td>The three most current files found in this directory are:
      <ul>
        <li><b>sqldump.&lt;date&gt;.&lt;time&gt;:</b>&nbsp; dump of
/var/lib/mysql</li>
        <li><b>codendi-bin.index:</b> Text file indicating file name to
use
when restoring mysql data</li>
        <li><b>codendi-bin.001:&nbsp;</b> Binary log file used for
viewing or piping into a mysql command if rebuilding database</li>
      </ul>
Older files are stored in /var/lib/codendi/backup/mysql/old</td>
    </tr>
    <tr>
      <td>/etc <br>
&nbsp; <br>
&nbsp;
      <p>&nbsp;</p>
      </td>
      <td>The file found in this directory is:
      <ul>
        <li><b>my.cnf:&nbsp;</b> This file is read when mysql
starts.&nbsp; MySQL variables are set here.</li>
      </ul>
      </td>
    </tr>
    <tr>
      <td>/usr/lib/codendi/bin <br>
&nbsp;
      <p>&nbsp;</p>
      </td>
      <td>The files found in this directory are:
      <ul>
        <li><b>backup_job:</b>&nbsp; The script that runs from cron at
00:45
every Sunday.</li>
        <li><b>backup_subversion.sh:</b>&nbsp; The script that performs incremental and full backups of the subversion repositories.
      </ul>
      </td>
    </tr>
    <tr>
      <td>/etc/rc.d/init.d <br>
&nbsp; <br>
&nbsp;
      <p>&nbsp;</p>
      </td>
      <td>Codendi disks are backed up using Legato software.&nbsp; There
are
2 nsrexecd daemons running at all times.&nbsp; The script found in this
directory
is:
      <ul>
        <li><b>networker:</b>&nbsp; the script that runs at boot time</li>
      </ul>
      </td>
    </tr>
  </tbody>
</table>
</p>
<hr width="100%" size="2">
<h1><a name="CodendiTestingEnvironment"></a>Codendi Testing Environment</h1>
The Codendi source code has been modified so that multiple instances of
the
Codendi software ca run on the same physical machine. The goal here is to
allow
each developer in the Codendi Team to have his/her own source tree
available
for modification and testing and avoid any interference with other
developers.<br>
<br>
The setting of a developer's testing environment is fully document in
the
Codendi Configuration Management Plan.<br>
&nbsp;
<p> </p>
<h1><a name="Codendi_HowTo"></a>Codendi HowTo</h1>
<hr>
<h2><a name="HowTo_Import"></a>Importing an existing CVS repository in Codendi</h2>
<p>
How to properly install a project team's existing CVS repository into the Codendi project specific repository
<h3>Preamble</h3>
<P>The main thing to understand about Codendi is *each* project has its own CVS repository. This root dir is created and initialized by Codendi whenever a new
project is registered. Its name is "/cvsroot/projectname" 

<P>I insist on this point because most of the time in many organizations there is
one single CVS repository where all projects are stored. The problem with this
typical organization is that the directory named "CVSROOT" which contains CVS
config and admin files is unique and global to all projects managed by CVS. The
directory named "CVSROOT" contains files such as "modules" to declare module
name aliases, or commitinfo,rcsinfo and loginfo to trigger specific actions
when commit happens (such as e-mail notification to certain people,etc.), or
taginfo to put constraints on the TAG formats, or readers and writers which are
2 files to allow/deny access to the CVS repo.

<P>If we had one single CVS repository on Codendi then the unique and global
"CVSROOT" directory would rapidly become a big mess and it would be extremely
difficult to maintain all the project specific configurations in this single
"CVSROOT" directory. Hence the decision to have one CVS repository per project
on Codendi.

<h3>The real work</h3>

<ol>
<li>Register the project. Codendi Admin must approve it and wait for the 2 hours cron
update to create a fresh /cvsroot/projectname CVS repository with a fresh
CVSROOT directory in it. If you are in a hurry you can force the cron update by hand.

<li>Ideally the tar file provided by the team should provide both the CVS top
directories <b>*PLUS*</b> the "CVSROOT" directory from the original CVS repository. 

<li>Having the CVSROOT in the tarball is not  mandatory but if the project had
any specific settings in any of the CVS administration file (see above) then
there is no chance that the Codendi admin can rebuilt the same environment on
Codendi. In practice very few projects actually use these admin files but you
can't never know hence the request for the CVSROOT directory to be included in
the tarball. One file that is always used though is the CVSROOT/history file
where all the actions like commit, add, checkout, etc. are automatically logged
by CVS. If the team wants this file to be preserved then again the CVSROOT has
to be provided

<li>Create a temporary directory: <tt><br>cd /tmp
<br>mkdir projectname<br>cd projectname</tt>
<li> Unpack the cvs tarball provided by the project team in this temporary directory:
<br><tt> tar xvfz projectname_cvstarball.tgz</tt>

<li>Assuming that the structure is now as follows
<pre>
/tmp/projectname
   - CVSROOT
       - history  (as well as ,v files)
       - modules
       - commitinfo
       - .....
   - top_level_dir1 
   - top_level_dir2 
   - ....
   - top_level_dirN
</pre>

<li>Move all top project dir to the project specific repo: <br><tt>mv top_level_dir*  /cvsroot/projectname/</tt>
<br><b>Caution!!</b> Leave the CVSROOT directory in place for the moment

<li>Go to the project CVS repo: <br><tt>cd /cvsroot/projectname</tt>
<li>Change the ownership of the entire CVS repo: 
<br><tt>chown -R projectadminname.<i>projectname</i> top_level_dir*</tt>
<br>where projectadminname is the Codendi login of the project administrator
<li>The CVS admin files in the CVSROOT directory must be examined one by
one and the project specific instructions must be merged with the files by the
same name in the CVSROOT directory created by Codendi.
<ul>
<li><b>**Never touch**</b> the CVSROOT/readers, writers, passwd and config files created by Codendi
<li>Be careful not to overwrite what is already in the CVSROOT/loginfo and val-tags file. Append the content of these given files at the end of the corresponding ones generated by Codendi.
<li>For the history file : extract the lines belonging to the hosted project from the history file provided by the project team (remember it is very likely that
this file is global to many projects) and update the content (especially the
name of the directories and path listed in the history file if they are not the
same on Codendi)
<li>For all the other files, look at them one by one and see if there are project specific settings in it. If so append the settings at the end of the corresponding Codendi files.
</ul>
<li> Delete the temporary directory: <tt>rm -rf /tmp/projectname</tt>
<li>Ask the project team to perform a checkout as explained on their CVS project page to check that everything is working fine.
</ol>

That's all folks!

<hr>
<h2><a name="HowTo_Import_SVN"></a>Importing an existing Subversion repository in Codendi</h2>
<p>
How to properly install a project team's existing SVN repository into the Codendi project specific repository
<h3>Preamble</h3>
<P>As for CVS, it is important to understand that *each* project has its own SVN repository. This root dir is created and initialized by Codendi whenever a new
project is registered. Its name is "/svnroot/projectname" 

<h3>The real work</h3>

<ol>
<li>Register the project. Codendi Admin must approve it and wait for the 2 hours cron
update to create a fresh /svnroot/projectname SVN repository. If you are in a hurry you can force the cron update by hand.

<li>The project team should provide a dump of the existing Subversion repository. To create an SVN dump please use the following command (Unix/Linux):
<pre>
svnadmin dump /path_to_svn_root &gt; svn_dumpfile</pre>
<li>Ask the team to copy the dump file on the codendi server, e.g.:
<pre>
scp svn_dumpfile username@codendi.example.com:/home/groups/projectname</pre>
(it is also possible to use FTP instead).
<li> One may want to change svn:author property for all commits in the dump file, this can be achieved by means of svn-author-replace.pl
    This is usefull when authors are not known or known under another login name in the codendi platform
    <pre>perl /usr/share/codendi/src/utils/svn/svn-author-replace.pl -f svn_dumpfile -u user_map.txt > new_svn_dumpfile</pre>
    where svn.dump is the subversion dump file, and user_map.txt a file with author name to change (1 user per line) old_author_name=new_author_name
    default=default_login may be added to process unknown users.
<li>then a Codendi site administrator needs to load the repository content into the existing repository on Codendi:
<pre>
svnadmin load /svnroot/projectname &lt; /home/groups/projectname/new_svn_dumpfile </pre>
<li>Then, don't forget to set proper Unix ownership on the repository:
<pre>
chown -R codendiadm.projectname /svnroot/projectname</pre>
<li>if the existing repository had specific permissions or hooks, it is now time to copy the corresponding files on the new repository. This can be done by the project team.
<li>History can be imported into the Codendi database, this is possible with svn-commit.pl (/usr/share/codendi/src/utils/svn/)
    <pre>perl /usr/share/codendi/src/utils/svn/svn-commit.pl -p /svnroot/myproject/ -r r1:r2</pre>
</li>
<li>Once the team has tested the new repository, you can remove the dump file from /home/groups/projectname/svn_dumpfile.</li>
</ol>

You're done!

<h3>Merging multiple repositories</h3>
<p>It is possible to merge several repositories by using <a href="http://www.coelho.net/svn-merge-repos.html">svn-merge-repos.pl</a> script</p>
<li>One must first get local copy of all repositories to merge into the codendi project repository, then issue the following command</li>
<pre>
perl svn-merge-repos.pl -t /var/lib/codendi/svnroot/project_name/ /local/path/to/repo1/:target_path_for_src1 /local/path/to/repo2/:trunk/target_path_for_src2
</pre>


<hr>
<h2><a name="HowTo_Import_Git"></a>Importing an existing Git repository in Codendi (bare repository)</h2>

<p> All repositories are stored under /var/lib/codendi/gitroot/. Each project has a project directory 'myproject',
    for instance /var/lib/codendi/gitroot/myproject/reference1.git with persmissions (drwxrwsr-x codendiadm myproject).
    Several steps must be achieved before being able to use a git repoitory in codendi.
</p>
<ul>
    <li>Create the repository from within the web interface</li>
    <li>Replace the empty repository with the one you want to import</li>
    <li>Set permissions :
        <ul>
            <li><tt>$> chown -R codendiadm:myproject /var/lib/codendi/gitroot/myproject/myrepo.git</tt></li>
            <li><tt>$> find /var/lib/codendi/gitroot/myproject/myrepo.git -type d | xargs chmod u+rwx,g+rwxs,o-rwx </tt></li>
            <li><tt>$> chmod g+w /var/lib/codendi/gitroot/myproject/myrepo.git/HEAD</tt></li>
            <li>make a private repo : <tt>$> find  /var/lib/codendi/gitroot/myproject/myrepo.git -type d ! -path "*hooks*" | xargs chmod o-rwx </tt></li>
            <li>make a private repo : <tt>$> find  /var/lib/codendi/gitroot/myproject/myrepo.git -type f ! -path "*hooks*" | xargs chmod o-rwx </tt> </li>
            <li>NOTICE : Do not forget to check hooks permissions</li>
        </ul>
    </li>
    <li>Test it through the web interface</li>
</ul>

<hr>
<h2><a name="HowTo_Regenerate_VC"></a>Regenerating a fresh CVS or SVN repository for a Codendi project</h2>
<em>When the first import goes wrong or the project team screwed up everything and want to start again from scratch</em>
<p>
The fastest and safest way (where xxx is the project name):
<ul>
<li>Log as root
<li>cd /cvsroot for a CVS repository, or cd /svnroot for a SVN repository
<li>Make a backup copy of the current tree in /tmp just in case...:
<br><tt>tar cvfz /tmp/xxx_repository.tgz ./xxx   </tt>
<li>Delete the CVS or SVN tree: <br><tt>rm -rf  xxx</tt>
<li>Force the cron update process to run now.
<li>Delete corresponding entries from cvs_checkins, cvs_commits and cvs_descs tables to prevent showing them while browsing commits with viewVC.
</ul>
Now you have a fresh CVS or SVN repository and the team can start the import again.
<hr>
<h2><a name="HowTo_Change_User_Name"></a>Changing a User Name on Codendi</h2>
<em>How a Codendi administrator can change a user's login name</em>
<UL>
<LI>Log as root on the codendi server</LI>
<li>First of all, make sure that the new login name is not already used!</li>
<li>Second of all, make sure that the Xerox cron job won't run while you do the update (you may edit the root crontab if necessary)!</li>
<LI> Rename the user home directory:
<br><tt>   mv /home/users/old_name /home/users/new_name</tt>
<br>
</li>

<LI> Edit each of the CVS writers file for the projects the user belong to and modify the name. You can find all the relevant writers file by typing the following Unix command:<br>
<tt>grep -rsl old_name /cvsroot/*/CVSROOT/writers</tt>
</LI>

<LI> Edit Subversion permission files for the projects the user belong to and modify the name. You can find all the relevant files by typing the following Unix command:<br>
<tt>grep -rsl old_name /svnroot/*/.SVNAccessFile</tt>
</LI>

<LI> Use phpMyAdmin, browse the "user" table, look for the row corresponding to the user, edit the row and modify the name.<br>
Alternatively you can start the MySQL shell and type the following SQL statement:<br>
<tt>update user set user_name='new_name' where user_name='old_name';</tt></LI>

<LI>Do the same for the email column in the artifact_cc table. Or use the following SQL statement:<br>
<tt>update artifact_cc set email='new_name' where email='old_name';</tt></LI>

<LI>Do the same for the addresses column in the artifact_global_notification table. Or use the following SQL statement:<br>
<tt>update artifact_global_notification set addresses='new_name' where addresses='old_name';</tt>
<br>Please note that it will only update the address if it is not part of a list of addresses. To check if it is part of a list of addresses, use:<br>
<tt>SELECT * FROM artifact_global_notification WHERE addresses LIKE '%old_name%'</tt>
<br>and update entries if any.</LI>

<LI>To keep wiki preferences and notifications, rename the user wiki page (make sure the new page does not exist yet):<br>
<tt>update wiki_page set pagename = 'new_name' where pagename = 'old_name';</tt></LI>

<LI><b>Legacy tracker only: </b>Do the same for the from_email column in the support messages table. Or use the following SQL statement:<br>
<tt>update support_messages set from_email='new_name' where from_email='old_name';</tt></LI>

<LI><b>Legacy tracker only: </b>Do the same for the email column in the bug_cc table. Or use the following SQL statement:<br>
<tt>update bug_cc set email='new_name' where email='old_name';</tt></LI>

<LI><b>Legacy tracker only: </b>Do the same for the email column in the project_cc table. Or use the following SQL statement:<br>
<tt>update project_cc set email='new_name' where email='old_name';</tt></LI>

</UL>
<p>
Remark: if the user has already committed changes in the cvs repository,
then the old name will still appear in the CVSROOT/history file and the
various *,v files (CVS version files). Changing the various "history"
files is possible but changing the *,v files is perilous and frankly
it is is not necessary.

<hr>

<h2><a name="HowTo_Change_Project_Name"></a>Changing a Project Short Name on Codendi</h2>
<p>
<em>How a Codendi administrator can change a project short name. </em>

<P>The project short name is defined a registration time. It is also known
as group name because it each project has a Unix group of the same name
on the Codendi server. Here is the procedure to follow to change a group name (assuming the old project name is 'xxx'):

<P><b>**IMPORTANT NOTE**</b> Before you start the procedure below make sure you have enough time to complete the task before the next cron job runs.

<ul>
<li> First log as root
<li>Change the old project name 'xxx' in the following directories:
<ul><tt>
<li>/var/lib/codendi/ftp/pub 
<li>/var/lib/codendi/ftp/codendi 
<li>/home/groups 
<li>/cvsroot
<li>/svnroot
</tt></ul>
<li>Edit <tt>/etc/cvs_root_allow</tt> and change project name

<br>Comment: the last one would be done automatically at the next cron update but doing it by hand keep everything consistent with the next step<br>

<li>Checkout the CVSROOT directory of the project:
<tt>cvs -d:pserver:username@codendi.example.com:/cvsroot/projectname co CVSROOT</tt>.
Then edit the 'config' and  'commitinfo' files and change the project name wherever it appears. Last, commit the changes. (you may also directly edit those files in the /cvsroot/projectname/CVSROOT directory, but don't forget to also edit the ',v' files then).

<li>Edit the 'groups' table of the Codendi DB with phpMyAdmin and change
the name (2 occurrences in 2 columns: <tt>unix_group_name,
http_domain</tt>). Then edit the 'service' table, and change the link to the 'Project Summary' and potentially to the 'Project Home Page'. All other fields can be changed by the project admin via the Web interface.

</ul>

<p><b>Remark</b>: If there are mailing lists with existing content in the archive it is
not clear for the moment how to rename the mailing list. So in this case it
probably means creating new (empty) mailing lists for the new project.
Of course one can still keep the ones with old project names in it. This is
no problem.
<br>See additional hints there:<a href="https://www-s.acm.uiuc.edu/wiki/space/Rename+Mailman+lists">https://www-s.acm.uiuc.edu/wiki/space/Rename+Mailman+lists</a>.

And voil&agrave;!

<hr>

<h2><a name="HowTo_Email_pb"></a>New user registration problems - email address errors</h2>
<p><em>What to do when you get a message from postmaster with an attached new user registration confirmation message</em>
<p>
It is fairly common for a new Codendi user to enter the wrong email address
when registering.  When Codendi sends the
registration confirmation message to the new user, the message bounces at
whatever mail server owns the non-existent address, and a message is sent
back to the originator (aliased to the Codendi administrators) saying that the
message could not be delivered, with the registration confirmation message
attached.  What we then need to do is forward this to the user who is trying
to register on Codendi, with an explanation of what happened and what the user
needs to do next (complete the registration by following the link in the
attachment).  We may also decide to fix the email address for the user, if
we know what it should be.<P>

But first you have to track down the user.  (You can't just send mail to
the address in the message.  I mean, it didn't work :-).)  Your main sources
of information are the Xerox Outlook/Exchange Address Book and Codendi itself.<P>
<UL>
<LI>The mistake most users make is on the part of the mail address after the
'@'.  Since our Outlook mail addresses are always of the form
firstname.lastname@<I>something</I>.xerox.com, it is usually easy to look up
'lastname, firstname' in the Outlook Address Book.  Opening the entry brings
up a dialog box with an E-mail Addresses tab.  Selecting this tab will show
all of the smtp addresses for the user.</LI>

<LI>In order to fix the address on Codendi, you must find the new user.  As an
administrator, the way to do this is to follow the User Admin link from the
Site Administration list in the column on the left.  (You can't see this
list unless you are a site administrator.)  The User Admin page,
<A HREF=/admin/userlist.php>http://codendi.example.com/admin/userlist.php</A>, displays an alphabetical list of
Codendi/Unix user name links.  Each user name begins a row of links, including
DevProfile, Activate, Delete, and Suspend.  We are interested here in the
user name link itself and the DevProfile link.</LI>

<LI>You have to guess what the user's Codendi user name is, based on the user's
real name, which is hopefully in their mail address.  Most people are
accustomed to using their last names, the first letter of their first name
followed by their last name, their first name followed by the initial of
their last name, their first name only, etc.  John Smith is probably smith,
jsmith, johns, or john.  User names for which registration is incomplete are
shown in non-boldface with a preceding asterisk.  If you see a "*jsmith"
entry in the user list, you have probably found the user, in our example.
If John Smith has decided to make his user name 'gandalf' (because there is
already a jsmith), then you have a problem.  Worst case is that you need to
process the user list, looking at all of the names preceded by an asterisk,
as described below.</LI>

<LI>In order to look at the attributes of a user name, just follow the link.
You'll see a page with the user's shell (/bin/bash by default), Unix account
status, and email address.   If you have found the right user, the email
address is the one that failed, same as in the postmaster message sent to
you.  You could fix it now, if you know the right address, but note that
many people in Xerox, particularly in XR&T, have multiple SMTP addresses,
and preferences for one over another.  If you have any doubt about what to
do, turn the problem over to the user, by explaining in your note to the
user how to change his/her address.  (Follow the Account Maintenance link in
the left column and then follow Change Email Addr.)</LI>

<LI>Sometimes you want to follow the DevProfile link from the user list, in
order to verify the user's real name.</LI>
</UL>
You could also just Activate the user now, instead of requiring them to
follow the link in their account registration confirmation message, but it
seems better to engage them.  The mail address has to be fixed, and they
should be aware that it was wrong and either correct it or consciously agree
to the fixed version.  I once 'helped' someone by fixing the address, and
they changed it back to its original form, and complained that the Codendi
mail service should have been able to find it.  (True.  There was a problem
with Codendi mail at that time.)<P>
<BR>
John Stidd

<hr>

<h2><a name="HowTo_Block_Client"></a>Blocking a Client from Accessing Codendi</h2>
<p><em>How to block a client from accessing http or other services on Codendi</em>
<p>
It is possible that a client could continuously try accessing Codendi, causing unwanted activity.
This could cause the /var/log/httpd/error_log or access_log to continually grow with errors,
which in turn can fill up the root partition.  There is a way to block the client from accessing
Codendi until the owner can be contacted or the cause of the continual access can be cleared up.
<BR></P>

<H3>To deny http access to a client:</H3>
<p>1)  Modify /etc/httpd/conf/httpd.conf:
</P>
     <DD>&nbsp; Example of how to deny http access to 13.0.33.210:<BR>
     <DD>&nbsp; Look for the section of httpd.conf that contains the first 4 lines shown below and add line 5:
 
                  <DD>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Controls who can get stuff from this server.
                  <DD>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #
                  <DD>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Order allow,deny<BR>
                  <DD>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Allow from all<BR>
                  <DD>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Deny from 13.0.33.210 &nbsp; &nbsp; &nbsp; &nbsp; &#9;<I>(line to be added)</I></P>

2)  /etc/rc.d/init.d/httpd restart

<H3>To deny access to everything in inetd.conf (like ftp):</H3>
1)  Modify /etc/hosts.deny:
     <DD>Example of how to deny access to 13.0.33.210:
                   <DD>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ALL: &nbsp; &nbsp; &nbsp; &nbsp;  13.0.33.210 &nbsp; &nbsp; &nbsp; &nbsp; &#9;<I>(line to be added)</I>
                                      
Vicki Tuttle


<hr>

<h2><a name="HowTo_Suspend_User"></a>How to suspend/delete a Codendi user</h2>
<p><em>What to do with users who left the company or whose e-mail address is no longer valid</em>
<p>
Codendi is a system where any Xerox employee can register. When an
employee leaves the company the account remains valid and the Codendi
administrators discover that the user is no longer with the company
when the mass mail engine is used to send an announcement to all
users.

<P>The goal of this document is to document what to do with these
invalid accounts.

<h3>How to delete a user</h3>

<h4>Project member</h4>

<P>If the user was part of a project then do the following:

<ul>
<li>Set the Web status to 'Deleted'
<li>Set the Unix Status to 'Suspended'
</ul>

<p>See below for more information on how to change these status values.

<p>To determine whether a user is a project member. Use the "Search
People" box using the user e-mail or name then click on the
appropriate result and see if any project is listed on the upper right corner of the screen.

<p>By doing so, the Unix account is inhibited which is what we want for
security reasons but it is still here so all the files on the Codendi
server marked with this user uid will still appear as being owned by
this user. On top of that it is perfectly ok to suspend a Unix account
as soon as we have an e-mail error for sbdy and if this person comes
back to us complaining that his/her account is no longer accessible we
can restore the account very quickly with no data loss at all (and ask
him/her to update her e-mail address)

<P>In case of doubt or if you are in a hurry and don't have time to
check whether a user is a project member then always use this
scenario. <u>Actually we should probably always use this scenario to
start with and then once in a year change the Unix status to 'Deleted'
when we have no news from the user</u>

Before you suspend a user account have a look in the Xerox directory
and see if the person has a new e-mail. If so then you might want to
update the e-mail or send him/her a reminder to do it via the "Account
Maintenance" page on Codendi.


<h4>Non project members</h4>

<P>If a user is not a project member <b>and</b> we are sure s/he left the
company (permanent e-mail error returned not transient) then do the
following:

<ul>
<li>Set the Web status to 'Deleted'
<li>Set the Unix Status to 'Deleted'
</ul>

<P>The Unix account is deleted for real, the user home directory is
deleted as well. 

<h4>Note:</h4>
<p>If there is only a couple of accounts to suspend/delete then going through the Web interface is the best way. If there are many users do the following:

<ol>
<li>Have a Codendi Web page ready and open on the Search people box. Type part of people's name in the box and determine the login name from the result list
<li>Have a terminal session open on the Codendi server and connect to the database with:<br><br>
<tt>mysql -u codendiadm codendi -p</tt><br><br>
then use the following SQL statement for Suspend/Delete scenario: <br><br>

<tt> update user set unix_status='S',status='D' where user_name='fmarcus';</tt>
<br><br>
or for the Delete/Delete scenario use: <br><br>

<tt> update user set unix_status='D',status='D' where user_name='fmarcus';</tt>
</ol>
<br>


<hr>

<h2><a name="HowTo_Recompile_RPM"></a>Recompiling a Codendi specific RPM</h2>
<p><em>Explain how to regenerate a Codendi specific RPM from the standard RPM</em>
<p>
<ol>
  <li>Log as root on a test server</li>
  <li>Go to /usr/src/redhat/SPECS</li>
  <li>Install the previous codendi specific RPM in source form if
necessary to get the specific patches and also the specific spec file</li>
  <li>Install the new version&nbsp; of the standard source RPM</li>
  <li>Make a diff between the old codendi specific spec file and the new
standard spec file to see what are the changes.</li>
  <li>Merge the changes you made in the old codendi specific spec file in
the new spec file</li>
  <li>Don't forget to append the 'codendi' suffix to the release name in
the new spec file.</li>
  <li>Also change the name of the new spec file to reflect the version
number and the codendi prefix (e.g. cvs-1.11.1p1-8.7.spec)</li>
  <li>Recompile the package (rpm -ba ... to generate both the source
and the binary package</li>
  <li>Install the new modified binary RPM package on the test server
and make sure it works ok<br>
  </li>
  <li>Publish the new packages (both source and binary) in the package
release space (/home/groups/codendi/htdocs/packages/RPMS_Codendi)</li>
  <li>Send an email to the codendi-devel mailing list to announce the
availability of the new codendi specific package and point them to the
RPM release space ( <a href="https://codendi.partners.xrce.xerox.com/packages/">http://codendi.partners.xrce.xerox.com/packages/</a>
...)</li>
</ol>


<hr>

<h2><a name="HowTo_Change_PW"></a>Change privileged account passwords</h2>
<p><em>Steps to change privileged account passwords</em>
<p>Some companies have specific policies regarding passwords.

</p>

<p><b>root</b> account:
<br>
1) Change <i>unix</i> password from <b>root </b>account:
<br>

password (cr)
<br>
[enter new password]
<br>
[retype new password to confirm]
<br>
2) Change <i>mysql</i> password:
<br>
mysqladmin --user=root -p password [new_password]
<br>
enter password: [enter old password]
</p>

<p><b>codendiadm</b> account:

<br>
1) Change <i>unix</i> password from <b>codendiadm</b> account:
<br>
password (cr)
<br>
[enter new password]
<br>
[retype new password to confirm]
<br>
2) Change <i>mysql </i>password:
<br>
mysqladmin --user=codendiadm -p password [new_password]
<br>
enter password: [enter old password]
<br>
3) Modify /etc/codendi/conf/database.inc 
<br>- change <b>codendiadm</b> password<br>
</p>
<p><b>admin</b> account:

<br>
- The "admin" account is the first user that is created when a new
Codendi site is created.
<br>
- The "admin" account is used as an "administrator" for orphaned
projects.
<br>
- The "admin" <i>unix</i> account is not a privileged account.
<br>
- If you have defined other site administrators, you might as well suspend the "admin" account
  (thus, you won't need to update its password).
<br>
1) Change <i>unix</i> and <i>mysql</i> password for <b>admin</b> from Codendi website:
<br>
- Go to the Codendi web site
<br>
- Log in as <b>admin</b>
<br>
- Click "Account Maintenance" in left bar
<br>
- Click "[Change Password]"
<br>
- Follow directions for changing password

</p>
<p><b>mailman</b> account:
<br>
- The "mailman" account has the universal password
for mailing lists.
<br>
1) su -
<br>
2) cd /usr/lib/mailman/bin
<br>
3) ./mmsitepass
<br>
[enter new password when prompted]
<br>
4) Change <i>unix</i> password from <b>root</b> account:
<br>
password mailman
<br>
[enter new password when prompted]
<br>
[retype new password to confirm]
<br>
- To test the mailman account:

<br>
- Go to
http://lists.codendi.example.com/mailman/admin
<br>
- Click on any mailing list
<br>
- Type new global admin password
<br>
If you see the admin page
of the selected mailing list, then it is OK.
</p>


<hr>

<h2><a name="HowTo_Delete_Bug"></a>Delete a bug from the Codendi database</h2>
<p><em>Delete a bug with its given bug_id from all concerned DB tables.</em>

<p>Some projects might ask to delete submitted bugs from Codendi because of sensitive data that the bug information contains. While the functionality "delete bug" is not integrated into Codendi you can use this little sql script to do the work by hand.</p>

<p><tt>
	SET @bug_id = <i>your_bug_id</i>;<br><br>

	DELETE FROM bug WHERE bug_id=@bug_id;<br><br>
	
	DELETE FROM bug_bug_dependencies WHERE bug_id=@bug_id;<br>
	DELETE FROM bug_bug_dependencies WHERE is_dependent_on_bug_id=@bug_id;<br><br>
	
	DELETE FROM bug_task_dependencies WHERE bug_id=@bug_id;<br><br>
	
	DELETE FROM bug_cc WHERE bug_id=@bug_id;<br><br>
	
	DELETE FROM bug_file WHERE bug_id=@bug_id;<br><br>
	
	DELETE FROM bug_history WHERE bug_id=@bug_id;<br><br>
      </tt>
    </p>

<p>Save this script for instance as <tt>del_bug.sql</tt> and launch it with <br>
      <tt>mysql -u codendiadm -v -v -v -p codendi &lt; del_bug.sql &gt; out</tt>
</p>


<hr>

<h2><a name="HowTo_Restricted_Users"></a>Enabling 'Restricted Users' on a Codendi server</h2>
<p><em>Enabling restricted users to benefit from code sharing without compromising security.</em>

<h3>Overview</h3>
<p>One of Codendi main benefits is to enable code sharing and re-usability in a corporation. The goal is to provide visibility of your project and code in the whole community of users. Still, in some cases, this visibility becomes an issue: 
<ul><li>When Codendi is used for customer interaction, e.g. to collect customer support requests and bugs. 
<li>when some project members are from other companies (contractors), and should not have access to the whole site
</ul>
<p>In both cases, external people (customers and contractors) need an access to the server; yet, they should not be granted access to all the other projects hosted on Codendi.
<p>A solution to this problem has already been put in place: use two servers instead of one (one for internal use, one for 'partners'). Yet, there is an issue with projects that are being developed internally and that have customer feedback. In this case, you need to duplicate the project, which is not convenient; customers cannot access commit pages referenced in commit emails (because they point to the internal server),etc.
<p>Now, there is another solution by enabling restricted users on your server: these users (typically, external users), are granted access to their project pages only, and are denied access to any other page (other projects, software map, etc.). Normal users still have access to the whole server.

<h3>Configuration</h3>
<h4>local.inc</h4>
<p>In order to setup restricted users, you need a coherent local.inc.
<p>Edit /etc/codendi/conf/local.inc and make sure that the following variables are properly set:
<pre>
$sys_user_approval = 1;
$sys_is_project_public = 1;
$sys_allow_anon = 0;
$sys_allow_restricted_users = 1;
</pre>
<p>Some explanation:
<ul><li><b>$sys_user_approval = 1</b> is needed because it is during the user approval phase that the Codendi administrator is able to set the user status to 'Restricted' (R) or 'Active' (A). If the variable is set to '0', users will be created as Active by default.
<li><b>$sys_is_project_public = 1</b> is not absolutely necessary. It just seems useless to have restricted users if all projects are private.
<li><b>$sys_allow_anon = 0</b> is needed. Otherwise, anonymous users (i.e. users who have not logged in) would have more privilege than restricted users. So a restricted user would simply need to log out to be able to browse other projects, etc.
<li><b>$sys_allow_restricted_users = 1</b> simply enables the 'Restricted' status for users.
</ul>
<h4>Restricted Shell</h4>
<p>By default, restricted users do not have a regular shell access: they are given a restricted shell access that only supports a few command (only 'cvs' today).
<p>The default shell is '/usr/lib/codendi/bin/cvssh-restricted'. It grants CVS access to projects the user is member of, and forbid access to all other projects repositories.
<p>If you need to completely remove shell access (and forbid CVS), you need to modify the shell manually in the administration interface for each user: set it to /sbin/nologin.
<p>Setup: in order to use CVS, the restricted user must do the following:
<ul><li>Set the 'CVS_RSH' environment variable to 'ssh'
<li>use the following command line: cvs -d:ext:username@codendi.example.com:/cvsroot/projectname co module
</ul>
See also 'Codendi Installation Guide'.
<h3>Setting restricted users privileges</h3>
<p>You may fine tune the privileges of restricted users on your system. Simply copy /usr/share/codendi/site-content/en_US/include/restricted_user_permissions.txt in /etc/codendi/site-content/en_US/include/ and edit it. This is a sample configuration file:
<pre>
// comment/uncomment forbidden URLs
$forbidden_url = array(
          '/snippet/',     // Code Snippet Library
          '/softwaremap/', // browsable software map
          '/new/',         // list of the newest releases made on the Codendi site
          '/search/',      // search for people, projects, and artifacts in trackers!
          '/people/',      // people skills and profile
          '/stats/',       // Codendi site statistics
          '/top/',         // projects rankings (active, downloads, etc)
          '/project/register.php',    // Register a new project
          '/export/',      // Codendi XML feeds
          '/info.php'      // PHP info
          );

// Use true/false for those options
$allow_welcome_page=false;// Allow access to Codendi welcome page (at e.g. http://codendi.example.com/)
$allow_news_browsing=false;     // Allow restricted users to read/comment news, including for their project
$allow_user_browsing=true;      // Allow restricted users to access other user's page (Developer Profile)
$allow_access_to_codendi_forums=true;   // Codendi help forums are accessible through the 'Discussion Forums' link
$allow_access_to_codendi_trackers=false;// Codendi trackers are used for support requests on Codendi
$allow_access_to_codendi_docs=false; // Codendi documents (Note that the User Guide is always accessible)
$allow_access_to_codendi_mail=false; // Codendi mailing lists (Developers Channels)
</pre>
<h3>Other considerations</h3>
<ul>
<li>Restricted users must be denied access to the pserver protocol to access CVS: only the SSH method is supported (through the restricted shell). If you want to disable the pserver access, make sure you edit/etc/xinetd.d/cvs, change the 'disable' parameter to 'yes' and restart xinetd (service xinetd restart). You may also fine-tune the configuration file to allow pserver for some IP addresses and deny it for others..
<li>Access to projects web sites by Restricted Users is not controlled. If a project web site displays sensitive data, then it should put in place access restriction mechanisms (e.g. a '.htaccess' file).
<li><strong>Subversion</strong>: currently, if the sys_allow_restricted_user variable is set to '1', subversion repositories have their default access policy changed: by default, only project members have read access (as well as write access). If other users need to access the SVN repository, they need to be individually added to the subversion access file (through the svn admin page).
</ul>


<hr>


<h2><a name="HowTo_Localize_Services">Localize service names</a></h2>
<p>

If you would like to add new system-wide or project-wide services please note the following:
<p>
For those service names to be localized, we store a simple key for the service label and description in the database. 
These keys are then translated into the users current language by doing a look up of the key in the 
site_content/<<i>language</i>>/project/project.tab file.
<p>
The keys follow a simple pattern:
<ul>
<li> <tt>service_<<i>service short name</i>>_lbl_key</tt> for the service label
<li> <tt>service_<<i>service short name</i>>_desc_key</tt> for the service description
</ul>

To assure the correct localization when adding a new service please follow the instructions below:
<ul>
<li> Choose <tt>service_<<i>service short name</i>>_lbl_key</tt> as service label
<li> Choose <tt>service_<<i>service short name</i>>_desc_key</tt> as service description
<li> Add two entries into each <strong>site_content/<<i>language</i>>/project/project.tab</strong>
<p>
<tt>
project_admin_editservice	service_<<i>service short name</i>>_lbl_key	<<i>your localized service label</i>><br>
project_admin_editservice	service_<<i>service short name</i>>_desc_key	<<i>your localized service description</i>>
</tt>
</ul>

<hr>


<h2><a name="HowTo_cvs2svn">Convert a CVS repository to Subversion</a></h2>
<p>
Some projects may want to switch from CVS to Subversion. There are many good reasons for this, e.g. performance increase over CVS as well as many new features like directory and symbolic link versioning, file and directory move, truly atomic commits, etc.
<p>Unfortunately, project members cannot do the full conversion process by themselves because of permission issues.
<p>Here are the step-by-step instructions:
<ul>
<li>Log in as root.
<li>If not already done, install cvs2svn from <a href="http://cvs2svn.tigris.org">http://cvs2svn.tigris.org</a>
<li>Check that the SVN repository is empty:
<pre>svnlook info /svnroot/projname</pre>
<li>Then simply type:
<pre>cvs2svn --existing-svnrepos -s /svnroot/projname --tmpdir=/tmp /cvsroot/projname</pre>
You might need to add "--encoding=iso8859-1 --encoding=utf_8" if the conversion process stops because of character encoding issues.
<br><b>Note:</b> If the conversion fails with a Berkeley DB error, this might be caused by BDB version differences between the svn client (v1.2+) and the svn repository (v1.0 or v1.1). In this case, delete the old repository, and recreate it with the backend script. Actually, you should also upgrade all existing svn repositories that use the deprecated version of BDB...
<li>This will convert the CVS repository with all the historical information (including all commits, tags and branches).
To select a set of historical data, please read: <a href="http://cvs2svn.tigris.org/cvs2svn.html">http://cvs2svn.tigris.org/cvs2svn.html</a>
<li>You should then set proper ownership on the repository:
<pre>chown -R codendiadm.projname /svnroot/projname</pre>
<li>Activate the Subversion service in Codendi if it is disabled.
<li>You may also populate the Codendi DB with subversion revision details: you need to execute as codendiadm '/usr/lib/codendi/bin/commit-email.pl NNN' for each revision number (NNN) created. Please note however that CVS commits performed by people whose login name does not correspond to Codendi logins won't appear.
</ul>

<hr>
<h2><a name="HowTo_restoresvn">Restore a Subversion repository</a></h2>
<p>
Subversion repositories are backed up every day. So it is always possible to restore the repository as it was the day before.
<br>There are two Subversion backup directories:
<ul><li>/var/lib/codendi/backup/subversion/full contains the full backups performed weekly
<li>/var/lib/codendi/backup/subversion/incr contains the incremental backups performed daily.
</ul>
In order to restore the most recent version of the repository, you need:
<ul><li>to restore the most recent full backup: 
<br>simply copy /var/lib/codendi/backup/subversion/full/current/projectname-rev1 as /svnroot/projectname, and note the number 'rev1'.
<li>then restore the incremental backups starting with 'rev1+1':
<pre>
cd /var/lib/codendi/backup/subversion/incr/projectname
bunzip2 < projectname.incr.rev1+1:rev2.bz2 | svnadmin load /svnroot/projectname 
bunzip2 < projectname.incr.rev2+1:rev3.bz2 | svnadmin load /svnroot/projectname 
etc.
</pre>
<li>Last, restore appropriate permissions:
<pre>
chown -R codendiadm.projectname /svnroot/projectname
</pre>
</ul>


<hr>
<h2><a name="HowTo_recoversvn">Recover a Subversion repository</a></h2>
<p>
Subversion repositories based on Berkley DB might get corrupted if a 'svn' command crashes.
In that case, access to the Subversion repository is denied (even for read access, e.g. with viewVC).
<p>For instance, TortoiseSVN returns this error code: 
<pre>Error 500 - internal server error trying to update on project projectname
</pre>
In this case, you need to recover the repository.
<br>As root, run the following commands:
<pre>
svnadmin recover /svnroot/projectname
chown -R codendiadm.projectname /svnroot/projectname
</pre>
<p>In case the "svnadmin recover" command still fails you can use the low level repair utility of Berkeley DB:
<pre>
cd /svnroot/projectname/db
db_recover -c -v
chown -R codendiadm.projectname /svnroot/projectname
</pre>


<hr>
<h2><a name="HowTo_cleansvn">Clean-up a Subversion repository</a></h2>
<p>
Sometimes a user might ask you to clean-up a SVN repository because he made mistakes in the import for instance.
<br>Here is how to partially do it:
<p>Delete (or archive) the SVN repository:
<pre>
tar cfz /var/tmp/projname_svn.tgz /svnroot/projname
rm -rf /svnroot/projname
</pre>
<p>Then you need to clean-up the entries in the DB:
<ul>
<li>Launch phpMyAdmin
<li>Get the repostory id from svn_repositories table.
<li>Manually execute this command
<pre>
DELETE FROM svn_commits WHERE repositoryid =your_repo_id;
</pre>
</ul>
<p>WARNING: This will remove visible entries, but will keep "zombie" entries in svn_checkins, svn_dirs and svn_files
</p>

<hr>
<h2><a name="HowTo_distributed">Set up a distributed architecture</a></h2>
<h3>Introduction</h3>
Codendi now supports a distributed architecture that allows some services (currently: Files and Subversion)
to be located on satellite servers. 
<p>Please note that this feature is still <b>experimental</b>.


<h3>Setup</h3>
<dl>
    <dt>In /etc/codendi/conf/local.inc:</dt>
    <dd>
        Choose a sys_server_id for the master and the satellite (any integer is OK)
    </dd>
    <dt>In /etc/codendi/conf/database.inc:</dt>
    <dd>
        both servers should point to the master MySQL server. 
    </dd>
    <dt>In MySQL on the master server:</dt>
    <dd>Do not forget to enable remote access from the satellites in mysql :
        <pre>GRANT ALL ON codendi.* TO codendiadm@<em>satellite.domain.com</em> IDENTIFIED BY '<em>xxxx</em>'</pre>
        Where 'xxxx' is the database password for codendiadm. See <a href="http://dev.mysql.com/doc/refman/5.0/en/grant.html">mysql documentation</a> for details.
    </dd>
    <dt>In Codendi web interface:</dt>
    <dd>
        Create servers (in site administration panel / Servers Administration) according to your architecture. There should be one entry for each server (master or satellites). You must also select which server is the master on this page ('Choose the master').
</dd><dd>
 In the service selection page of the creation process, select the appropriate server for the Subversion and File services. Currently, you need to be a site administrator to change the location of a service.
    </dd>
</dl>
<h3>Project configuration</h3>
<p>There are two ways to enable distributed services for a project:
<ul>
<li>At creation time: select a template that has already set satellite services. In the service selection page, you will be able to choose the satellite for SVN and File services.
Please note that the default template does not allow selection of satellite services.
<li>Once the project is created, it is still possible to set a satellite for one of the distributed services. However, only site administrators are able to set this parameter in the service administration page.
</ul>
<h3>Migration</h3>
<p>It is possible to relocate a service that already has some historical data.
<h4>Files</h4>
<p>Make a tarball of the /var/lib/codendi/ftp/codendi/<i>projname</i> directory on the server that contains the existing data, and un-tar the files at the same location on the new server.
<h4>Subversion</h4>
<p>Similarly, make a tarball of the /svnroot/<i>projname</i> directory on the server that contains the existing data, and un-tar the files at the same location on the new server.
<h3>Single Sign-on</h3>
<p>If you want Single Sign-on (SSO), all servers must be in a similar domain. Then, you must set the same cookie domain and the same cookie prefix for all servers (master and satellites).
<pre>


                         +------------------------------------+
                         |        master.domain.com           |
                         +------------------------------------+
                         | sys_server_id     = 1              |
                         | sys_cookie_prefix = 'CX1234'       |
                         | sys_cookie_domain = '.domain.com'  |
                         | sys_dbhost        = 'master'       |
                         |                                    |
                         +-------------.----.=----------------+
                                   _.-'       `-._
                                .-'               `-.._
                            _.-'                       `-._
                         .-'                               `-.__
                     _.-'                                       `-._
    +-------------.-'--------------------+    +---------------------`-.------------+
    |      sata.domain.com               |    |       satb.domain.com              |
    +------------------------------------+    +------------------------------------+
    | sys_server_id     = 2              |    | sys_server_id     = 3              |
    | sys_cookie_prefix = 'CX1234'       |    | sys_cookie_prefix = 'CX1234'       |
    | sys_cookie_domain = '.domain.com'  |    | sys_cookie_domain = '.domain.com'  |
    | sys_dbhost        = 'master'       |    | sys_dbhost        = 'master'       |
    |                                    |    |                                    |
    +------------------------------------+    +------------------------------------+

</pre>
<p><b>Note:</b> If you use other Codendi servers in the same domain that are not part of the distributed architecture, they should use a different cookie prefix to avoid session collisions.


<hr>
<h2 id="HowTo_passwords">Validators for users' password</h2>
<p>You can define rules to validate users' passwords. Here is an example of rules :</p>
<ul>
    <li>Password must contain at least 8 characters</li>
    <li>Password must contain at least 2 capital letter</li>
    <li>Password must contain at least 3 non-digit characters</li>
    <li>...</li>
</ul>
<p>See site-content/*/account/password_strategy.txt for details.</p>

<hr>
<h2 id="HowTo_expiration_date">Add an expiration date on a user account</h2>
<p>As an administrator you can add an expiration date to a user account in several ways:</p>
<ul>
	<li>When creating a new user account, in the field expiration date. If you leave it blank, then no expiration date will be set.</li>
	<li>In the pending user interface, after user registration.</li>
	<li>By using the User Administration module, once you are on the user information page, you can add or modify the expiration date of a user account.</li>
</ul>
<p>Once the date is reached, the account status becomes suspended. If you want to expand the account validity, you have to reactivate the account <b>and</b> change the expiration date.</p>

<hr>
<h2 id="HowTo_change_wiki_language">How to change wiki language for a project</h2>
<p>Once the language of a wiki is set for a project, it is "impossible" to change it. If an admin made a mistake and activated the wiki for his project in the wrong language, it is however possible to change it.</p>
<p>You will need to execute some SQL commands in PhpMyAdmin (for instance):</p>
<ol>
	<li>Search for the group_id of the project you want to re-init the wiki (let's call this group_id 'xxx').</li>
	<li>Execute the following SQL commands:
	 <ul>
	  <li>DELETE FROM wiki_attachment WHERE group_id = xxx</li>
	  <li>DELETE FROM wiki_attachment_log WHERE group_id = xxx</li>
	  <li>DELETE FROM wiki_group_list WHERE group_id = xxx</li>
	  <li>DELETE FROM wiki_log WHERE group_id = xxx</li>
	  <li>DELETE FROM wiki_page WHERE group_id = xxx</li>
	 </ul>
	</li>
	<li>The wiki of the project has been removed. You can now activate it again with the right language.</li>
</ol>

<hr>
<h2 id="HowTo_reset_sessions">How to reset sessions</h2>
<p>If you switch <code>sys_force_ssl</code> from 1 to 0 while users have exisiting sessions
     they may encounter strange behaviors like infinite redirections. 
     You will have to purge sessions in site admin > all users.</p>

<hr width="100%" size="2" noshade="noshade"> End of Document<br>
<br>
</body>
</html>
