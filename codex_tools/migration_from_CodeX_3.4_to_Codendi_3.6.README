Codendi 3.6 Migration README file
=================================

CodeX is now Codendi:  Welcome to Codendi 3.6

This document explains how to upgrade from a CodeX 3.4 server on Red Hat 
Enterprise Linux 4 (RHEL4), to Codendi 3.6 on RHEL5.

Here is a brief summary of the process:
- backup the data of the main server, to another server
- format disks and install RHEL5
- install Codendi 3.6
- copy the backed-up files and DB to the new server
- run the upgrade script migration_from_CodeX_3.4_to_Codendi_3.6.sh ...
et voilà!

RedHat recommends a full re-installation of RHEL5, and not un upgrade from RHEL4
to RHEL5
"While upgrading from Red Hat Enterprise Linux version 4 Update 4 is supported, 
you are more likely to have a consistent experience by backing up your data 
and then installing this release of Red Hat Enterprise Linux 5.0 over your 
previous Red Hat Enterprise Linux installation."
https://www.redhat.com/docs/en-US/Red_Hat_Enterprise_Linux/5.2/html/Installation_Guide/ch23s01.html

For this reason, the upgrade scenario for Codendi 3.6 on RHEL5 also needs a full 
re-installation of the operating system.

Also, please note that we always refer to RHEL5, but clone distributions like 
CentOS5 should work as well.

Now, here are the step-by-step instructions for upgrading:

* If you have custom code running in /usr/share/codex, make a diff patch to keep your
  specific code. 

* Make a backup of your data
  Please use "tar" or a similar command that keeps the owner, group and permis-
  sions of each file.
  Ex:
    > tar cvfz backup_dir/codex.3.4.tgz /etc/codex /home /var/lib/codex  \
               /var/log/codex /var/lib/mailman

* Make a mysql backup of the 'codex' database (use mysqldump).
  Ex:
  > mysqldump -q -u codexadm -p codex >  backup_dir/codex.3.4.sql 
  You do not have to backup project databases, but don't forget to regenerate them
  at the end of the process (through the web interface).
  You may also backup the 'mysql' DB (which contains users, permissions, etc), 
  but you should not restore it on the new server, since it does not
  contain new databases and users needed by Salome (test tool) and Openfire (IM server).

* Make sure all your backup files are copied on another machine!
  If you have other files on the machine, custom scripts, non-CodeX data, etc.,
  don't forget to also make a copy (look e.g. in /root, /usr/local, etc.)
  You may also want to copy specific configuration files (/etc/mail/, 
  /etc/named.conf, /var/named/, /etc/httpd, /etc/my.cnf, /var/spool/cron,  etc.)
  We recommend doing a backup of the whole '/etc' directory in order to
  keep a reference of the previous configuration settings.

* Install RHEL5 on your server, erasing all previous data.
  When partitionning the disk, please choose a large partition for /var/ since 
  it contains all CodeX data (CVS, subversion, documents, files, etc.)

* Install Codendi 3.6
  Run "codex_install.sh" on the Codendi CD, and follow the instructions. 
  Please make sure that you use the same passwords, domain names, IP address, 
  etc. as on the previous installation. Modifying the machine name is not in the
  scope of this document.
  Please Configure Codendi 3.6 properly (/etc/httpd/conf/httpd.conf, 
  /etc/codex/conf/local.inc, etc.), so that the server can be accessed with a 
  web browser.
  ***DON'T*** create new users or projects!

*  You should also properly configure the DNS and emails. Please note that
  bind/named configuration has changed in RHEL5, so you should not reuse your
  existing files. The codex.zone file no longer exists, and we now use a wildcard
  entry (look at codex_full.zone in /var/named/chroot/var/named)
  

* Restore your backed-up data. 

  Note: if you need to move directories and create links (e.g. because /var
  is not large enough), you should do it now, before restoring data.
  (e.g. create link from /var/lib/mysql and /var/lib/codex to a larger disk).
 
  Be carefull to use a mechanism that keeps the context (owner, group, permis-
  sions of files).
  For instance, you can use "tar" or "cp -a" to preserve the context.
  Here is a detailed list of what must be restored:

  * in /etc/codex
    Restore files in /etc/codex/ 
    If you overwrite database.inc, you will have to edit the file if the DB password
    you choose during installation is not the same as on the CodeX 3.4 server.
    You don't need to overwrite cvsgraph.conf and viewvc.conf
    Be careful not to erase the new etc files in /etc/codex/plugins/im and 
    /etc/codex/plugins/salome

  * restore data directories:
    /home/users
    /home/groups
    /var/log/codex
    /var/lib/codex
    /var/lib/mailman
    For these directories, you may want to move away the new directory before
    restoring data.
    E.g. mv /var/lib/mailman /var/lib/mailman.new 
         before restoring /var/lib/mailman

  * You don't need to restore /usr/share/codex but it is time to restore your local
      modifications saved in the patch file (step 1)
        > cd /usr/share/codex; patch -p0 <  mycodex.patch
        ... then fix the potential conflicts!

  * /etc/skel_codex may contain custom environment scripts for user home 
    directories.
    If you have created files in this directory, you can restore them.


 * Restore other scripts or data (e.g. from /usr/local, /usr/lib/codex/bin, /root, 
   /var/spool/cron, /etc/my.cnf,  etc.) if needed.
   Concerning my.cnf, please note that you should not re-add the "skip-innodb" line
   (SalomeTMF needs InnoDB), and you should keep the UTF-8 lines introduced in 3.6.

 * If you had a specific SSL certificate, you should also restore or regenerate it.

 * Last, to recover your subversion setting, you can also restore the 
   .subversion directory:
      /home/codexadm/.subversion 

* Database restore from Codendi 3.4
  You need to recover the previous database:
  * backup the new database (not really needed, but who knows...)
    > mysqldump -q -u codexadm -p codex > /root/codex.3.6.empty.sql
  * Delete the new database, and create an empty one:
    > mysql -u codexadm -p
        > drop database codex;
        > create database codex;
        > exit;
  * Restore the database from CodeX 3.4
    > mysql -u codexadm -p codex < backup_dir/codex.3.4.sql
    This might take some time! (30 min for the 13GB Xerox codex server DB).
  * You may also copy mysql users and privileges that may be specific to 
    your server.

* user/group restore.
  You should now run the xerox_crontab.sh script to create all Unix users/groups.
  Ignore errors about DNS or HTTPD if any.
    > /usr/share/codex/src/utils/xerox_crontab.sh

* Database and UTF-8 migration to Codendi 3.6:
  Now, you should run the migration_from_CodeX_3.4_to_Codendi_3.6.sh 
  script from the Codendi CD.
  This might also take some time! (20 min for Xerox codex server).

* Re-generate project databases if needed (through the web interface).

* If you wish to change the name of your server from "CodeX" to "Codendi", you should
  change $sysname in /etc/codex/conf/local.inc to "Codendi".

* On the opposite, if you wish to keep the old name in the documentation, you should 
  add the SYS_PRODUCT_NAME line in
  /etc/codex/documentation/user_guide/xml/ParametersLocal.dtd
  (see /usr/share/codex/src/etc/ParametersLocal.dtd.dist)

* The new Graphontrackers Plugin is available, and default graphical reports for your 
  site have been created:
  Feel free to customize your own reports for each (template) tracker via the trackers 
  administration menu.

  Gantt charts: to enbale them, you will have to update the task tracker
  template, and any other existing tracker that would like to use a Gantt chart:
  - rename the old 'end date' field into 'close date'.
  - create an 'end date' and a 'due date' field for the task tracker
  - create a 'progress' field, type INT in the task tracker, with value between 
    0 and 100 (percentage of completion) 
  Use these fields when defining the Gantt chart.

* CodeX is now UTF-8. Please check that your iso-8859-1 files have been properly
  converted to utf-8 (site-content, themes, docman embedded files).
  The migration script automatically converts every file if it knows its encoding,
  or displays the file name if it doesn't (mostly HTML files).
  You can use /usr/share/codex/codex_tools/utils/iso-8859-1_to_utf-8.sh to convert files.

* Salomé and Instant Messaging have been installed. If you don't want to use them, 
  please uninstall corresponding plugins through the PluginsAdministration.
  Don't forget to remove also the rpms (openfire, salome)

* Salomé is available for all projects, but active only in the main template (project 100).
  So only new projects created from the default template will instantly be able to
  use Salomé.
  For all other projects and templates, you need to:
  - create a tracker from the "Salome Bugs" template
  - activate the salomé service (in project administration -> service configuration)
  - go in the Salomé administration menu and select the "Salomé Bugs" tracker.
  - in the same page, you should map the existing tracker fields with salomé
    fields (they have the same name).
  - last, select the plugins you want to activate, and launch Salomé!

* You need to synchronize your projects with the OpenFire DB to create chat rooms 
  for Instant Messaging. 
  Please go to admin > Instant Messaging and synchronize groups.

* Please note that project web site CGI scripts are no longer supported for security
  reasons. Please warn your projects if needed.

* If you have custom themes:
  -New icons: add.png, monitor_forum.png, monitor_thread.png, right_arrow.png, left_arrow.png, 
              both_arrows.png, cal.png, delete.png. 
   You may copy them from /usr/share/codex/src/www/themes/CodeXTab/images/ic
  -New image: backstripes.gif. You may copy them from /usr/share/codex/src/www/themes/CodeXTab/images
  -Updated CSS: Everything below the line '/* {{{ Date Picker */' in 
   /usr/share/codex/src/www/themes/CodeXTab/css/style.css should be added to your style.css.
  -Please update your theme layout class according to the modifications done in 
   Layout.class.php and TabbedLayout.class.php
    > https://partners.xrce.xerox.com/svn/viewvc.php/dev/trunk/src/www/include/Layout.class.php?r1=9106&r2=7209&roottype=svn&root=codex&diff_format=l
    > https://partners.xrce.xerox.com/svn/viewvc.php/dev/trunk/src/www/include/TabbedLayout.class.php?r1=9068&r2=7209&roottype=svn&root=codex&diff_format=l

* You may want to regenerate the documentation at this point.
  As "codexadm", run /usr/share/codex/src/utils/generate_doc.sh

Please verify that the DNS is running properly (check e.g. project web sites or
subversion access).
Also verify that emails and mailing lists work as expected.
In case of problem, please refer to either the DNS or Sendmail configuration 
instructions from the Codendi Installation Guide.

You are all set!

Toubleshooting:
--------------
Here are a few tips in case of problems after the migration

Q: Instant messaging does not seem to work: there is no presence icon next to
   user names, and synchronizing projects returns an error.
A: This problem occurs when Codendi was installed using a different server name
   than the target name. During installation, the server name is stored in the 
   OpenFire database, and it needs to be correct. In this case, we recommend 
   'dropping' the 'openfire' DB, and re-executing the IM installation script. 
   See the command "/plugins/IM/include/jabbex_api/installation/install.php" 
   in codex-install for the command-line to use.

Q: I can't use CVS after the migration: the CVS client complains about a lock
   that can't be written
A: You need to execute the Codendi cron job (/usr/share/codex/src/util/xerox_crontab.sh)
   to regenerate the locks in /var/lock/cvs

Q: Codendi cron job (/usr/share/codex/src/util/xerox_crontab.sh) compalins about duplicate
   entries 'admin' and 'imadmin-bot'.
A: If you installed an empty Codendi 3.6 instance, it automatically created the
   'admin' and 'imadmin-bot' users. Once you recover your existing database and do
   the migration, both users are also created in the new DB, but probably with
   different IDs, so that the system think they are two new users.
   If you encounter this issue, you should edit /etc/passwd and /etc/shadow (e.g. 
   with 'vipw') and remove the *first* occurence of each duplicate user in both
   files. Then, you may re-run the cron job.

Q: The User/Admin/Install guide is no longer accessible
A: First, check that the documentation was properly generated (i.e. file
   /usr/share/codex/documentation/user_guide/pdf/en_US/Codendi_User_Guide.pdf
   should exist). Otherwise, run "generate_doc.sh" as codexadm.
   Then, please note that these guides were renamed from "CodeX" to "Codendi",
   so please update your links accordingly.

Enjoy Codendi 3.6!


-- The Xerox Codendi team

Questions? -> codex-devel@partners.xrce.xerox.com
Problems?  -> https://partners.xrce.xerox.com/tracker/?group_id=120&atid=199



[root@atlas2 big]# cat backup.sql.gz | gunzip - | mysql -u codexadm -pg7loi9re codex
-> 30 min
/usr/share/codex/codex_tools/migration_from_CodeX_3.4_to_CodeX_3.6.sh
->15 min
